import React, { useState, useEffect, useCallback } from 'react';
import { useNavigate, useSearchParams, useLocation } from 'react-router-dom';
import { Button } from './ui/button';
import { Input } from './ui/input';
import { Label } from './ui/label';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from './ui/dialog';
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from './ui/dropdown-menu';
import { AlertDialog, AlertDialogContent, AlertDialogHeader, AlertDialogTitle, AlertDialogDescription, AlertDialogFooter, AlertDialogCancel, AlertDialogAction } from './ui/alert-dialog';
import { Popover, PopoverContent, PopoverTrigger } from './ui/popover';
import { ArrowLeft, LogOut, User as UserIcon, Plus, Calendar, Search, Edit, MoreVertical, Trash2, AlertCircle, Clock, RefreshCw, CheckCircle, RotateCcw, Menu, X, Printer, ChevronDown } from 'lucide-react';
import { mockLines, mockCustomers, mockDays } from '../mock';
import { useTheme } from '../App';
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';

const EntryDetails = () => {
  const { theme } = useTheme();
  const navigate = useNavigate();
  const location = useLocation();
  const [searchParams, setSearchParams] = useSearchParams();
  const lineId = searchParams.get('id');
  
  const [line, setLine] = useState(null);
  const [days, setDays] = useState([]);
  const [selectedDay, setSelectedDay] = useState(null);
  const [customers, setCustomers] = useState([]);
  const [filteredCustomers, setFilteredCustomers] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [bfAmount, setBfAmount] = useState(0);
  
  const [isAddDayModalOpen, setIsAddDayModalOpen] = useState(false);
  const [isQuickTransactionOpen, setIsQuickTransactionOpen] = useState(false);
  const [transactionList, setTransactionList] = useState([]);
  const [isCustomerModalOpen, setIsCustomerModalOpen] = useState(false);
  const [newDay, setNewDay] = useState('');
  const [editingCustomer, setEditingCustomer] = useState(null);
  const [isDeleteDayModalOpen, setIsDeleteDayModalOpen] = useState(false);
  const [dayToDelete, setDayToDelete] = useState(null);
  const [deleteConfirmText, setDeleteConfirmText] = useState('');
  const [customerToDelete, setCustomerToDelete] = useState(null);
  const [isDeleteCustomerModalOpen, setIsDeleteCustomerModalOpen] = useState(false);
  const [deleteCustomerError, setDeleteCustomerError] = useState('');
  const [isErrorAlertOpen, setIsErrorAlertOpen] = useState(false);
  const [deletedCustomers, setDeletedCustomers] = useState([]);
  const [pendingCustomers, setPendingCustomers] = useState([]);
  const [allPendingCustomers, setAllPendingCustomers] = useState([]);
  const [allDeletedCustomers, setAllDeletedCustomers] = useState([]);
  const [activeView, setActiveView] = useState('customers'); // 'customers', 'pending', 'deleted'
  const [viewSelectedDay, setViewSelectedDay] = useState(null); // For pending/deleted view day selection
  const [isSidebarOpen, setIsSidebarOpen] = useState(true); // Sidebar toggle state
  
  const [isSuccessModalOpen, setIsSuccessModalOpen] = useState(false);
  const [successMessage, setSuccessMessage] = useState('');
  
  const [isRenewalModalOpen, setIsRenewalModalOpen] = useState(false);
  const [renewalCustomer, setRenewalCustomer] = useState(null);
  const [renewalForm, setRenewalForm] = useState({
    takenAmount: '',
    interest: '',
    pc: '',
    date: new Date().toISOString().split('T')[0],
    weeks: '12'
  });
  
  const [isRestoreModalOpen, setIsRestoreModalOpen] = useState(false);
  const [customerToRestore, setCustomerToRestore] = useState(null);
  const [restoreForm, setRestoreForm] = useState({
    newId: '',
    takenAmount: '',
    interest: '',
    pc: '',
    date: new Date().toISOString().split('T')[0],
    weeks: '12'
  });
  
  const [customerForm, setCustomerForm] = useState({
    id: '',
    name: '',
    village: '',
    phone: '',
    takenAmount: '',
    interest: '',
    pc: '',
    date: '',
    weeks: '12',
    profileImage: null
  });
  
  const [quickTransaction, setQuickTransaction] = useState({
    customerId: '',
    amount: '',
    date: new Date().toISOString().split('T')[0]
  });
  const [universalDate, setUniversalDate] = useState(new Date().toISOString().split('T')[0]);
  
  // Print modal states
  const [isPrintModalOpen, setIsPrintModalOpen] = useState(false);
  const [printType, setPrintType] = useState('transactions'); // 'transactions' or 'summary'
  const [printCustomerId, setPrintCustomerId] = useState('');
  const [printCustomerName, setPrintCustomerName] = useState('');
  const [selectedDaysForPrint, setSelectedDaysForPrint] = useState([]);
  const [selectAllDays, setSelectAllDays] = useState(true);

  useEffect(() => {
    // Load line
    const stored = localStorage.getItem('entries');
    const lines = stored ? JSON.parse(stored) : mockLines;
    const foundLine = lines.find(l => l.id === lineId);
    setLine(foundLine);

    // Load days - only use mockDays for line id='1'
    const storedDays = localStorage.getItem(`days_${lineId}`);
    let loadedDays;
    if (storedDays) {
      loadedDays = JSON.parse(storedDays);
    } else if (lineId === '1') {
      loadedDays = mockDays;
    } else {
      loadedDays = [];
    }
    setDays(loadedDays);

    // Load selected day - Check URL first, then localStorage, then default to first day
    const dayFromUrl = searchParams.get('day');
    const viewFromUrl = searchParams.get('view');
    const viewDayFromUrl = searchParams.get('viewDay');
    
    // Set activeView if present in URL
    if (viewFromUrl && ['customers', 'pending', 'deleted'].includes(viewFromUrl)) {
      setActiveView(viewFromUrl);
    }
    
    // Set viewSelectedDay if present in URL (for pending/deleted views)
    if (viewDayFromUrl) {
      setViewSelectedDay(viewDayFromUrl);
    }
    
    // Set selectedDay
    if (dayFromUrl && loadedDays.includes(dayFromUrl)) {
      setSelectedDay(dayFromUrl);
    } else {
      const savedSelectedDay = localStorage.getItem(`selectedDay_${lineId}`);
      if (savedSelectedDay && loadedDays.includes(savedSelectedDay)) {
        setSelectedDay(savedSelectedDay);
      } else if (loadedDays.length > 0) {
        setSelectedDay(loadedDays[0]);
      }
    }

    // Initialize mock transactions ONLY for line id='1' (only once)
    // REMOVED: Mock transactions initialization to prevent data inconsistency
    // Users should start with clean slate or actual data

    // Load BF amount - will be recalculated by loadCustomersAndCalculate
    const bfKey = `bf_${lineId}`;
    const storedBf = localStorage.getItem(bfKey);
    setBfAmount(storedBf ? parseFloat(storedBf) : foundLine?.amount || 0);
  }, [lineId, searchParams]);

  // Helper function to recalculate BF from scratch
  const recalculateBF = useCallback(() => {
    // Get line's initial amount
    const stored = localStorage.getItem('entries');
    const lines = stored ? JSON.parse(stored) : [];
    const currentLine = lines.find(l => l.id === lineId);
    const initialAmount = currentLine?.amount || 0;

    // Calculate total given to ALL customers across ALL days
    let totalGiven = 0;
    const allKeys = Object.keys(localStorage);
    
    allKeys.forEach(key => {
      if (key.startsWith(`customers_${lineId}_`)) {
        try {
          const storedCustomers = localStorage.getItem(key);
          if (storedCustomers) {
            const customersList = JSON.parse(storedCustomers);
            if (Array.isArray(customersList)) {
              customersList.forEach(customer => {
                totalGiven += parseFloat(customer.takenAmount) || 0;
              });
            }
          }
        } catch (e) {
          console.error('Error parsing customers:', e);
        }
      }
    });

    // Calculate total collected from customer transactions ONLY (not account transactions)
    let totalCollected = 0;
    allKeys.forEach(key => {
      // Only count customer transactions (pattern: transactions_lineId_day_customerId)
      // Skip account transactions (pattern: transactions_lineId_accountId) by checking for date pattern
      const transPattern = new RegExp(`^transactions_${lineId}_\\d{4}-\\d{2}-\\d{2}_`);
      const chatPattern = new RegExp(`^chat_${lineId}_`);
      
      if (transPattern.test(key) || chatPattern.test(key)) {
        try {
          const storedTrans = localStorage.getItem(key);
          if (storedTrans) {
            const transactionsList = JSON.parse(storedTrans);
            if (Array.isArray(transactionsList)) {
              transactionsList.forEach(trans => {
                totalCollected += parseFloat(trans.amount) || 0;
              });
            }
          }
        } catch (e) {
          console.error('Error parsing transactions:', e);
        }
      }
    });

    // Calculate total renewals (renewals deduct from BF)
    let totalRenewals = 0;
    allKeys.forEach(key => {
      if (key.startsWith(`renewals_${lineId}_`)) {
        try {
          const storedRenewals = localStorage.getItem(key);
          if (storedRenewals) {
            const renewalsList = JSON.parse(storedRenewals);
            if (Array.isArray(renewalsList)) {
              renewalsList.forEach(renewal => {
                totalRenewals += parseFloat(renewal.takenAmount) || 0;
              });
            }
          }
        } catch (e) {
          console.error('Error parsing renewals:', e);
        }
      }
    });

    // Calculate net from Account page transactions (credit - debit)
    let accountNet = 0;
    const accountsKey = `accounts_${lineId}`;
    const storedAccounts = localStorage.getItem(accountsKey);
    if (storedAccounts) {
      try {
        const accounts = JSON.parse(storedAccounts);
        if (Array.isArray(accounts)) {
          accounts.forEach(account => {
            const accountTransKey = `transactions_${lineId}_${account.id}`;
            const accountTrans = localStorage.getItem(accountTransKey);
            if (accountTrans) {
              const transList = JSON.parse(accountTrans);
              if (Array.isArray(transList)) {
                transList.forEach(trans => {
                  // Account transactions have creditAmount and debitAmount
                  accountNet += (parseFloat(trans.creditAmount) || 0) - (parseFloat(trans.debitAmount) || 0);
                });
              }
            }
          });
        }
      } catch (e) {
        console.error('Error parsing account transactions:', e);
      }
    }

    // BF = Initial Amount - Total Given + Total Collected - Total Renewals + Account Net
    const newBfAmount = initialAmount - totalGiven + totalCollected - totalRenewals + accountNet;
    
    // Update state and localStorage
    setBfAmount(newBfAmount);
    const bfKey = `bf_${lineId}`;
    localStorage.setItem(bfKey, newBfAmount.toString());

    return newBfAmount;
  }, [lineId]);

  const calculatePendingCustomers = useCallback(() => {
    if (!lineId) return;
    
    const allPending = [];
    const today = new Date();
    const allKeys = Object.keys(localStorage);
    
    // Check customers for ALL days
    allKeys.forEach(key => {
      if (key.startsWith(`customers_${lineId}_`)) {
        try {
          const dayName = key.replace(`customers_${lineId}_`, '');
          const storedCustomers = localStorage.getItem(key);
          if (storedCustomers) {
            const customersList = JSON.parse(storedCustomers);
            if (Array.isArray(customersList)) {
              customersList.forEach(customer => {
                // Calculate if customer is pending
                const takenDate = new Date(customer.date);
                const weeksInMs = (customer.weeks || 10) * 7 * 24 * 60 * 60 * 1000;
                const dueDate = new Date(takenDate.getTime() + weeksInMs);
                
                // Get transactions for this customer
                const transKey = `transactions_${lineId}_${dayName}_${customer.id}`;
                const chatKey = `chat_${lineId}_${dayName}_${customer.id}`;
                const renewalKey = `renewals_${lineId}_${dayName}_${customer.id}`;
                
                const storedTrans = localStorage.getItem(transKey);
                const storedChat = localStorage.getItem(chatKey);
                const storedRenewals = localStorage.getItem(renewalKey);
                
                const transactions = storedTrans ? JSON.parse(storedTrans) : [];
                const chatMessages = storedChat ? JSON.parse(storedChat) : [];
                const renewals = storedRenewals ? JSON.parse(storedRenewals) : [];
                
                const totalPaid = [...transactions, ...chatMessages].reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                
                // Calculate total amount owed (initial amount + all renewals) - FIXED to match CustomerChat
                const takenAmount = parseFloat(customer.takenAmount) || 0;
                const totalRenewalAmount = renewals.reduce((sum, renewal) => sum + (parseFloat(renewal.takenAmount) || 0), 0);
                const totalOwed = takenAmount + totalRenewalAmount;
                const remainingAmount = totalOwed - totalPaid;
                
                // If due date passed and remaining amount > 0, it's pending
                if (today > dueDate && remainingAmount > 0) {
                  const daysOverdue = Math.floor((today - dueDate) / (24 * 60 * 60 * 1000));
                  allPending.push({
                    ...customer,
                    dayName,
                    remainingAmount,
                    daysOverdue,
                    dueDate: dueDate.toISOString().split('T')[0]
                  });
                }
              });
            }
          }
        } catch (e) {
          console.error('Error calculating pending customers:', e);
        }
      }
    });
    
    setAllPendingCustomers(allPending);
  }, [lineId]);

  const loadCustomersAndCalculate = useCallback(() => {
    if (!selectedDay || !lineId) return;
    
    // Load customers for selected day
    const storedCustomers = localStorage.getItem(`customers_${lineId}_${selectedDay}`);
    let loadedCustomers;
    
    // Only use mock customers for line id='1' AND ONLY for the first mock day (2025-01-15)
    if (storedCustomers) {
      loadedCustomers = JSON.parse(storedCustomers);
    } else if (lineId === '1' && selectedDay === '2025-01-15') {
      // Only load mock data for the specific first day
      loadedCustomers = mockCustomers;
      // Save it so it doesn't reload every time
      localStorage.setItem(`customers_${lineId}_${selectedDay}`, JSON.stringify(mockCustomers));
    } else {
      loadedCustomers = [];
    }
    
    setCustomers(loadedCustomers);
    setFilteredCustomers(loadedCustomers);
    
    // Load ALL deleted customers for this line
    const deletedKey = `deleted_customers_${lineId}`;
    const storedDeleted = localStorage.getItem(deletedKey);
    const allDeleted = storedDeleted ? JSON.parse(storedDeleted) : [];
    setAllDeletedCustomers(allDeleted);
    
    // Calculate pending customers
    calculatePendingCustomers();
    
    // Load BF from localStorage (don't recalculate on every load to preserve Account page changes)
    const bfKey = `bf_${lineId}`;
    const storedBf = localStorage.getItem(bfKey);
    if (storedBf) {
      setBfAmount(parseFloat(storedBf));
    }
  }, [selectedDay, lineId, calculatePendingCustomers]);

  useEffect(() => {
    if (selectedDay) {
      loadCustomersAndCalculate();
    }
  }, [selectedDay, lineId, location.key, loadCustomersAndCalculate]); // Re-run when location changes (navigation)

  // Add window focus listener to refresh data when user navigates back
  useEffect(() => {
    const handleFocus = () => {
      if (selectedDay) {
        loadCustomersAndCalculate();
      }
    };

    // Also listen for custom storage events in case of updates from other tabs
    const handleStorageChange = (e) => {
      if (e.key && (e.key.includes('transactions_') || e.key.includes('chat_') || e.key.includes('customers_') || e.key.includes('bf_'))) {
        if (selectedDay) {
          loadCustomersAndCalculate();
        }
        // Also refresh BF if it changed directly
        if (e.key && e.key.includes('bf_')) {
          const storedBf = localStorage.getItem(e.key);
          if (storedBf) {
            setBfAmount(parseFloat(storedBf));
          }
        }
      }
    };

    window.addEventListener('focus', handleFocus);
    window.addEventListener('storage', handleStorageChange);
    
    return () => {
      window.removeEventListener('focus', handleFocus);
      window.removeEventListener('storage', handleStorageChange);
    };
  }, [selectedDay, lineId, loadCustomersAndCalculate]);

  useEffect(() => {
    // Filter customers based on search
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      const filtered = customers.filter(c =>
        c.name.toLowerCase().includes(query) ||
        c.id.toLowerCase().includes(query) ||
        c.phone.includes(query)
      );
      setFilteredCustomers(filtered);
    } else {
      setFilteredCustomers(customers);
    }
  }, [searchQuery, customers]);

  const handleAddDay = () => {
    if (!newDay.trim()) return;
    const updatedDays = [...days, newDay.trim()];
    setDays(updatedDays);
    localStorage.setItem(`days_${lineId}`, JSON.stringify(updatedDays));
    setSelectedDay(newDay.trim());
    setNewDay('');
    setIsAddDayModalOpen(false);
  };

  const handleDeleteDay = (dayToDelete, e) => {
    e.stopPropagation();
    setDayToDelete(dayToDelete);
    setDeleteConfirmText('');
    setIsDeleteDayModalOpen(true);
  };

  const confirmDeleteDay = () => {
    if (deleteConfirmText.toLowerCase() !== 'delete') {
      alert('Please type "delete" to confirm');
      return;
    }
    
    // Remove day from list
    const updatedDays = days.filter(d => d !== dayToDelete);
    setDays(updatedDays);
    localStorage.setItem(`days_${lineId}`, JSON.stringify(updatedDays));
    
    // Remove customers for this day
    localStorage.removeItem(`customers_${lineId}_${dayToDelete}`);
    
    // Remove all transactions for this day
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith(`transactions_${lineId}_${dayToDelete}_`)) {
        localStorage.removeItem(key);
      }
    }
    
    // If deleted day was selected, select another day
    if (selectedDay === dayToDelete) {
      setSelectedDay(updatedDays.length > 0 ? updatedDays[0] : null);
      if (updatedDays.length > 0) {
        localStorage.setItem(`selectedDay_${lineId}`, updatedDays[0]);
      } else {
        localStorage.removeItem(`selectedDay_${lineId}`);
      }
    }
    
    setIsDeleteDayModalOpen(false);
    setDayToDelete(null);
    setDeleteConfirmText('');
  };

  const handleAddToTransactionList = () => {
    if (!quickTransaction.customerId || !quickTransaction.amount) {
      alert('Please enter Customer ID and Amount');
      return;
    }

    const customer = customers.find(c => c.id === quickTransaction.customerId);
    if (!customer) {
      alert('Customer not found');
      return;
    }

    const newTransaction = {
      tempId: Date.now().toString(),
      customerId: quickTransaction.customerId,
      customerName: customer.name,
      amount: parseFloat(quickTransaction.amount),
      date: universalDate
    };

    setTransactionList([...transactionList, newTransaction]);
    setQuickTransaction({ ...quickTransaction, customerId: '', amount: '' });
  };

  const handleDeleteTransaction = (tempId) => {
    setTransactionList(transactionList.filter(t => t.tempId !== tempId));
  };

  const handleSaveTransactions = () => {
    if (transactionList.length === 0) {
      alert('No transactions to save');
      return;
    }

    let totalCollectedAmount = 0;

    transactionList.forEach(trans => {
      const key = `transactions_${lineId}_${selectedDay}_${trans.customerId}`;
      const stored = localStorage.getItem(key);
      const transactions = stored ? JSON.parse(stored) : [];
      transactions.push({
        id: Date.now().toString() + Math.random(),
        amount: trans.amount,
        date: trans.date,
        comment: '',
        customerName: trans.customerName // Store customer name with transaction
      });
      localStorage.setItem(key, JSON.stringify(transactions));
      totalCollectedAmount += trans.amount;
    });

    // Recalculate BF from scratch
    const newBfAmount = recalculateBF();

    setSuccessMessage(`All transactions saved successfully! Collected: ₹${totalCollectedAmount.toFixed(2)}. New BF: ₹${newBfAmount.toFixed(2)}`);
    setIsSuccessModalOpen(true);
    setTransactionList([]);
    setIsQuickTransactionOpen(false);
  };

  const handleResetTransactions = () => {
    setTransactionList([]);
    setQuickTransaction({ customerId: '', amount: '', date: new Date().toISOString().split('T')[0] });
    setUniversalDate(new Date().toISOString().split('T')[0]);
  };

  const handleSelectDay = (day) => {
    setSelectedDay(day);
    localStorage.setItem(`selectedDay_${lineId}`, day);
    // Automatically switch back to active customers view when a day is selected
    setActiveView('customers');
    setViewSelectedDay(null);
    // Update URL
    setSearchParams({ id: lineId, day: day, view: 'customers' });
  };

  const handleOpenCustomerModal = (customer = null) => {
    if (customer) {
      setEditingCustomer(customer);
      setCustomerForm(customer);
    } else {
      setEditingCustomer(null);
      
      // Auto-generate next customer ID
      let nextId = '1';
      if (customers.length > 0) {
        // Find the highest numeric ID and increment
        const numericIds = customers
          .map(c => parseInt(c.id))
          .filter(id => !isNaN(id))
          .sort((a, b) => b - a);
        
        if (numericIds.length > 0) {
          nextId = (numericIds[0] + 1).toString();
        }
      }
      
      setCustomerForm({
        id: nextId,
        name: '',
        village: '',
        phone: '',
        takenAmount: '',
        interest: '',
        pc: '',
        date: new Date().toISOString().split('T')[0],
        weeks: '12',
        profileImage: null
      });
    }
    setIsCustomerModalOpen(true);
  };

  const handleSaveCustomer = () => {
    if (!customerForm.name || !customerForm.takenAmount || !customerForm.id) {
      alert('Please fill required fields: Name, ID, Amount');
      return;
    }

    let updatedCustomers;

    if (editingCustomer) {
      // Editing existing customer
      updatedCustomers = customers.map(c => c.id === editingCustomer.id ? customerForm : c);
    } else {
      // Adding new customer
      // Check duplicate ID
      if (customers.some(c => c.id === customerForm.id)) {
        alert('Customer ID already exists');
        return;
      }
      updatedCustomers = [...customers, customerForm];
    }

    // Save updated customers for this day
    setCustomers(updatedCustomers);
    localStorage.setItem(`customers_${lineId}_${selectedDay}`, JSON.stringify(updatedCustomers));

    // Recalculate BF from scratch based on ALL customers and collections
    const newBfAmount = recalculateBF();
    
    setIsCustomerModalOpen(false);
    
    if (!editingCustomer) {
      setSuccessMessage(`Customer added! ₹${customerForm.takenAmount} deducted from BF. New BF: ₹${newBfAmount.toFixed(2)}`);
    } else {
      setSuccessMessage(`Customer updated! BF recalculated: ₹${newBfAmount.toFixed(2)}`);
    }
    setIsSuccessModalOpen(true);
  };

  const handleDeleteCustomer = (customer, e) => {
    e.stopPropagation();
    
    // Check if customer has remaining amount
    const transKey = `transactions_${lineId}_${selectedDay}_${customer.id}`;
    const chatKey = `chat_${lineId}_${selectedDay}_${customer.id}`;
    const renewalKey = `renewals_${lineId}_${selectedDay}_${customer.id}`;
    
    const storedTrans = localStorage.getItem(transKey);
    const storedChat = localStorage.getItem(chatKey);
    const storedRenewals = localStorage.getItem(renewalKey);
    
    const transactions = storedTrans ? JSON.parse(storedTrans) : [];
    const chatMessages = storedChat ? JSON.parse(storedChat) : [];
    const renewals = storedRenewals ? JSON.parse(storedRenewals) : [];
    
    const totalPaid = [...transactions, ...chatMessages].reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
    
    // Calculate total amount owed (initial amount + all renewals) - FIXED to match CustomerChat
    const takenAmount = parseFloat(customer.takenAmount) || 0;
    const totalRenewalAmount = renewals.reduce((sum, renewal) => sum + (parseFloat(renewal.takenAmount) || 0), 0);
    const totalOwed = takenAmount + totalRenewalAmount;
    const remainingAmount = totalOwed - totalPaid;
    
    if (remainingAmount > 0) {
      setDeleteCustomerError(`Unable to delete due to pending amount: ₹${remainingAmount.toFixed(2)}`);
      setIsErrorAlertOpen(true);
      return;
    }
    
    setCustomerToDelete(customer);
    setDeleteConfirmText('');
    setIsDeleteCustomerModalOpen(true);
  };

  const confirmDeleteCustomer = () => {
    if (deleteConfirmText.toLowerCase() !== 'delete') {
      alert('Please type "delete" to confirm');
      return;
    }
    
    // Get remaining amount for tracking
    const transKey = `transactions_${lineId}_${selectedDay}_${customerToDelete.id}`;
    const chatKey = `chat_${lineId}_${selectedDay}_${customerToDelete.id}`;
    const renewalKey = `renewals_${lineId}_${selectedDay}_${customerToDelete.id}`;
    
    const storedTrans = localStorage.getItem(transKey);
    const storedChat = localStorage.getItem(chatKey);
    const storedRenewals = localStorage.getItem(renewalKey);
    
    const transactions = storedTrans ? JSON.parse(storedTrans) : [];
    const chatMessages = storedChat ? JSON.parse(storedChat) : [];
    const renewals = storedRenewals ? JSON.parse(storedRenewals) : [];
    
    const totalPaid = [...transactions, ...chatMessages].reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
    
    // Calculate total amount owed (initial amount + all renewals) - FIXED to match CustomerChat
    const takenAmount = parseFloat(customerToDelete.takenAmount) || 0;
    const totalRenewalAmount = renewals.reduce((sum, renewal) => sum + (parseFloat(renewal.takenAmount) || 0), 0);
    const totalOwed = takenAmount + totalRenewalAmount;
    const remainingAmount = totalOwed - totalPaid;
    
    // Create unique deletion timestamp for archiving
    const deletionTimestamp = Date.now();
    
    // Archive transactions to deleted-specific keys to prevent ID reuse conflicts
    const archivedTransKey = `transactions_deleted_${lineId}_${selectedDay}_${customerToDelete.id}_${deletionTimestamp}`;
    const archivedChatKey = `chat_deleted_${lineId}_${selectedDay}_${customerToDelete.id}_${deletionTimestamp}`;
    const archivedRenewalKey = `renewals_deleted_${lineId}_${selectedDay}_${customerToDelete.id}_${deletionTimestamp}`;
    
    // Move transactions to archived keys
    if (storedTrans) {
      localStorage.setItem(archivedTransKey, storedTrans);
      localStorage.removeItem(transKey);
      console.log(`Archived transactions from ${transKey} to ${archivedTransKey}`);
    }
    if (storedChat) {
      localStorage.setItem(archivedChatKey, storedChat);
      localStorage.removeItem(chatKey);
      console.log(`Archived chat from ${chatKey} to ${archivedChatKey}`);
    }
    if (storedRenewals) {
      localStorage.setItem(archivedRenewalKey, storedRenewals);
      localStorage.removeItem(renewalKey);
      console.log(`Archived renewals from ${renewalKey} to ${archivedRenewalKey}`);
    }
    
    // Double-check removal (safety measure)
    localStorage.removeItem(transKey);
    localStorage.removeItem(chatKey);
    localStorage.removeItem(renewalKey);
    
    console.log(`Deletion complete - Keys removed for customer ${customerToDelete.id}`);
    
    // Save to deleted customers list with archive reference
    const deletedKey = `deleted_customers_${lineId}`;
    const storedDeleted = localStorage.getItem(deletedKey);
    const deletedList = storedDeleted ? JSON.parse(storedDeleted) : [];
    
    deletedList.push({
      ...customerToDelete,
      deletedDate: new Date().toISOString().split('T')[0],
      deletedFrom: selectedDay,
      remainingAtDeletion: remainingAmount,
      deletionTimestamp: deletionTimestamp // Store timestamp to find archived transactions
    });
    
    localStorage.setItem(deletedKey, JSON.stringify(deletedList));
    setDeletedCustomers(deletedList);
    setAllDeletedCustomers(deletedList); // Update allDeletedCustomers to reflect in deleted tab immediately
    
    // Remove customer from list
    const updatedCustomers = customers.filter(c => c.id !== customerToDelete.id);
    setCustomers(updatedCustomers);
    localStorage.setItem(`customers_${lineId}_${selectedDay}`, JSON.stringify(updatedCustomers));
    
    // DO NOT recalculate BF on delete - customer already settled their account
    // BF was already affected when they took money and when they paid it back
    
    // Show success modal
    setSuccessMessage(`Customer deleted successfully! Transaction history preserved.`);
    setIsSuccessModalOpen(true);
    
    setIsDeleteCustomerModalOpen(false);
    setCustomerToDelete(null);
    setDeleteConfirmText('');
  };

  const handleQuickTransaction = () => {
    if (!quickTransaction.customerId || !quickTransaction.amount) {
      alert('Please enter Customer ID and Amount');
      return;
    }

    const customer = customers.find(c => c.id === quickTransaction.customerId);
    if (!customer) {
      alert('Customer not found');
      return;
    }

    // Save transaction
    const key = `transactions_${lineId}_${selectedDay}_${quickTransaction.customerId}`;
    const stored = localStorage.getItem(key);
    const transactions = stored ? JSON.parse(stored) : [];
    transactions.push({
      id: Date.now().toString(),
      amount: parseFloat(quickTransaction.amount),
      date: quickTransaction.date,
      comment: ''
    });
    localStorage.setItem(key, JSON.stringify(transactions));

    setQuickTransaction({ ...quickTransaction, customerId: '', amount: '' });
    alert('Transaction saved!');
  };

  const handleProfileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        setCustomerForm({ ...customerForm, profileImage: event.target.result });
      };
      reader.readAsDataURL(file);
    }
  };

  const handleOpenRenewalModal = (customer, e) => {
    e.stopPropagation();
    
    // Check if customer has cleared their balance
    const transKey = `transactions_${lineId}_${selectedDay}_${customer.id}`;
    const chatKey = `chat_${lineId}_${selectedDay}_${customer.id}`;
    const renewalKey = `renewals_${lineId}_${selectedDay}_${customer.id}`;
    
    const storedTrans = localStorage.getItem(transKey);
    const storedChat = localStorage.getItem(chatKey);
    const storedRenewals = localStorage.getItem(renewalKey);
    
    const transactions = storedTrans ? JSON.parse(storedTrans) : [];
    const chatMessages = storedChat ? JSON.parse(storedChat) : [];
    const renewals = storedRenewals ? JSON.parse(storedRenewals) : [];
    
    const totalPaid = [...transactions, ...chatMessages].reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
    
    // Calculate total amount owed (initial amount + all renewals) - FIXED to match CustomerChat
    const takenAmount = parseFloat(customer.takenAmount) || 0;
    const totalRenewalAmount = renewals.reduce((sum, renewal) => sum + (parseFloat(renewal.takenAmount) || 0), 0);
    const totalOwed = takenAmount + totalRenewalAmount;
    const remainingAmount = totalOwed - totalPaid;
    
    // Only allow renewal if remaining balance is 0
    if (remainingAmount > 0) {
      alert(`Customer is not eligible for renewal. Remaining balance: ₹${remainingAmount.toFixed(2)}. Please clear the balance first.`);
      return;
    }
    
    setRenewalCustomer(customer);
    setRenewalForm({
      takenAmount: '',
      interest: customer.interest || '',
      pc: customer.pc || '',
      date: new Date().toISOString().split('T')[0],
      weeks: '12'
    });
    setIsRenewalModalOpen(true);
  };

  const handleSaveRenewal = () => {
    if (!renewalForm.takenAmount) {
      alert('Please enter taken amount');
      return;
    }

    const renewalAmount = parseFloat(renewalForm.takenAmount);
    
    // Save renewal data to localStorage
    const renewalKey = `renewals_${lineId}_${selectedDay}_${renewalCustomer.id}`;
    const storedRenewals = localStorage.getItem(renewalKey);
    const renewals = storedRenewals ? JSON.parse(storedRenewals) : [];
    
    const newRenewal = {
      id: Date.now().toString(),
      takenAmount: renewalAmount,
      interest: renewalForm.interest,
      pc: renewalForm.pc,
      date: renewalForm.date,
      weeks: renewalForm.weeks,
      renewalDate: new Date().toISOString(),
      customerName: renewalCustomer.name // Store customer name with renewal
    };
    
    renewals.push(newRenewal);
    localStorage.setItem(renewalKey, JSON.stringify(renewals));

    // Update customer's interest and PC values with the latest renewal values
    const storedCustomers = localStorage.getItem(`customers_${lineId}_${selectedDay}`);
    if (storedCustomers) {
      const customersList = JSON.parse(storedCustomers);
      const updatedCustomers = customersList.map(c => {
        if (c.id === renewalCustomer.id) {
          return {
            ...c,
            interest: renewalForm.interest,
            pc: renewalForm.pc
          };
        }
        return c;
      });
      localStorage.setItem(`customers_${lineId}_${selectedDay}`, JSON.stringify(updatedCustomers));
    }

    // Recalculate BF (renewal amount is deducted from BF)
    const newBfAmount = recalculateBF();

    setSuccessMessage(`Renewal saved! ₹${renewalAmount.toFixed(2)} deducted from BF. New BF: ₹${newBfAmount.toFixed(2)}`);
    setIsSuccessModalOpen(true);
    
    setIsRenewalModalOpen(false);
    setRenewalCustomer(null);
    setRenewalForm({
      takenAmount: '',
      interest: '',
      pc: '',
      date: new Date().toISOString().split('T')[0],
      weeks: '12'
    });
    
    // Reload customers to show updated data
    loadCustomersAndCalculate();
  };

  const handleOpenRestoreModal = (customer, e) => {
    e.stopPropagation();
    
    // Auto-generate next available customer ID
    const storedCustomers = localStorage.getItem(`customers_${lineId}_${customer.deletedFrom}`);
    const customers = storedCustomers ? JSON.parse(storedCustomers) : [];
    
    let nextId = '1';
    if (customers.length > 0) {
      const numericIds = customers
        .map(c => parseInt(c.id))
        .filter(id => !isNaN(id))
        .sort((a, b) => b - a);
      
      if (numericIds.length > 0) {
        nextId = (numericIds[0] + 1).toString();
      }
    }
    
    setCustomerToRestore(customer);
    setRestoreForm({
      newId: nextId,
      takenAmount: '',
      interest: customer.interest || '',
      pc: customer.pc || '',
      date: new Date().toISOString().split('T')[0],
      weeks: '12'
    });
    setIsRestoreModalOpen(true);
  };

  const handleRestoreCustomer = () => {
    if (!restoreForm.newId || !restoreForm.takenAmount) {
      alert('Please enter new ID and taken amount');
      return;
    }

    // Check if new ID already exists
    const storedCustomers = localStorage.getItem(`customers_${lineId}_${customerToRestore.deletedFrom}`);
    const customers = storedCustomers ? JSON.parse(storedCustomers) : [];
    
    if (customers.some(c => c.id === restoreForm.newId)) {
      alert('This ID already exists. Please choose a different ID.');
      return;
    }

    // Create restored customer with new ID and renewal details
    const restoredCustomer = {
      ...customerToRestore,
      id: restoreForm.newId,
      takenAmount: restoreForm.takenAmount,
      interest: restoreForm.interest,
      pc: restoreForm.pc,
      date: restoreForm.date,
      weeks: restoreForm.weeks
    };

    // Add to active customers
    const updatedCustomers = [...customers, restoredCustomer];
    localStorage.setItem(`customers_${lineId}_${customerToRestore.deletedFrom}`, JSON.stringify(updatedCustomers));

    // DO NOT REMOVE from deleted customers - keep archived transaction history accessible
    // Instead, mark the deleted customer as "restored" so we know they were restored
    const deletedKey = `deleted_customers_${lineId}`;
    const storedDeleted = localStorage.getItem(deletedKey);
    const deletedList = storedDeleted ? JSON.parse(storedDeleted) : [];
    const updatedDeletedList = deletedList.map(c => {
      // Find the matching deleted customer and mark as restored
      if (c.id === customerToRestore.id && c.deletedFrom === customerToRestore.deletedFrom && c.deletionTimestamp === customerToRestore.deletionTimestamp) {
        return {
          ...c,
          isRestored: true,
          restoredAs: restoreForm.newId,
          restoredDate: new Date().toISOString(),
          restoredNote: `Restored as ID ${restoreForm.newId} with ₹${restoreForm.takenAmount}`
        };
      }
      return c;
    });
    localStorage.setItem(deletedKey, JSON.stringify(updatedDeletedList));

    // Recalculate BF
    const newBfAmount = recalculateBF();

    setSuccessMessage(`Customer restored successfully with new ID: ${restoreForm.newId}! ₹${restoreForm.takenAmount} deducted from BF. New BF: ₹${newBfAmount.toFixed(2)}`);
    setIsSuccessModalOpen(true);

    setIsRestoreModalOpen(false);
    setCustomerToRestore(null);
    setRestoreForm({
      newId: '',
      takenAmount: '',
      interest: '',
      pc: '',
      date: new Date().toISOString().split('T')[0],
      weeks: '12'
    });

    // Reload data
    loadCustomersAndCalculate();
  };

  const handleViewPending = () => {
    setActiveView('pending');
    // Get unique days from pending customers
    const uniqueDays = [...new Set(allPendingCustomers.map(c => c.dayName))];
    const dayToSet = viewSelectedDay || (uniqueDays.length > 0 ? uniqueDays[0] : null);
    if (uniqueDays.length > 0 && !viewSelectedDay) {
      setViewSelectedDay(dayToSet);
    }
    // Update URL
    setSearchParams({ 
      id: lineId, 
      view: 'pending',
      ...(dayToSet && { viewDay: dayToSet })
    });
  };

  const handleViewDeleted = () => {
    setActiveView('deleted');
    // Get unique days from deleted customers
    const uniqueDays = [...new Set(allDeletedCustomers.map(c => c.deletedFrom))];
    const dayToSet = viewSelectedDay || (uniqueDays.length > 0 ? uniqueDays[0] : null);
    if (uniqueDays.length > 0 && !viewSelectedDay) {
      setViewSelectedDay(dayToSet);
    }
    // Update URL
    setSearchParams({ 
      id: lineId, 
      view: 'deleted',
      ...(dayToSet && { viewDay: dayToSet })
    });
  };

  // Print handler functions
  const handlePrint = () => {
    if (printType === 'transactions') {
      handlePrintCustomerTransactions();
    } else {
      handlePrintCustomerSummary();
    }
  };

  const handlePrintCustomerTransactions = () => {
    if (!printCustomerId) {
      alert('Please enter a Customer ID');
      return;
    }

    // Find the customer
    const customer = customers.find(c => c.id === printCustomerId);
    if (!customer) {
      alert('Customer not found');
      return;
    }

    // Get transactions for this customer
    const transKey = `transactions_${lineId}_${selectedDay}_${printCustomerId}`;
    const chatKey = `chat_${lineId}_${selectedDay}_${printCustomerId}`;
    const renewalKey = `renewals_${lineId}_${selectedDay}_${printCustomerId}`;
    
    const storedTrans = localStorage.getItem(transKey);
    const storedChat = localStorage.getItem(chatKey);
    const storedRenewals = localStorage.getItem(renewalKey);
    
    const receivedTransactions = storedTrans ? JSON.parse(storedTrans) : [];
    const chatMessages = storedChat ? JSON.parse(storedChat) : [];
    const renewals = storedRenewals ? JSON.parse(storedRenewals) : [];
    
    // Combine all received payments
    const allReceived = [...receivedTransactions, ...chatMessages];
    
    // Calculate totals
    const totalPaid = allReceived.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
    const takenAmount = parseFloat(customer.takenAmount) || 0;
    const totalRenewalAmount = renewals.reduce((sum, renewal) => sum + (parseFloat(renewal.takenAmount) || 0), 0);
    const totalOwed = takenAmount + totalRenewalAmount;
    const remainingAmount = totalOwed - totalPaid;

    // Prepare bank statement data - Date, Taken, Received
    const statementMap = new Map();
    
    // Add customer creation (Taken)
    if (customer.date && takenAmount > 0) {
      statementMap.set(customer.date, {
        date: customer.date,
        taken: takenAmount,
        received: 0
      });
    }
    
    // Add renewals (Taken)
    renewals.forEach(renewal => {
      if (renewal.date) {
        const existing = statementMap.get(renewal.date) || { date: renewal.date, taken: 0, received: 0 };
        existing.taken += parseFloat(renewal.takenAmount) || 0;
        statementMap.set(renewal.date, existing);
      }
    });
    
    // Add received payments
    allReceived.forEach(trans => {
      if (trans.date) {
        const existing = statementMap.get(trans.date) || { date: trans.date, taken: 0, received: 0 };
        existing.received += parseFloat(trans.amount) || 0;
        statementMap.set(trans.date, existing);
      }
    });
    
    // Convert to array and sort by date
    const statementData = Array.from(statementMap.values()).sort((a, b) => 
      new Date(a.date) - new Date(b.date)
    );

    // Create PDF
    const doc = new jsPDF();
    
    // Header
    doc.setFillColor(59, 130, 246);
    doc.rect(0, 0, 210, 40, 'F');
    
    doc.setFontSize(24);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(255, 255, 255);
    doc.text('CUSTOMER TRANSACTIONS', 105, 16, { align: 'center' });
    
    doc.setDrawColor(255, 255, 255);
    doc.setLineWidth(0.8);
    doc.line(35, 22, 175, 22);
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    
    doc.setFillColor(255, 255, 255);
    doc.roundedRect(14, 26, 88, 9, 1.5, 1.5, 'F');
    doc.roundedRect(108, 26, 88, 9, 1.5, 1.5, 'F');
    
    doc.setTextColor(59, 130, 246);
    doc.text(`Line: ${line?.name || 'Unknown'}`, 58, 31.5, { align: 'center' });
    doc.text(`Day: ${selectedDay}`, 152, 31.5, { align: 'center' });
    
    doc.setTextColor(0, 0, 0);
    
    // Customer Details Box - Increased height to accommodate Weeks
    let yPos = 48;
    const boxWidth = 182;
    const boxStartX = 14;
    const boxEndX = boxStartX + boxWidth;
    
    doc.setFillColor(240, 248, 255);
    doc.setDrawColor(59, 130, 246);
    doc.setLineWidth(0.5);
    doc.roundedRect(boxStartX, yPos, boxWidth, 56, 2, 2, 'FD');
    
    // Highlighted heading for Customer Details
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(14);
    doc.setTextColor(59, 130, 246);
    doc.text('Customer Details:', 18, yPos + 8);
    
    // Customer details with normal styling
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    doc.text(`ID: ${customer.id}`, 18, yPos + 16);
    doc.text(`Name: ${customer.name}`, 18, yPos + 22);
    doc.text(`Village: ${customer.village || 'N/A'}`, 18, yPos + 28);
    doc.text(`Phone: ${customer.phone || 'N/A'}`, 18, yPos + 34);
    doc.text(`Interest: ${customer.interest || 'N/A'}`, 18, yPos + 40);
    doc.text(`PC: ${customer.pc || 'N/A'}`, 18, yPos + 46);
    doc.text(`Weeks: ${customer.weeks || 'N/A'}`, 18, yPos + 52);
    
    // Summary box on right - Centered in right half of the box
    // Right half starts at ~105 and ends at boxEndX (196)
    // Center position for right half: (105 + 196) / 2 = 150.5
    const rightHalfCenter = 150;
    const summaryLabelX = 118;
    const summaryValueX = boxEndX - 6;
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.setTextColor(59, 130, 246);
    doc.text(`Owed:`, summaryLabelX, yPos + 20);
    doc.text(`Rs.${totalOwed.toFixed(2)}`, summaryValueX, yPos + 20, { align: 'right' });
    
    doc.setTextColor(22, 163, 74);
    doc.text(`Total Paid:`, summaryLabelX, yPos + 28);
    doc.text(`Rs.${totalPaid.toFixed(2)}`, summaryValueX, yPos + 28, { align: 'right' });
    
    doc.setTextColor(remainingAmount > 0 ? 220 : 22, remainingAmount > 0 ? 38 : 163, remainingAmount > 0 ? 38 : 74);
    doc.text(`Remaining:`, summaryLabelX, yPos + 36);
    doc.text(`Rs.${remainingAmount.toFixed(2)}`, summaryValueX, yPos + 36, { align: 'right' });
    
    doc.setTextColor(0, 0, 0);
    doc.setFont('helvetica', 'normal');
    
    yPos += 63;
    
    // Bank Statement Table - Date, Taken, Received
    if (statementData.length > 0) {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(13);
      doc.setTextColor(220, 38, 38);
      doc.text('Transaction Statement', 14, yPos);
      doc.setTextColor(0, 0, 0);
      yPos += 5;
      
      autoTable(doc, {
        startY: yPos,
        head: [['Date', 'Taken', 'Received']],
        body: statementData.map(row => [
          row.date,
          row.taken > 0 ? `Rs.${row.taken.toFixed(2)}` : '-',
          row.received > 0 ? `Rs.${row.received.toFixed(2)}` : '-'
        ]),
        theme: 'grid',
        headStyles: { 
          fillColor: [59, 130, 246], 
          textColor: 255, 
          fontStyle: 'bold', 
          fontSize: 10,
          halign: 'center',
          lineWidth: 0.5,
          lineColor: [59, 130, 246]
        },
        styles: { 
          fontSize: 9.5, 
          fontStyle: 'bold',
          lineWidth: 0.3,
          lineColor: [200, 200, 200]
        },
        alternateRowStyles: {
          fillColor: [245, 247, 250]
        },
        margin: { left: 14, right: 14 },
        columnStyles: {
          0: { cellWidth: 60, halign: 'center' },
          1: { cellWidth: 60, halign: 'right', textColor: [220, 38, 38] },
          2: { cellWidth: 60, halign: 'right', textColor: [22, 163, 74] }
        }
      });
    }
    
    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setDrawColor(200, 200, 200);
      doc.setLineWidth(0.3);
      doc.line(14, 282, 196, 282);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(100, 100, 100);
      doc.text(`Page ${i} of ${pageCount}`, 105, 287, { align: 'center' });
      doc.text('Generated by Entry Details', 14, 287);
      doc.setTextColor(0, 0, 0);
    }
    
    doc.save(`Customer_${customer.id}_${customer.name}_Transactions.pdf`);
    setIsPrintModalOpen(false);
  };

  const handlePrintCustomerSummary = () => {
    // Determine which days to include
    const daysToInclude = selectAllDays || selectedDaysForPrint.length === days.length 
      ? days 
      : selectedDaysForPrint;
    
    if (daysToInclude.length === 0) {
      alert('Please select at least one day');
      return;
    }
    
    const doc = new jsPDF();
    
    // Header
    doc.setFillColor(59, 130, 246);
    doc.rect(0, 0, 210, 40, 'F');
    
    doc.setFontSize(24);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(255, 255, 255);
    doc.text('CUSTOMER SUMMARY', 105, 16, { align: 'center' });
    
    doc.setDrawColor(255, 255, 255);
    doc.setLineWidth(0.8);
    doc.line(35, 22, 175, 22);
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    
    doc.setFillColor(255, 255, 255);
    doc.roundedRect(14, 26, 88, 9, 1.5, 1.5, 'F');
    doc.roundedRect(108, 26, 88, 9, 1.5, 1.5, 'F');
    
    doc.setTextColor(59, 130, 246);
    doc.text(`Line: ${line?.name || 'Unknown'}`, 58, 31.5, { align: 'center' });
    const dayText = (selectAllDays || selectedDaysForPrint.length === days.length) 
      ? `BF: Rs.${bfAmount.toFixed(2)}` 
      : daysToInclude.join(', ');
    doc.text(`${dayText}`, 152, 31.5, { align: 'center' });
    
    doc.setTextColor(0, 0, 0);
    
    let yPos = 48;
    
    // If all days are selected, group by day with headings
    if (selectAllDays || selectedDaysForPrint.length === days.length) {
      daysToInclude.forEach((day, dayIndex) => {
        const storedCustomers = localStorage.getItem(`customers_${lineId}_${day}`);
        const dayCustomers = storedCustomers ? JSON.parse(storedCustomers) : [];
        
        if (dayCustomers.length === 0) return; // Skip empty days
        
        // Add day heading
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(13);
        doc.setTextColor(220, 38, 38);
        doc.text(day, 14, yPos);
        doc.setTextColor(0, 0, 0);
        yPos += 5;
        
        // Prepare customer data for this day
        const customerSummaryData = [];
        
        dayCustomers.forEach(customer => {
          const transKey = `transactions_${lineId}_${day}_${customer.id}`;
          const chatKey = `chat_${lineId}_${day}_${customer.id}`;
          const renewalKey = `renewals_${lineId}_${day}_${customer.id}`;
          
          const storedTrans = localStorage.getItem(transKey);
          const storedChat = localStorage.getItem(chatKey);
          const storedRenewals = localStorage.getItem(renewalKey);
          
          const transactions = storedTrans ? JSON.parse(storedTrans) : [];
          const chatMessages = storedChat ? JSON.parse(storedChat) : [];
          const renewals = storedRenewals ? JSON.parse(storedRenewals) : [];
          
          const totalPaid = [...transactions, ...chatMessages].reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
          const takenAmount = parseFloat(customer.takenAmount) || 0;
          const totalRenewalAmount = renewals.reduce((sum, renewal) => sum + (parseFloat(renewal.takenAmount) || 0), 0);
          const totalOwed = takenAmount + totalRenewalAmount;
          const remainingAmount = totalOwed - totalPaid;
          
          customerSummaryData.push([
            customer.id,
            customer.name,
            `Rs.${totalOwed.toFixed(2)}`,
            `Rs.${totalPaid.toFixed(2)}`,
            `Rs.${remainingAmount.toFixed(2)}`
          ]);
        });
        
        // Create table for this day without Day column
        autoTable(doc, {
          startY: yPos,
          head: [['ID', 'Name', 'Owed', 'Paid', 'Remaining']],
          body: customerSummaryData,
          theme: 'grid',
          headStyles: { 
            fillColor: [59, 130, 246], 
            textColor: 255, 
            fontStyle: 'bold', 
            fontSize: 10,
            halign: 'center',
            lineWidth: 0.5,
            lineColor: [59, 130, 246]
          },
          styles: { 
            fontSize: 9.5, 
            fontStyle: 'bold',
            lineWidth: 0.3,
            lineColor: [200, 200, 200]
          },
          alternateRowStyles: {
            fillColor: [245, 247, 250]
          },
          margin: { left: 14, right: 14 },
          columnStyles: {
            0: { cellWidth: 30, halign: 'center' },
            1: { cellWidth: 60, halign: 'left' },
            2: { cellWidth: 32, halign: 'right', textColor: [59, 130, 246] },
            3: { cellWidth: 32, halign: 'right', textColor: [22, 163, 74] },
            4: { cellWidth: 32, halign: 'right', textColor: [220, 38, 38] }
          }
        });
        
        yPos = doc.lastAutoTable.finalY + 10; // Add spacing between day sections
      });
    } else {
      // Original logic for selected specific days - show Day column
      const customerSummaryData = [];
      
      daysToInclude.forEach(day => {
        const storedCustomers = localStorage.getItem(`customers_${lineId}_${day}`);
        const dayCustomers = storedCustomers ? JSON.parse(storedCustomers) : [];
        
        dayCustomers.forEach(customer => {
          const transKey = `transactions_${lineId}_${day}_${customer.id}`;
          const chatKey = `chat_${lineId}_${day}_${customer.id}`;
          const renewalKey = `renewals_${lineId}_${day}_${customer.id}`;
          
          const storedTrans = localStorage.getItem(transKey);
          const storedChat = localStorage.getItem(chatKey);
          const storedRenewals = localStorage.getItem(renewalKey);
          
          const transactions = storedTrans ? JSON.parse(storedTrans) : [];
          const chatMessages = storedChat ? JSON.parse(storedChat) : [];
          const renewals = storedRenewals ? JSON.parse(storedRenewals) : [];
          
          const totalPaid = [...transactions, ...chatMessages].reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
          const takenAmount = parseFloat(customer.takenAmount) || 0;
          const totalRenewalAmount = renewals.reduce((sum, renewal) => sum + (parseFloat(renewal.takenAmount) || 0), 0);
          const totalOwed = takenAmount + totalRenewalAmount;
          const remainingAmount = totalOwed - totalPaid;
          
          customerSummaryData.push([
            customer.id,
            customer.name,
            day,
            `Rs.${totalOwed.toFixed(2)}`,
            `Rs.${totalPaid.toFixed(2)}`,
            `Rs.${remainingAmount.toFixed(2)}`
          ]);
        });
      });
      
      // Summary Table with same styling as transactions
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.setTextColor(59, 130, 246);
      doc.text('Customer Summary Report', 14, yPos);
      doc.setTextColor(0, 0, 0);
      doc.setFont('helvetica', 'normal');
      yPos += 5;
      
      autoTable(doc, {
        startY: yPos,
        head: [['ID', 'Name', 'Day', 'Owed', 'Paid', 'Remaining']],
        body: customerSummaryData,
        theme: 'grid',
        headStyles: { 
          fillColor: [59, 130, 246], 
          textColor: 255, 
          fontStyle: 'bold', 
          fontSize: 10,
          halign: 'center',
          lineWidth: 0.5,
          lineColor: [59, 130, 246]
        },
        styles: { 
          fontSize: 9.5, 
          fontStyle: 'bold',
          lineWidth: 0.3,
          lineColor: [200, 200, 200]
        },
        alternateRowStyles: {
          fillColor: [245, 247, 250]
        },
        margin: { left: 14, right: 14 },
        columnStyles: {
          0: { cellWidth: 20, halign: 'center' },
          1: { cellWidth: 45, halign: 'left' },
          2: { cellWidth: 30, halign: 'center' },
          3: { cellWidth: 30, halign: 'right', textColor: [59, 130, 246] },
          4: { cellWidth: 30, halign: 'right', textColor: [22, 163, 74] },
          5: { cellWidth: 30, halign: 'right', textColor: [220, 38, 38] }
        }
      });
    }
    
    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setDrawColor(200, 200, 200);
      doc.setLineWidth(0.3);
      doc.line(14, 282, 196, 282);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(100, 100, 100);
      doc.text(`Page ${i} of ${pageCount}`, 105, 287, { align: 'center' });
      doc.text('Generated by Entry Details', 14, 287);
      doc.setTextColor(0, 0, 0);
    }
    
    const fileName = selectAllDays ? 'Customer_Summary_All_Days.pdf' : `Customer_Summary_${daysToInclude.join('_')}.pdf`;
    doc.save(fileName);
    setIsPrintModalOpen(false);
  };

  // Get days for pending view
  const pendingDays = [...new Set(allPendingCustomers.map(c => c.dayName))];
  
  // Get days for deleted view
  const deletedDays = [...new Set(allDeletedCustomers.map(c => c.deletedFrom))];

  // Filter pending customers by selected day in view
  const filteredPendingCustomers = viewSelectedDay 
    ? allPendingCustomers.filter(c => c.dayName === viewSelectedDay)
    : allPendingCustomers;

  // Filter deleted customers by selected day in view (exclude restored customers)
  const filteredDeletedCustomers = viewSelectedDay
    ? allDeletedCustomers.filter(c => c.deletedFrom === viewSelectedDay && !c.isRestored)
    : allDeletedCustomers.filter(c => !c.isRestored);

  // Filtered pending customers with search
  const searchFilteredPendingCustomers = searchQuery
    ? filteredPendingCustomers.filter(c =>
        c.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        c.id.toLowerCase().includes(searchQuery.toLowerCase())
      )
    : filteredPendingCustomers;

  // Filtered deleted customers with search
  const searchFilteredDeletedCustomers = searchQuery
    ? filteredDeletedCustomers.filter(c =>
        c.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        c.id.toLowerCase().includes(searchQuery.toLowerCase())
      )
    : filteredDeletedCustomers;

  if (!line) return <div className={`min-h-screen ${theme === 'light' ? 'bg-gradient-to-br from-slate-50 via-blue-50/30 to-cyan-50/20 text-gray-900' : 'bg-[#0f1419] text-white'} flex items-center justify-center`}>Loading...</div>;

  return (
    <>
      <div className={`min-h-screen ${theme === 'light' ? 'bg-gradient-to-br from-slate-50 via-blue-50/30 to-cyan-50/20' : 'bg-[#0f1419]'} flex flex-col md:flex-row relative`}>
        {/* Subtle Background Pattern for Light Mode */}
        {theme === 'light' && (
          <div className="fixed inset-0 pointer-events-none z-0">
            {/* Subtle gradient mesh */}
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,rgba(59,130,246,0.03),transparent_50%)]"></div>
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_80%_20%,rgba(6,182,212,0.03),transparent_50%)]"></div>
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_20%_80%,rgba(99,102,241,0.02),transparent_50%)]"></div>
            
            {/* Very subtle grid pattern */}
            <div className="absolute inset-0 opacity-[0.02]" style={{
              backgroundImage: `linear-gradient(rgba(100, 116, 139, 0.1) 1px, transparent 1px),
                               linear-gradient(90deg, rgba(100, 116, 139, 0.1) 1px, transparent 1px)`,
              backgroundSize: '64px 64px'
            }}></div>
          </div>
        )}
        
        {/* Ambient glows */}
        <div className="fixed inset-0 overflow-hidden pointer-events-none z-0">
          <div className={`absolute top-20 right-20 w-96 h-96 ${theme === 'light' ? 'bg-blue-400/5' : 'bg-cyan-500/10'} rounded-full blur-3xl`} />
          <div className={`absolute bottom-20 left-20 w-96 h-96 ${theme === 'light' ? 'bg-cyan-400/5' : 'bg-blue-500/10'} rounded-full blur-3xl`} />
          <div className={`absolute top-1/2 left-1/2 w-96 h-96 ${theme === 'light' ? 'bg-blue-400/3' : 'bg-blue-500/5'} rounded-full blur-3xl`} />
        </div>

        {/* Left Sidebar - Days with Tabs (Full Height) - Collapsible with Smooth Animation */}
        <div className={`relative z-20 ${theme === 'light' ? 'bg-white/95 border-gray-200' : 'bg-[#1a1f2e]/80 border-slate-800/50'} backdrop-blur-xl border-r flex flex-col md:h-screen overflow-hidden transition-all duration-300 ease-in-out ${
          isSidebarOpen ? 'w-full md:w-80' : 'w-0 md:w-0'
        }`}>
          <div className={`h-full flex flex-col transition-opacity duration-300 ease-in-out ${isSidebarOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
            {isSidebarOpen && (
              <>
              {/* Top Section - Line Info in One Line - MATCH HEADER HEIGHT */}
              <div className={`px-6 py-4 border-b ${theme === 'light' ? 'border-gray-200' : 'border-slate-800/50'} flex-shrink-0 h-[72px] flex items-center`}>
                <div className="flex items-center gap-3 flex-wrap">
                  <div className={`px-4 py-2 ${theme === 'light' ? 'bg-gradient-to-r from-blue-500/20 to-cyan-500/20 border-blue-400' : 'bg-gradient-to-r from-cyan-500/30 to-blue-500/30 border-cyan-400/50'} backdrop-blur-md rounded-lg border-2 shadow-lg hover:shadow-cyan-500/30 transition-all`}>
                    <span className={`${theme === 'light' ? 'text-blue-700' : 'text-cyan-300'} text-sm font-bold tracking-wide drop-shadow-md`}>{line?.name || 'Loading...'}</span>
                  </div>
                  
                  <div className={`px-4 py-1.5 ${theme === 'light' ? 'bg-gray-200 border-gray-300' : 'bg-gradient-to-r from-slate-700/80 to-slate-800/80 border-slate-600/50'} rounded-lg border-2 shadow-md`}>
                    <span className={`${theme === 'light' ? 'text-gray-700' : 'text-slate-300'} text-xs font-semibold uppercase tracking-wider`}>{line?.type || 'Type'}</span>
                  </div>
                </div>
              </div>

          {/* Add Day Section - MATCH SEARCH BAR POSITION */}
          <div className={`px-6 py-6 flex-shrink-0 border-b ${theme === 'light' ? 'border-gray-200' : 'border-slate-800/50'}`}>
            <Button 
              onClick={() => setIsAddDayModalOpen(true)} 
              className={`w-full ${theme === 'light' ? 'bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 shadow-blue-500/20' : 'bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 shadow-cyan-500/20'} shadow-lg border border-cyan-400/30 h-10`} 
              size="sm"
            >
              <Plus className="w-4 h-4 mr-2" />
              Add Day
            </Button>
          </div>
            
          {/* Days List - Scrollable Area */}
          <div className={`flex-1 px-6 pb-4 space-y-2 overflow-y-auto scrollbar-thin ${theme === 'light' ? 'scrollbar-thumb-gray-300 scrollbar-track-gray-100' : 'scrollbar-thumb-slate-700 scrollbar-track-transparent'}`}>
            {days.map((day) => (
              <div
                key={day}
                onClick={() => handleSelectDay(day)}
                className={`p-3 rounded-xl cursor-pointer transition-all group relative ${
                  selectedDay === day
                    ? theme === 'light' 
                      ? 'bg-gradient-to-r from-blue-100 to-cyan-100 border border-blue-400 shadow-lg shadow-blue-200/50'
                      : 'bg-gradient-to-r from-cyan-500/20 to-blue-500/20 border border-cyan-500/50 shadow-lg shadow-cyan-500/10'
                    : theme === 'light'
                      ? 'bg-gray-50 hover:bg-gray-100 border border-gray-200 hover:border-gray-300'
                      : 'bg-slate-800/30 hover:bg-slate-800/50 border border-slate-700/50 hover:border-slate-600'
                }`}
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-2">
                    <Calendar className={`w-4 h-4 ${selectedDay === day ? (theme === 'light' ? 'text-blue-600' : 'text-cyan-400') : (theme === 'light' ? 'text-gray-500' : 'text-slate-400')}`} />
                    <span className={`text-sm font-semibold ${selectedDay === day ? (theme === 'light' ? 'text-blue-700' : 'text-cyan-300') : (theme === 'light' ? 'text-gray-700' : 'text-slate-300')}`}>
                      {day}
                    </span>
                  </div>
                  <DropdownMenu>
                    <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
                      <button className={`opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded ${theme === 'light' ? 'hover:bg-gray-200' : 'hover:bg-slate-700/50'} ${
                        selectedDay === day ? (theme === 'light' ? 'text-blue-600' : 'text-cyan-300') : (theme === 'light' ? 'text-gray-500' : 'text-slate-400')
                      }`}>
                        <MoreVertical className="w-4 h-4" />
                      </button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent className={`${theme === 'light' ? 'bg-white border-gray-200 text-gray-800' : 'bg-[#1a1f2e] border-slate-700 text-slate-200'}`}>
                      <DropdownMenuItem
                        onClick={(e) => handleDeleteDay(day, e)}
                        className="text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-500/10 cursor-pointer"
                      >
                        <Trash2 className="w-4 h-4 mr-2" />
                        Delete
                      </DropdownMenuItem>
                    </DropdownMenuContent>
                  </DropdownMenu>
                </div>
              </div>
            ))}
          </div>

          {/* Quick View Buttons - FIXED AT BOTTOM */}
          <div className={`${theme === 'light' ? 'bg-gray-50/80 border-gray-200' : 'bg-[#141824]/50 border-slate-800/50'} flex-shrink-0 border-t`}>
            <div className="p-3 space-y-2">
              {/* Pending Button */}
              <button
                onClick={handleViewPending}
                className={`w-full flex items-center justify-between px-4 py-3 rounded-xl transition-all ${
                  activeView === 'pending'
                    ? theme === 'light'
                      ? 'bg-gradient-to-r from-orange-100 to-amber-100 border border-orange-400'
                      : 'bg-gradient-to-r from-orange-500/30 to-amber-500/30 border border-orange-500/50'
                    : theme === 'light'
                      ? 'bg-gray-50 hover:bg-gray-100 border border-gray-200 hover:border-orange-300'
                      : 'bg-slate-800/30 hover:bg-slate-800/50 border border-slate-700/50 hover:border-orange-500/30'
                }`}
              >
                <div className="flex items-center space-x-2">
                  {activeView === 'pending' && <div className="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></div>}
                  <AlertCircle className={`w-4 h-4 ${activeView === 'pending' ? (theme === 'light' ? 'text-orange-600' : 'text-orange-400') : (theme === 'light' ? 'text-gray-500' : 'text-slate-400')}`} />
                  <span className={`font-semibold text-sm ${activeView === 'pending' ? (theme === 'light' ? 'text-orange-700' : 'text-orange-300') : (theme === 'light' ? 'text-gray-700' : 'text-slate-300')}`}>
                    Pending Customers
                  </span>
                </div>
                <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${
                  activeView === 'pending'
                    ? theme === 'light' ? 'bg-orange-200 text-orange-700' : 'bg-orange-500/30 text-orange-300'
                    : theme === 'light' ? 'bg-orange-100 text-orange-600' : 'bg-orange-500/20 text-orange-400'
                }`}>
                  {allPendingCustomers.length}
                </span>
              </button>

              {/* Deleted Button */}
              <button
                onClick={handleViewDeleted}
                className={`w-full flex items-center justify-between px-4 py-3 rounded-xl transition-all ${
                  activeView === 'deleted'
                    ? theme === 'light'
                      ? 'bg-gradient-to-r from-red-100 to-rose-100 border border-red-400'
                      : 'bg-gradient-to-r from-red-500/30 to-rose-500/30 border border-red-500/50'
                    : theme === 'light'
                      ? 'bg-gray-50 hover:bg-gray-100 border border-gray-200 hover:border-red-300'
                      : 'bg-slate-800/30 hover:bg-slate-800/50 border border-slate-700/50 hover:border-red-500/30'
                }`}
              >
                <div className="flex items-center space-x-2">
                  {activeView === 'deleted' && <div className="w-2 h-2 rounded-full bg-red-500"></div>}
                  <Trash2 className={`w-4 h-4 ${activeView === 'deleted' ? (theme === 'light' ? 'text-red-600' : 'text-red-400') : (theme === 'light' ? 'text-gray-500' : 'text-slate-400')}`} />
                  <span className={`font-semibold text-sm ${activeView === 'deleted' ? (theme === 'light' ? 'text-red-700' : 'text-red-300') : (theme === 'light' ? 'text-gray-700' : 'text-slate-300')}`}>
                    Deleted Customers
                  </span>
                </div>
                <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${
                  activeView === 'deleted'
                    ? theme === 'light' ? 'bg-red-200 text-red-700' : 'bg-red-500/30 text-red-300'
                    : theme === 'light' ? 'bg-red-100 text-red-600' : 'bg-red-500/20 text-red-400'
                }`}>
                  {allDeletedCustomers.length}
                </span>
              </button>
            </div>
          </div>
            </>
          )}
          </div>
        </div>

      {/* Right Side - Header + Content */}
      <div className="relative z-10 flex-1 flex flex-col md:h-screen">
        {/* Header */}
        <div className={`${theme === 'light' ? 'bg-white border-gray-200' : 'bg-[#1a1f2e] border-slate-800/50'} border-b backdrop-blur-xl flex-shrink-0 h-[72px]`}>
          <div className="px-6 h-full flex items-center">
            <div className="grid grid-cols-3 items-center gap-3 w-full">
              {/* Left - Hamburger, Back Button & Day Name */}
              <div className="flex items-center gap-3 justify-start">
                <Button
                  onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                  variant="ghost"
                  size="icon"
                  className={`h-10 w-10 rounded-full shadow-md transition-all duration-200 hover:shadow-lg ${theme === 'light' ? 'bg-gray-100 hover:bg-gray-200 border-gray-300 hover:border-gray-400 text-gray-600 hover:text-gray-900' : 'bg-slate-800/80 hover:bg-slate-700 border-slate-700 hover:border-slate-600 text-slate-300 hover:text-white'} border-2`}
                >
                  <div className={`transition-all duration-200`}>
                    {isSidebarOpen ? <X className="h-5 w-5" /> : <Menu className="h-5 w-5" />}
                  </div>
                </Button>
                <Button 
                  onClick={() => navigate('/dashboard')} 
                  variant="ghost" 
                  size="icon"
                  className={`h-10 w-10 rounded-full shadow-md transition-all hover:shadow-lg ${theme === 'light' ? 'bg-gray-100 hover:bg-gray-200 border-gray-300 hover:border-gray-400 text-gray-600 hover:text-gray-900' : 'bg-slate-800/80 hover:bg-slate-700 border-slate-700 hover:border-slate-600 text-slate-300 hover:text-white'} border-2`}
                >
                  <ArrowLeft className="h-5 w-5" />
                </Button>
                {/* Day Name - Moved here */}
                {selectedDay && (
                  <div className={`px-4 py-2 backdrop-blur-md rounded-lg border-2 shadow-md min-w-[120px] text-center ${theme === 'light' ? 'bg-blue-50 border-blue-300' : 'bg-gradient-to-br from-blue-500/20 to-purple-500/20 border-blue-500/30'}`}>
                    <span className={`${theme === 'light' ? 'text-blue-700' : 'text-blue-300'} text-sm font-bold tracking-wide whitespace-nowrap`}>{selectedDay}</span>
                  </div>
                )}
              </div>

              {/* Center - BF Badge - Simple & Rich */}
              <div className="flex items-center justify-center">
                <div className={`relative group flex items-center gap-3 px-6 py-3 rounded-xl backdrop-blur-xl border transition-all duration-300 ${
                  theme === 'light' 
                    ? 'bg-white/80 border-blue-200 shadow-lg shadow-blue-100/50 hover:shadow-xl hover:shadow-blue-200/60' 
                    : 'bg-gradient-to-br from-slate-800/90 to-slate-900/90 border-slate-700/50 shadow-lg shadow-cyan-500/10 hover:shadow-xl hover:shadow-cyan-500/20'
                }`}>
                  {/* Subtle accent bar */}
                  <div className={`absolute left-0 top-0 bottom-0 w-1 rounded-l-xl ${
                    theme === 'light' 
                      ? 'bg-gradient-to-b from-blue-500 via-cyan-500 to-emerald-500' 
                      : 'bg-gradient-to-b from-cyan-500 via-blue-500 to-purple-500'
                  }`}></div>
                  
                  {/* Icon */}
                  <div className={`w-11 h-11 rounded-lg flex items-center justify-center ${
                    theme === 'light' 
                      ? 'bg-gradient-to-br from-blue-500 to-cyan-500' 
                      : 'bg-gradient-to-br from-cyan-500 to-blue-600'
                  } shadow-md`}>
                    <span className="text-xl">💰</span>
                  </div>
                  
                  {/* Text Content */}
                  <div className="flex flex-col">
                    <span className={`text-[10px] font-bold uppercase tracking-wider ${
                      theme === 'light' ? 'text-blue-600' : 'text-cyan-400'
                    }`}>
                      Balance Forward
                    </span>
                    <div className="flex items-baseline gap-1">
                      <span className={`text-xs font-semibold ${
                        theme === 'light' ? 'text-blue-500' : 'text-cyan-300'
                      }`}>₹</span>
                      <span className={`text-2xl font-bold ${
                        theme === 'light' ? 'text-gray-900' : 'text-white'
                      } tracking-tight`}>
                        {bfAmount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              {/* Right - Print & Logout */}
              <div className="flex items-center gap-3 justify-end">
                {/* Print Button */}
                {selectedDay && (
                  <Button
                    onClick={() => {
                      setPrintType('transactions');
                      setPrintCustomerId('');
                      setPrintCustomerName('');
                      setSelectAllDays(true);
                      setSelectedDaysForPrint([]);
                      setIsPrintModalOpen(true);
                    }}
                    variant="outline"
                    size="sm"
                    className={`${theme === 'light' ? 'bg-gradient-to-br from-green-50 to-white border-2 border-green-300 text-green-900 hover:from-green-100 hover:to-white hover:border-green-400' : 'bg-slate-800 border-slate-600 text-slate-200 hover:text-white'} shadow-md transition-all hover:shadow-lg text-xs md:text-sm whitespace-nowrap h-9`}
                  >
                    <Printer className="w-4 h-4 mr-2" />
                    <span className="hidden md:inline">Print</span>
                  </Button>
                )}
                {/* Logout Button */}
                <Button 
                  onClick={() => { localStorage.removeItem('isAuthenticated'); navigate('/'); }} 
                  variant="ghost" 
                  size="sm" 
                  className={`${theme === 'light' ? 'text-gray-600 hover:text-red-600 hover:bg-red-50 border-gray-300 hover:border-red-400' : 'text-slate-400 hover:text-white hover:bg-red-500/20 border-slate-700 hover:border-red-500/50'} border text-xs md:text-sm whitespace-nowrap h-9`}
                >
                  <LogOut className="w-4 h-4 mr-2" />
                  <span className="hidden md:inline">Logout</span>
                </Button>
              </div>
            </div>
          </div>
        </div>

        {/* Content Area */}
        <div className={`flex-1 px-6 py-6 overflow-y-auto relative z-10 ${theme === 'light' ? 'bg-transparent' : 'bg-[#0f1419]'}`}>
            {/* Day Tabs for Pending/Deleted View */}
            {(activeView === 'pending' || activeView === 'deleted') && (
              <div className={`mb-4 backdrop-blur-lg rounded-xl p-3 border ${theme === 'light' ? 'bg-white border-gray-200' : 'bg-slate-800/30 border-slate-700/50'}`}>
                <div className="flex items-center space-x-2 mb-3">
                  <Calendar className={`w-4 h-4 ${theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}`} />
                  <span className={`text-sm font-semibold ${theme === 'light' ? 'text-gray-700' : 'text-slate-300'}`}>Filter by Day</span>
                </div>
                <div className="flex flex-wrap gap-2">
                  {(activeView === 'pending' ? pendingDays : deletedDays).map((day) => (
                    <button
                      key={day}
                      onClick={() => {
                        setViewSelectedDay(day);
                        // Update URL
                        setSearchParams({ 
                          id: lineId, 
                          view: activeView,
                          viewDay: day
                        });
                      }}
                      className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                        viewSelectedDay === day
                          ? theme === 'light'
                            ? 'bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg shadow-blue-500/20'
                            : 'bg-gradient-to-r from-cyan-500 to-blue-500 text-white shadow-lg shadow-cyan-500/20'
                          : theme === 'light'
                            ? 'bg-gray-100 text-gray-700 hover:bg-gray-200 border border-gray-300'
                            : 'bg-slate-700/50 text-slate-300 hover:bg-slate-700 border border-slate-600'
                      }`}
                    >
                      {day}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {/* Search & Actions */}
            <div className="flex flex-col md:flex-row justify-between items-stretch md:items-center mb-6 gap-3">
              <div className="relative flex-1 md:max-w-md h-10">
                <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 ${theme === 'light' ? 'text-gray-400' : 'text-slate-500'}`} />
                <Input
                  placeholder="Search by Name, ID, or Phone..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className={`pl-10 h-full backdrop-blur-lg ${theme === 'light' ? 'bg-white border-gray-300 text-gray-900 placeholder:text-gray-400 focus:border-blue-500' : 'bg-slate-800/50 border-slate-700 text-slate-200 placeholder:text-slate-500 focus:border-cyan-500/50'}`}
                />
              </div>
              {/* Only show action buttons in customers view */}
              {activeView === 'customers' && (
                <div className="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                  {selectedDay && (
                    <>
                      <Button
                        onClick={() => setIsQuickTransactionOpen(true)}
                        size="sm"
                        className="group relative bg-violet-600 hover:bg-violet-500 shadow-lg shadow-violet-600/40 hover:shadow-violet-500/60 border-2 border-violet-500/70 hover:border-violet-400/90 text-white text-xs md:text-sm w-full sm:w-auto font-semibold transition-all duration-300 hover:scale-[1.02]"
                      >
                        <div className="absolute inset-0 bg-white/0 hover:bg-white/10 transition-all duration-500 rounded-md"></div>
                        <RefreshCw className="w-3 h-3 md:w-4 md:h-4 mr-1 md:mr-2 animate-spin-slow group-hover:animate-spin relative z-10" />
                        <span className="hidden sm:inline relative z-10">Quick Transaction</span>
                        <span className="sm:hidden relative z-10">Quick Trans</span>
                      </Button>
                      <Button 
                        onClick={() => navigate(`/collections?id=${lineId}&day=${selectedDay}`)} 
                        size="sm"
                        className="group relative bg-blue-600 hover:bg-blue-500 shadow-lg shadow-blue-600/40 hover:shadow-blue-500/60 border-2 border-blue-500/70 hover:border-blue-400/90 text-white text-xs md:text-sm w-full sm:w-auto font-semibold transition-all duration-300 hover:scale-[1.02]"
                      >
                        <div className="absolute inset-0 bg-white/0 hover:bg-white/10 transition-all duration-500 rounded-md"></div>
                        <CheckCircle className="w-3 h-3 md:w-4 md:h-4 mr-1 md:mr-2 relative z-10" />
                        <span className="relative z-10">Collections</span>
                      </Button>
                      <Button
                        onClick={() => handleOpenCustomerModal()}
                        size="sm"
                        className="group relative bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 shadow-lg shadow-emerald-600/40 hover:shadow-emerald-500/60 border-2 border-emerald-500/70 hover:border-emerald-400/90 text-white text-xs md:text-sm w-full sm:w-auto font-semibold transition-all duration-300 hover:scale-[1.02]"
                      >
                        <div className="absolute inset-0 bg-white/0 hover:bg-white/10 transition-all duration-500 rounded-md"></div>
                        <Plus className="w-3 h-3 md:w-4 md:h-4 mr-1 md:mr-2 relative z-10" />
                        <span className="relative z-10">Add Customer</span>
                      </Button>
                    </>
                  )}
                </div>
              )}
            </div>

            {/* Customer Cards */}
            {activeView === 'pending' ? (
              // Pending Customers View
              <div>
                <div className="mb-4 flex items-center justify-between">
                  <h2 className={`text-xl font-bold text-transparent bg-clip-text ${theme === 'light' ? 'bg-gradient-to-r from-orange-600 to-amber-600' : 'bg-gradient-to-r from-orange-400 to-amber-400'}`}>
                    Pending Customers {viewSelectedDay && `- ${viewSelectedDay}`}
                  </h2>
                  <span className={`text-sm ${theme === 'light' ? 'text-gray-600' : 'text-slate-400'}`}>{searchFilteredPendingCustomers.length} customer(s)</span>
                </div>
                {searchFilteredPendingCustomers.length === 0 ? (
                  <div className={`text-center py-20 ${theme === 'light' ? 'text-gray-400' : 'text-slate-500'}`}>
                    <Clock className="w-24 h-24 mx-auto mb-4 opacity-20" />
                    <p className="text-lg">No pending customers</p>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                    {searchFilteredPendingCustomers.map((customer) => {
                      // Check for renewals
                      const renewalKey = `renewals_${lineId}_${customer.dayName}_${customer.id}`;
                      const storedRenewals = localStorage.getItem(renewalKey);
                      const renewals = storedRenewals ? JSON.parse(storedRenewals) : [];
                      const latestRenewal = renewals.length > 0 ? renewals[renewals.length - 1] : null;
                      const displayTakenAmount = latestRenewal ? parseFloat(latestRenewal.takenAmount) : parseFloat(customer.takenAmount);
                      
                      return (
                        <div
                          key={`${customer.dayName}_${customer.id}`}
                          onClick={() => navigate(`/customer?id=${customer.id}&day=${customer.dayName}&lineId=${lineId}`)}
                          className={`backdrop-blur-xl rounded-xl p-3 shadow-lg border-l-4 border-orange-500 hover:border-orange-400 transition-all duration-300 cursor-pointer hover:scale-[1.01] relative hover:z-50 ${theme === 'light' ? 'bg-white hover:shadow-orange-200/40' : 'bg-gradient-to-br from-slate-800/40 to-slate-900/40 hover:shadow-orange-500/20'}`}
                        >
                          <div className="flex items-center space-x-2 mb-2">
                            <div className="relative group/profile">
                              <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-500 to-amber-500 flex items-center justify-center text-white font-bold shadow-lg flex-shrink-0">
                                {customer.profileImage ? (
                                  <img src={customer.profileImage} alt="Profile" className="w-full h-full rounded-lg object-cover" />
                                ) : (
                                  <UserIcon className="w-5 h-5" />
                                )}
                              </div>
                              
                              {/* Tooltip */}
                              <div className={`absolute left-full ml-2 top-0 w-64 border p-4 rounded-xl shadow-2xl opacity-0 invisible group-hover/profile:opacity-100 group-hover/profile:visible transition-all duration-200 z-[100] text-xs space-y-1.5 backdrop-blur-xl ${theme === 'light' ? 'bg-white border-gray-200 text-gray-800' : 'bg-[#1a1f2e] border-slate-700 text-slate-200'}`}>
                                <p><strong className={theme === 'light' ? 'text-orange-600' : 'text-cyan-400'}>Name:</strong> {customer.name}</p>
                                <p><strong className={theme === 'light' ? 'text-orange-600' : 'text-cyan-400'}>ID:</strong> {customer.id}</p>
                                <p><strong className={theme === 'light' ? 'text-orange-600' : 'text-cyan-400'}>Village:</strong> {customer.village}</p>
                                <p><strong className={theme === 'light' ? 'text-orange-600' : 'text-cyan-400'}>Phone:</strong> {customer.phone}</p>
                                <p><strong className={theme === 'light' ? 'text-orange-600' : 'text-cyan-400'}>Original Amount:</strong> ₹{latestRenewal ? latestRenewal.takenAmount : customer.takenAmount}</p>
                                <p><strong className={theme === 'light' ? 'text-orange-600' : 'text-cyan-400'}>Interest:</strong> {customer.interest}</p>
                                <p><strong className={theme === 'light' ? 'text-orange-600' : 'text-cyan-400'}>PC:</strong> {customer.pc}</p>
                                <p><strong className={theme === 'light' ? 'text-orange-600' : 'text-cyan-400'}>Date:</strong> {customer.date}</p>
                                <p><strong className={theme === 'light' ? 'text-orange-600' : 'text-cyan-400'}>Weeks:</strong> {customer.weeks}</p>
                              </div>
                            </div>
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-1">
                                <h4 className={`font-bold text-sm truncate ${theme === 'light' ? 'text-gray-800' : 'text-slate-200'}`}>{customer.name}</h4>
                                {latestRenewal && (
                                  <span className={`text-[9px] px-1 py-0.5 rounded border flex-shrink-0 ${theme === 'light' ? 'bg-blue-100 text-blue-600 border-blue-300' : 'bg-blue-500/20 text-blue-400 border-blue-500/30'}`}>R</span>
                                )}
                              </div>
                              <p className={`text-[10px] ${theme === 'light' ? 'text-gray-600' : 'text-slate-400'}`}>ID: {customer.id}</p>
                            </div>
                          </div>
                          <div className="space-y-1.5 text-xs">
                            <div className="flex justify-between">
                              <span className={theme === 'light' ? 'text-gray-500' : 'text-slate-500'}>Day:</span>
                              <span className={`font-medium ${theme === 'light' ? 'text-orange-600' : 'text-cyan-400'}`}>{customer.dayName}</span>
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <span className={`text-[10px] ${theme === 'light' ? 'text-gray-500' : 'text-slate-500'}`}>Taken</span>
                                <div className={`font-bold text-xs ${theme === 'light' ? 'text-blue-600' : 'text-blue-400'}`}>₹{displayTakenAmount.toFixed(2)}</div>
                              </div>
                              <div>
                                <span className={`text-[10px] ${theme === 'light' ? 'text-gray-500' : 'text-slate-500'}`}>Remaining</span>
                                <div className="font-bold text-red-500 text-xs">₹{customer.remainingAmount.toFixed(2)}</div>
                              </div>
                            </div>
                            <div className={`flex justify-between pt-1 border-t ${theme === 'light' ? 'border-gray-200' : 'border-slate-700/50'}`}>
                              <span className={theme === 'light' ? 'text-gray-500' : 'text-slate-500'}>Overdue:</span>
                              <span className="font-bold text-orange-500">{customer.daysOverdue} days</span>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            ) : activeView === 'deleted' ? (
              // Deleted Customers View
              <div>
                <div className="mb-4 flex items-center justify-between">
                  <h2 className={`text-xl font-bold text-transparent bg-clip-text ${theme === 'light' ? 'bg-gradient-to-r from-red-600 to-rose-600' : 'bg-gradient-to-r from-red-400 to-rose-400'}`}>
                    Deleted Customers {viewSelectedDay && `- ${viewSelectedDay}`}
                  </h2>
                  <span className={`text-sm ${theme === 'light' ? 'text-gray-600' : 'text-slate-400'}`}>{searchFilteredDeletedCustomers.length} customer(s)</span>
                </div>
                {searchFilteredDeletedCustomers.length === 0 ? (
                  <div className={`text-center py-20 ${theme === 'light' ? 'text-gray-400' : 'text-slate-500'}`}>
                    <Trash2 className="w-24 h-24 mx-auto mb-4 opacity-20" />
                    <p className="text-lg">No deleted customers</p>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                    {searchFilteredDeletedCustomers.map((customer, index) => (
                      <div
                        key={`deleted_${index}`}
                        onClick={() => navigate(`/customer?id=${customer.id}&day=${customer.deletedFrom}&lineId=${lineId}&deleted=true&timestamp=${customer.deletionTimestamp}`)}
                        className={`backdrop-blur-xl rounded-xl p-3 shadow-lg border-l-4 border-red-500 hover:border-red-400 transition-all duration-300 cursor-pointer hover:scale-[1.01] relative hover:z-50 ${theme === 'light' ? 'bg-white hover:shadow-red-200/40' : 'bg-gradient-to-br from-slate-800/40 to-slate-900/40 hover:shadow-red-500/20'}`}
                      >
                        <div className="flex items-center justify-between mb-2">
                          <div className="flex items-center space-x-2 flex-1 min-w-0">
                            <div className="relative group/profile">
                              <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-red-500 to-rose-500 flex items-center justify-center text-white font-bold shadow-lg flex-shrink-0">
                                {customer.profileImage ? (
                                  <img src={customer.profileImage} alt="Profile" className="w-full h-full rounded-lg object-cover" />
                                ) : (
                                  <UserIcon className="w-5 h-5" />
                                )}
                              </div>
                              
                              {/* Tooltip */}
                              <div className={`absolute left-full ml-2 top-0 w-64 border p-4 rounded-xl shadow-2xl opacity-0 invisible group-hover/profile:opacity-100 group-hover/profile:visible transition-all duration-200 z-[100] text-xs space-y-1.5 backdrop-blur-xl ${theme === 'light' ? 'bg-white border-gray-200 text-gray-800' : 'bg-[#1a1f2e] border-slate-700 text-slate-200'}`}>
                                <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Name:</strong> {customer.name}</p>
                                <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>ID:</strong> {customer.id}</p>
                                <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Village:</strong> {customer.village}</p>
                                <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Phone:</strong> {customer.phone}</p>
                                <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Taken Amount:</strong> ₹{customer.takenAmount}</p>
                                <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Interest:</strong> {customer.interest}</p>
                                <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>PC:</strong> {customer.pc}</p>
                                <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Date:</strong> {customer.date}</p>
                                <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Weeks:</strong> {customer.weeks}</p>
                                <p className={`pt-2 border-t ${theme === 'light' ? 'border-gray-200' : 'border-slate-700'}`}><strong className="text-red-500">Deleted On:</strong> {customer.deletedDate}</p>
                                <p><strong className="text-red-500">Deleted From:</strong> {customer.deletedFrom}</p>
                              </div>
                            </div>
                            <div className="flex-1 min-w-0">
                              <h4 className={`font-bold text-sm truncate ${theme === 'light' ? 'text-gray-800' : 'text-slate-200'}`}>{customer.name}</h4>
                              <p className={`text-[10px] ${theme === 'light' ? 'text-gray-600' : 'text-slate-400'}`}>ID: {customer.id}</p>
                            </div>
                          </div>
                          <div className={`px-1.5 py-0.5 rounded text-[9px] font-medium border flex-shrink-0 ml-1 ${theme === 'light' ? 'bg-red-100 text-red-600 border-red-300' : 'bg-red-500/20 text-red-400 border-red-500/30'}`}>
                            Deleted
                          </div>
                        </div>
                        <div className="space-y-1.5 text-xs">
                          <div className="flex justify-between">
                            <span className={`text-[10px] ${theme === 'light' ? 'text-gray-500' : 'text-slate-500'}`}>From Day:</span>
                            <span className={`font-medium ${theme === 'light' ? 'text-red-600' : 'text-cyan-400'}`}>{customer.deletedFrom}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className={`text-[10px] ${theme === 'light' ? 'text-gray-500' : 'text-slate-500'}`}>Deleted On:</span>
                            <span className={theme === 'light' ? 'text-gray-700' : 'text-slate-300'}>{customer.deletedDate}</span>
                          </div>
                          <div className={`grid grid-cols-2 gap-2 pt-1 border-t ${theme === 'light' ? 'border-gray-200' : 'border-slate-700/50'}`}>
                            <div>
                              <span className={`text-[10px] ${theme === 'light' ? 'text-gray-500' : 'text-slate-500'}`}>Taken</span>
                              <div className={`font-medium text-xs ${theme === 'light' ? 'text-gray-700' : 'text-slate-300'}`}>₹{customer.takenAmount}</div>
                            </div>
                            <div>
                              <span className={`text-[10px] ${theme === 'light' ? 'text-gray-500' : 'text-slate-500'}`}>Remaining</span>
                              <div className={`font-bold text-xs ${customer.remainingAtDeletion > 0 ? 'text-red-500' : (theme === 'light' ? 'text-blue-600' : 'text-blue-400')}`}>
                                ₹{customer.remainingAtDeletion.toFixed(2)}
                              </div>
                            </div>
                          </div>
                          
                          {/* Restore Button */}
                          <button
                            onClick={(e) => handleOpenRestoreModal(customer, e)}
                            className={`w-full mt-3 px-3 py-2 border rounded-lg text-xs font-semibold transition-all duration-200 flex items-center justify-center gap-2 shadow-lg ${theme === 'light' ? 'bg-gradient-to-r from-blue-50 to-cyan-50 hover:from-blue-100 hover:to-cyan-100 border-blue-400 hover:border-blue-500 text-blue-600 hover:text-blue-700 shadow-blue-200/20' : 'bg-gradient-to-r from-blue-500/20 to-cyan-500/20 hover:from-blue-500/30 hover:to-cyan-500/30 border-blue-500/50 hover:border-blue-400 text-blue-400 hover:text-blue-300 shadow-blue-500/10'}`}
                          >
                            <RotateCcw className="w-3.5 h-3.5" />
                            Restore to Active
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ) : !selectedDay ? (
              <div className="flex flex-col items-center justify-center py-20 text-center">
                <Calendar className={`w-24 h-24 mb-6 opacity-50 ${theme === 'light' ? 'text-gray-400' : 'text-slate-600'}`} />
                <h3 className="text-2xl font-bold text-slate-400 mb-2">No Day Selected</h3>
                <p className="text-slate-500 mb-6 max-w-md">
                  Please add a day from the left sidebar to start adding customers and managing transactions.
                </p>
                <Button 
                  onClick={() => setIsAddDayModalOpen(true)} 
                  className="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 shadow-lg shadow-cyan-500/20 border border-cyan-400/30"
                >
                  <Plus className="w-4 h-4 mr-2" />
                  Add Your First Day
                </Button>
              </div>
            ) : (
              // Active Customers View
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                {filteredCustomers.map((customer) => {
                  // Calculate remaining amount for this customer
                  const transKey = `transactions_${lineId}_${selectedDay}_${customer.id}`;
                  const chatKey = `chat_${lineId}_${selectedDay}_${customer.id}`;
                  const renewalKey = `renewals_${lineId}_${selectedDay}_${customer.id}`;
                  
                  const storedTrans = localStorage.getItem(transKey);
                  const storedChat = localStorage.getItem(chatKey);
                  const storedRenewals = localStorage.getItem(renewalKey);
                  
                  const transactions = storedTrans ? JSON.parse(storedTrans) : [];
                  const chatMessages = storedChat ? JSON.parse(storedChat) : [];
                  const renewals = storedRenewals ? JSON.parse(storedRenewals) : [];
                  
                  const totalPaid = [...transactions, ...chatMessages].reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                  
                  // Calculate total amount owed (initial amount + all renewals) - FIXED to match CustomerChat
                  const takenAmount = parseFloat(customer.takenAmount) || 0;
                  const totalRenewalAmount = renewals.reduce((sum, renewal) => sum + (parseFloat(renewal.takenAmount) || 0), 0);
                  const totalOwed = takenAmount + totalRenewalAmount;
                  
                  // Get the latest renewal for display purposes
                  const latestRenewal = renewals.length > 0 ? renewals[renewals.length - 1] : null;
                  const displayTakenAmount = latestRenewal ? parseFloat(latestRenewal.takenAmount) : parseFloat(customer.takenAmount);
                  const remainingAmount = totalOwed - totalPaid;
                  
                  return (
                    <div
                      key={customer.id}
                      onClick={() => navigate(`/customer?id=${customer.id}&day=${selectedDay}&lineId=${lineId}`)}
                      className={`backdrop-blur-xl rounded-xl p-3 shadow-lg border transition-all duration-300 cursor-pointer hover:scale-[1.01] group relative hover:z-50 ${theme === 'light' ? 'bg-white border-gray-200 hover:border-blue-400 hover:shadow-blue-200/40' : 'bg-gradient-to-br from-slate-800/40 to-slate-900/40 border-slate-700/50 hover:border-cyan-500/50 hover:shadow-cyan-500/20'}`}
                    >
                      {/* 3-Dot Menu */}
                      <div className="absolute top-2 right-2 z-10">
                        <DropdownMenu>
                          <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
                            <button className={`w-7 h-7 backdrop-blur-sm rounded-full flex items-center justify-center transition-colors border ${theme === 'light' ? 'bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-gray-900 border-gray-300' : 'bg-slate-700/50 hover:bg-slate-600/50 text-slate-400 hover:text-white border-slate-600'}`}>
                              <MoreVertical className="w-3.5 h-3.5" />
                            </button>
                          </DropdownMenuTrigger>
                          <DropdownMenuContent className={`${theme === 'light' ? 'bg-white border-gray-200 text-gray-800' : 'bg-[#1a1f2e] border-slate-700 text-slate-200'}`}>
                            <DropdownMenuItem
                              onClick={(e) => { e.stopPropagation(); handleOpenCustomerModal(customer); }}
                              className={`cursor-pointer ${theme === 'light' ? 'hover:bg-gray-100' : 'hover:bg-slate-800'}`}
                            >
                              <Edit className="w-4 h-4 mr-2" />
                              Edit
                            </DropdownMenuItem>
                            <DropdownMenuItem
                              onClick={(e) => handleOpenRenewalModal(customer, e)}
                              className={`cursor-pointer ${theme === 'light' ? 'text-blue-600 hover:text-blue-700 hover:bg-blue-50' : 'text-blue-400 hover:text-blue-300 hover:bg-slate-800'}`}
                            >
                              <RefreshCw className="w-4 h-4 mr-2" />
                              Renewal
                            </DropdownMenuItem>
                            <DropdownMenuItem
                              onClick={(e) => handleDeleteCustomer(customer, e)}
                              className={`cursor-pointer ${theme === 'light' ? 'text-red-600 hover:text-red-700 hover:bg-red-50' : 'text-red-400 hover:text-red-300 hover:bg-red-500/10'}`}
                            >
                              <Trash2 className="w-4 h-4 mr-2" />
                              Delete
                            </DropdownMenuItem>
                          </DropdownMenuContent>
                        </DropdownMenu>
                      </div>
                      
                      <div className="flex items-center space-x-3">
                        <div className="relative group/profile">
                          <div className={`w-12 h-12 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center text-white font-bold flex-shrink-0 shadow-lg ${theme === 'light' ? 'shadow-blue-200/40 border-blue-300' : 'shadow-cyan-500/20 border-cyan-400/30'} border`}>
                            {customer.profileImage ? (
                              <img src={customer.profileImage} alt="Profile" className="w-full h-full rounded-lg object-cover" />
                            ) : (
                              <UserIcon className="w-6 h-6" />
                            )}
                          </div>
                          
                          {/* Tooltip */}
                          <div className={`absolute left-full ml-2 top-0 w-64 border p-4 rounded-xl shadow-2xl opacity-0 invisible group-hover/profile:opacity-100 group-hover/profile:visible transition-all duration-200 z-50 text-xs space-y-1.5 backdrop-blur-xl ${theme === 'light' ? 'bg-white border-gray-200 text-gray-800' : 'bg-[#1a1f2e] border-slate-700 text-slate-200'}`}>
                            <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Name:</strong> {customer.name}</p>
                            <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>ID:</strong> {customer.id}</p>
                            <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Village:</strong> {customer.village}</p>
                            <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Phone:</strong> {customer.phone}</p>
                            <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Original Amount:</strong> ₹{latestRenewal ? latestRenewal.takenAmount : customer.takenAmount}</p>
                            <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Interest:</strong> {customer.interest}</p>
                            <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>PC:</strong> {customer.pc}</p>
                            <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Date:</strong> {customer.date}</p>
                            <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Weeks:</strong> {customer.weeks}</p>
                          </div>
                        </div>
                        
                        <div className="flex-1 min-w-0 pr-10">
                          <div className="flex items-center gap-2 mb-1">
                            <h4 className={`font-bold text-base truncate transition-colors ${theme === 'light' ? 'text-gray-800 group-hover:text-blue-600' : 'text-slate-200 group-hover:text-cyan-400'}`}>{customer.name}</h4>
                            {latestRenewal && (
                              <span className={`text-[9px] px-1.5 py-0.5 rounded border flex-shrink-0 ${theme === 'light' ? 'bg-blue-100 text-blue-600 border-blue-300' : 'bg-blue-500/20 text-blue-400 border-blue-500/30'}`}>R</span>
                            )}
                          </div>
                          <p className={`text-xs mb-2 ${theme === 'light' ? 'text-gray-600' : 'text-slate-400'}`}>ID: {customer.id}</p>
                          
                          {/* Taken Amount and Remaining Side by Side */}
                          <div className="grid grid-cols-2 gap-2 mb-1.5">
                            <div>
                              <span className={`text-[10px] uppercase tracking-wide ${theme === 'light' ? 'text-gray-500' : 'text-slate-500'}`}>Taken</span>
                              <div className={`font-bold text-sm ${theme === 'light' ? 'text-blue-600' : 'text-blue-400'}`}>
                                ₹{displayTakenAmount.toFixed(2)}
                              </div>
                            </div>
                            <div>
                              <span className={`text-[10px] uppercase tracking-wide ${theme === 'light' ? 'text-gray-500' : 'text-slate-500'}`}>Remaining</span>
                              <div className={`font-bold text-sm ${remainingAmount > 0 ? 'text-orange-500' : remainingAmount < 0 ? 'text-red-500' : (theme === 'light' ? 'text-blue-600' : 'text-blue-400')}`}>
                                ₹{remainingAmount.toFixed(2)}
                              </div>
                            </div>
                          </div>
                          
                          <p className={`text-[10px] px-2 py-0.5 rounded inline-block ${theme === 'light' ? 'text-gray-600 bg-gray-100' : 'text-slate-500 bg-slate-800/50'}`}>{customer.date}</p>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Add Day Modal */}
      <Dialog open={isAddDayModalOpen} onOpenChange={setIsAddDayModalOpen}>
        <DialogContent className={theme === 'light' ? 'bg-white border-slate-300 text-slate-800' : 'bg-[#1a1f2e] border-slate-700 text-slate-200'}>
          <DialogHeader>
            <DialogTitle className={theme === 'light' ? 'text-cyan-600' : 'text-cyan-400'}>Add New Day</DialogTitle>
          </DialogHeader>
          <div className="space-y-4 mt-4">
            <div>
              <Label className={theme === 'light' ? 'text-slate-700' : 'text-slate-300'}>Day Name (e.g., "2025-01-15" or "Monday Morning")</Label>
              <Input
                type="text"
                value={newDay}
                onChange={(e) => setNewDay(e.target.value)}
                placeholder="Enter day name or identifier"
                className={`mt-1 ${
                  theme === 'light'
                    ? 'bg-white border-slate-300 text-slate-800 placeholder:text-slate-400'
                    : 'bg-slate-800/50 border-slate-700 text-slate-200 placeholder:text-slate-500'
                }`}
              />
            </div>
            <Button onClick={handleAddDay} className="w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 shadow-lg shadow-cyan-500/20">
              Add Day
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Quick Transaction Modal */}
      <Dialog open={isQuickTransactionOpen} onOpenChange={setIsQuickTransactionOpen}>
        <DialogContent className={`max-w-3xl max-h-[90vh] overflow-y-auto shadow-2xl ${
          theme === 'light' 
            ? 'bg-gradient-to-br from-white via-slate-50 to-slate-100 border-slate-300 text-slate-800' 
            : 'bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 border-slate-600 text-slate-200'
        }`}>
          <DialogHeader>
            <DialogTitle className={`text-2xl pr-8 font-bold ${
              theme === 'light'
                ? 'text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-600'
                : 'text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400'
            }`}>
              Quick Transaction
            </DialogTitle>
            {selectedDay && (
              <div className={`text-sm font-normal px-3 py-1.5 rounded-full mt-2 inline-block ${
                theme === 'light'
                  ? 'bg-blue-100 text-blue-700 border border-blue-300'
                  : 'bg-blue-500/20 text-blue-300 border border-blue-400/40'
              }`}>
                Day: {selectedDay}
              </div>
            )}
          </DialogHeader>
          
          <div className="space-y-6 mt-4">
            {/* Universal Date Picker */}
            <div className={`rounded-xl p-5 border shadow-lg ${
              theme === 'light'
                ? 'bg-gradient-to-r from-blue-50 to-cyan-50 border-blue-200'
                : 'bg-gradient-to-r from-blue-900/20 to-cyan-900/20 border-blue-700/40'
            }`}>
              <div className="flex items-center space-x-3">
                <Calendar className={`w-6 h-6 ${theme === 'light' ? 'text-blue-600' : 'text-blue-400'}`} />
                <Label className={`text-sm font-semibold ${theme === 'light' ? 'text-slate-800' : 'text-white'}`}>
                  Universal Date (applies to all transactions)
                </Label>
                <Input
                  type="date"
                  value={universalDate}
                  onChange={(e) => setUniversalDate(e.target.value)}
                  className={`max-w-xs backdrop-blur-sm ${
                    theme === 'light'
                      ? 'bg-white border-blue-300 text-slate-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50'
                      : 'bg-white/10 border-blue-600/50 text-white focus:border-blue-400 focus:ring-2 focus:ring-blue-400/50 [&::-webkit-calendar-picker-indicator]:invert [&::-webkit-calendar-picker-indicator]:brightness-200 [&::-webkit-calendar-picker-indicator]:contrast-200 [&::-webkit-calendar-picker-indicator]:saturate-0 [&::-webkit-calendar-picker-indicator]:opacity-100'
                  }`}
                />
              </div>
            </div>

            {/* Input Form */}
            <div className={`rounded-xl p-5 border shadow-lg backdrop-blur-sm ${
              theme === 'light'
                ? 'bg-slate-50 border-slate-300'
                : 'bg-gradient-to-br from-slate-700/50 to-slate-800/50 border-slate-600'
            }`}>
              <div className="grid grid-cols-4 gap-3">
                <Input
                  placeholder="Customer ID"
                  value={quickTransaction.customerId}
                  onChange={(e) => setQuickTransaction({ ...quickTransaction, customerId: e.target.value })}
                  className={`backdrop-blur-sm ${
                    theme === 'light'
                      ? 'bg-white border-slate-300 text-slate-800 placeholder:text-slate-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50'
                      : 'bg-white/10 border-slate-500 text-white placeholder:text-slate-300 focus:border-blue-400 focus:ring-2 focus:ring-blue-400/50'
                  }`}
                  onKeyPress={(e) => e.key === 'Enter' && handleAddToTransactionList()}
                />
                <Input
                  placeholder="Name (auto-filled)"
                  value={customers.find(c => c.id === quickTransaction.customerId)?.name || ''}
                  readOnly
                  className={`backdrop-blur-sm ${
                    theme === 'light'
                      ? 'bg-slate-100 border-slate-300 text-slate-600'
                      : 'bg-white/5 border-slate-600 text-slate-200'
                  }`}
                />
                <Input
                  type="number"
                  placeholder="Amount"
                  value={quickTransaction.amount}
                  onChange={(e) => setQuickTransaction({ ...quickTransaction, amount: e.target.value })}
                  className={`backdrop-blur-sm ${
                    theme === 'light'
                      ? 'bg-white border-slate-300 text-slate-800 placeholder:text-slate-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50'
                      : 'bg-white/10 border-slate-500 text-white placeholder:text-slate-300 focus:border-blue-400 focus:ring-2 focus:ring-blue-400/50'
                  }`}
                  onKeyPress={(e) => e.key === 'Enter' && handleAddToTransactionList()}
                />
                <Button 
                  onClick={handleAddToTransactionList} 
                  className={`shadow-lg font-semibold ${
                    theme === 'light'
                      ? 'bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white border border-blue-500/30'
                      : 'bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white border border-blue-400/50'
                  }`}
                >
                  <Plus className="w-4 h-4 mr-2" />
                  Add
                </Button>
              </div>
            </div>

            {/* Transaction List */}
            <div>
              <h3 className={`font-semibold mb-3 text-lg ${theme === 'light' ? 'text-slate-800' : 'text-white'}`}>
                Transaction List ({transactionList.length})
              </h3>
              {transactionList.length === 0 ? (
                <div className={`text-center py-8 rounded-lg border border-dashed backdrop-blur-sm ${
                  theme === 'light'
                    ? 'text-slate-500 bg-slate-100 border-slate-300'
                    : 'text-slate-300 bg-slate-700/50 border-slate-500'
                }`}>
                  No transactions added yet
                </div>
              ) : (
                <div className="space-y-2 max-h-64 overflow-y-auto scrollbar-thin scrollbar-thumb-slate-500 scrollbar-track-transparent">
                  {transactionList.map((trans) => (
                    <div 
                      key={trans.tempId}
                      className={`flex items-center justify-between backdrop-blur-sm p-4 rounded-xl border transition-all ${
                        theme === 'light'
                          ? 'bg-white border-slate-200 hover:border-blue-400 hover:shadow-lg'
                          : 'bg-gradient-to-r from-slate-700/60 to-slate-800/60 border-slate-500 hover:border-blue-400/70 hover:shadow-lg hover:shadow-blue-500/20'
                      }`}
                    >
                      <div className="flex items-center space-x-4">
                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center font-bold shadow-lg ${
                          theme === 'light'
                            ? 'bg-gradient-to-br from-blue-500 to-cyan-500 text-white border border-blue-400/50'
                            : 'bg-gradient-to-br from-blue-500 to-cyan-500 text-white border border-blue-400/50'
                        }`}>
                          {trans.customerId.slice(-2)}
                        </div>
                        <div>
                          <p className={`font-semibold ${theme === 'light' ? 'text-slate-800' : 'text-white'}`}>
                            {trans.customerName}
                          </p>
                          <p className={`text-sm ${theme === 'light' ? 'text-slate-500' : 'text-slate-300'}`}>
                            ID: {trans.customerId}
                          </p>
                        </div>
                      </div>
                      <div className="flex items-center space-x-4">
                        <div className="text-right">
                          <p className={`font-bold text-lg ${theme === 'light' ? 'text-blue-600' : 'text-blue-400'}`}>
                            ₹{trans.amount}
                          </p>
                          <p className={`text-xs font-medium ${theme === 'light' ? 'text-slate-500' : 'text-slate-300'}`}>
                            {trans.date}
                          </p>
                        </div>
                        <Button
                          size="sm"
                          variant="ghost"
                          onClick={() => handleDeleteTransaction(trans.tempId)}
                          className={`${
                            theme === 'light'
                              ? 'text-red-600 hover:text-red-700 hover:bg-red-100 border border-red-300'
                              : 'text-red-400 hover:text-red-300 hover:bg-red-500/20 border border-red-500/30'
                          }`}
                        >
                          Delete
                        </Button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Action Buttons */}
            <div className={`flex space-x-3 pt-4 border-t ${theme === 'light' ? 'border-slate-300' : 'border-slate-600'}`}>
              <Button
                onClick={handleSaveTransactions}
                disabled={transactionList.length === 0}
                className={`flex-1 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed font-semibold ${
                  theme === 'light'
                    ? 'bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white border border-blue-500/30'
                    : 'bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white border border-blue-400/50'
                }`}
              >
                Save All Transactions
              </Button>
              <Button
                onClick={handleResetTransactions}
                variant="outline"
                className={`flex-1 font-semibold ${
                  theme === 'light'
                    ? 'border-slate-400 hover:bg-slate-100 text-slate-700 hover:border-slate-500'
                    : 'border-slate-500 hover:bg-slate-700 text-white hover:border-slate-400'
                }`}
              >
                Reset
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* Add/Edit Customer Modal */}
      <Dialog open={isCustomerModalOpen} onOpenChange={setIsCustomerModalOpen}>
        <DialogContent className={`max-w-2xl max-h-[90vh] overflow-y-auto ${theme === 'light' ? 'bg-white border-gray-200 text-gray-900' : 'bg-[#1a1f2e] border-slate-700 text-slate-200'}`}>
          <DialogHeader>
            <DialogTitle className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>{editingCustomer ? 'Edit Customer' : 'Add Customer'}</DialogTitle>
          </DialogHeader>
          <div className="space-y-4 mt-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label className={theme === 'light' ? 'text-gray-700' : 'text-slate-300'}>Customer ID *</Label>
                <Input 
                  value={customerForm.id} 
                  onChange={(e) => setCustomerForm({ ...customerForm, id: e.target.value })} 
                  disabled={!!editingCustomer} 
                  className={`disabled:opacity-50 ${theme === 'light' ? 'bg-gray-50 border-gray-300 text-gray-900' : 'bg-slate-800/50 border-slate-700 text-slate-200'}`}
                  placeholder="Auto-generated (editable)"
                />
              </div>
              <div>
                <Label className={theme === 'light' ? 'text-gray-700' : 'text-slate-300'}>Name *</Label>
                <Input 
                  value={customerForm.name} 
                  onChange={(e) => setCustomerForm({ ...customerForm, name: e.target.value })} 
                  className={theme === 'light' ? 'bg-gray-50 border-gray-300 text-gray-900' : 'bg-slate-800/50 border-slate-700 text-slate-200'}
                  placeholder="Enter customer name"
                />
              </div>
              <div>
                <Label className={theme === 'light' ? 'text-gray-700' : 'text-slate-300'}>Village</Label>
                <Input 
                  value={customerForm.village} 
                  onChange={(e) => setCustomerForm({ ...customerForm, village: e.target.value })} 
                  className={theme === 'light' ? 'bg-gray-50 border-gray-300 text-gray-900' : 'bg-slate-800/50 border-slate-700 text-slate-200'}
                  placeholder="Enter village name"
                />
              </div>
              <div>
                <Label className={theme === 'light' ? 'text-gray-700' : 'text-slate-300'}>Phone Number</Label>
                <Input 
                  type="tel"
                  value={customerForm.phone} 
                  onChange={(e) => {
                    const value = e.target.value.replace(/\D/g, '');
                    setCustomerForm({ ...customerForm, phone: value });
                  }} 
                  className={theme === 'light' ? 'bg-gray-50 border-gray-300 text-gray-900' : 'bg-slate-800/50 border-slate-700 text-slate-200'}
                  placeholder="Enter phone number"
                  maxLength="10"
                />
              </div>
              <div>
                <Label className={theme === 'light' ? 'text-gray-700' : 'text-slate-300'}>Amount *</Label>
                <Input 
                  type="number" 
                  value={customerForm.takenAmount} 
                  onChange={(e) => setCustomerForm({ ...customerForm, takenAmount: e.target.value })} 
                  className={theme === 'light' ? 'bg-gray-50 border-gray-300 text-gray-900' : 'bg-slate-800/50 border-slate-700 text-slate-200'}
                  placeholder="Enter amount"
                />
              </div>
              <div>
                <Label className={theme === 'light' ? 'text-gray-700' : 'text-slate-300'}>Interest</Label>
                <Input 
                  type="number" 
                  value={customerForm.interest} 
                  onChange={(e) => setCustomerForm({ ...customerForm, interest: e.target.value })} 
                  className={theme === 'light' ? 'bg-gray-50 border-gray-300 text-gray-900' : 'bg-slate-800/50 border-slate-700 text-slate-200'}
                  placeholder="Enter interest rate"
                />
              </div>
              <div>
                <Label className={theme === 'light' ? 'text-gray-700' : 'text-slate-300'}>PC</Label>
                <Input 
                  type="number" 
                  value={customerForm.pc} 
                  onChange={(e) => setCustomerForm({ ...customerForm, pc: e.target.value })} 
                  className={theme === 'light' ? 'bg-gray-50 border-gray-300 text-gray-900' : 'bg-slate-800/50 border-slate-700 text-slate-200'}
                  placeholder="Enter PC value"
                />
              </div>
              <div>
                <Label className={theme === 'light' ? 'text-gray-700' : 'text-slate-300'}>Date</Label>
                <Input 
                  type="date" 
                  value={customerForm.date} 
                  onChange={(e) => setCustomerForm({ ...customerForm, date: e.target.value })} 
                  className={theme === 'light' ? 'bg-gray-50 border-gray-300 text-gray-900' : 'bg-slate-800/50 border-slate-700 text-slate-200'}
                />
              </div>
              <div>
                <Label className={theme === 'light' ? 'text-gray-700' : 'text-slate-300'}>No. of Weeks</Label>
                <Input 
                  type="number" 
                  min="1" 
                  max="54" 
                  value={customerForm.weeks} 
                  onChange={(e) => setCustomerForm({ ...customerForm, weeks: e.target.value })} 
                  className={theme === 'light' ? 'bg-gray-50 border-gray-300 text-gray-900' : 'bg-slate-800/50 border-slate-700 text-slate-200'}
                  placeholder="Default: 12"
                />
              </div>
              <div>
                <Label className={`mb-2 block ${theme === 'light' ? 'text-gray-700' : 'text-slate-300'}`}>Profile Photo</Label>
                <label className={`flex items-center justify-center w-full px-4 py-2 border-2 border-dashed rounded-lg cursor-pointer transition-all ${
                  theme === 'light' 
                    ? 'bg-gray-50 border-gray-300 hover:bg-gray-100 hover:border-blue-400' 
                    : 'bg-slate-800/50 border-slate-600 hover:bg-slate-700/50 hover:border-cyan-500/50'
                }`}>
                  <input 
                    type="file" 
                    accept="image/*" 
                    capture="environment" 
                    onChange={handleProfileUpload} 
                    className="hidden" 
                  />
                  <div className={`flex items-center space-x-2 ${theme === 'light' ? 'text-gray-600' : 'text-slate-300'}`}>
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <span className="text-sm font-medium">Choose Photo</span>
                  </div>
                </label>
              </div>
            </div>
            {customerForm.profileImage && (
              <div className="flex justify-center">
                <img src={customerForm.profileImage} alt="Preview" className={`w-24 h-24 rounded-2xl object-cover border-2 shadow-lg ${
                  theme === 'light' ? 'border-blue-400 shadow-blue-200' : 'border-cyan-500/50 shadow-cyan-500/20'
                }`} />
              </div>
            )}
            <Button onClick={handleSaveCustomer} className={`w-full shadow-lg ${
              theme === 'light'
                ? 'bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 shadow-blue-500/20'
                : 'bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 shadow-cyan-500/20'
            }`}>
              {editingCustomer ? 'Update Customer' : 'Add Customer'}
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Renewal Modal */}
      <Dialog open={isRenewalModalOpen} onOpenChange={setIsRenewalModalOpen}>
        <DialogContent className={`max-w-xl ${
          theme === 'light' 
            ? 'bg-white border-slate-300 text-slate-800' 
            : 'bg-[#1a1f2e] border-slate-700 text-slate-200'
        }`}>
          <DialogHeader>
            <DialogTitle className={`flex items-center space-x-2 ${
              theme === 'light' ? 'text-blue-600' : 'text-blue-400'
            }`}>
              <RefreshCw className="w-5 h-5" />
              <span>Customer Renewal</span>
            </DialogTitle>
          </DialogHeader>
          {renewalCustomer && (
            <div className="space-y-4 mt-4">
              {/* Customer Info */}
              <div className={`rounded-lg p-4 border ${
                theme === 'light'
                  ? 'bg-blue-50 border-blue-200'
                  : 'bg-slate-800/50 border-slate-700'
              }`}>
                <div className="flex items-center space-x-3 mb-2">
                  <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center text-white font-bold">
                    {renewalCustomer.profileImage ? (
                      <img src={renewalCustomer.profileImage} alt="Profile" className="w-full h-full rounded-xl object-cover" />
                    ) : (
                      <UserIcon className="w-6 h-6" />
                    )}
                  </div>
                  <div>
                    <h4 className={`font-bold ${
                      theme === 'light' ? 'text-slate-800' : 'text-slate-200'
                    }`}>{renewalCustomer.name}</h4>
                    <p className={`text-xs ${
                      theme === 'light' ? 'text-slate-600' : 'text-slate-400'
                    }`}>ID: {renewalCustomer.id}</p>
                  </div>
                </div>
                <div className={`text-sm ${
                  theme === 'light' ? 'text-slate-700' : 'text-slate-300'
                }`}>
                  <p><span className={theme === 'light' ? 'text-slate-500' : 'text-slate-500'}>Village:</span> {renewalCustomer.village}</p>
                  <p><span className={theme === 'light' ? 'text-slate-500' : 'text-slate-500'}>Phone:</span> {renewalCustomer.phone}</p>
                </div>
              </div>

              {/* Renewal Form */}
              <div className="grid grid-cols-2 gap-4">
                <div className="col-span-2">
                  <Label className={theme === 'light' ? 'text-slate-700' : 'text-slate-300'}>Amount *</Label>
                  <Input 
                    type="number" 
                    value={renewalForm.takenAmount} 
                    onChange={(e) => setRenewalForm({ ...renewalForm, takenAmount: e.target.value })} 
                    placeholder="Enter renewal amount"
                    className={theme === 'light' 
                      ? 'bg-white border-slate-300 text-slate-800' 
                      : 'bg-slate-800/50 border-slate-700 text-slate-200'
                    } 
                  />
                </div>
                <div>
                  <Label className={theme === 'light' ? 'text-slate-700' : 'text-slate-300'}>Interest</Label>
                  <Input 
                    type="number" 
                    value={renewalForm.interest} 
                    onChange={(e) => setRenewalForm({ ...renewalForm, interest: e.target.value })} 
                    className={theme === 'light' 
                      ? 'bg-white border-slate-300 text-slate-800' 
                      : 'bg-slate-800/50 border-slate-700 text-slate-200'
                    } 
                    placeholder="Enter interest rate"
                  />
                </div>
                <div>
                  <Label className={theme === 'light' ? 'text-slate-700' : 'text-slate-300'}>PC</Label>
                  <Input 
                    type="number" 
                    value={renewalForm.pc} 
                    onChange={(e) => setRenewalForm({ ...renewalForm, pc: e.target.value })} 
                    className={theme === 'light' 
                      ? 'bg-white border-slate-300 text-slate-800' 
                      : 'bg-slate-800/50 border-slate-700 text-slate-200'
                    } 
                    placeholder="Enter PC value"
                  />
                </div>
                <div>
                  <Label className={theme === 'light' ? 'text-slate-700' : 'text-slate-300'}>Date</Label>
                  <Input 
                    type="date" 
                    value={renewalForm.date} 
                    onChange={(e) => setRenewalForm({ ...renewalForm, date: e.target.value })} 
                    className={theme === 'light' 
                      ? 'bg-white border-slate-300 text-slate-800' 
                      : 'bg-slate-800/50 border-slate-700 text-slate-200'
                    } 
                  />
                </div>
                <div>
                  <Label className={theme === 'light' ? 'text-slate-700' : 'text-slate-300'}>No. of Weeks</Label>
                  <Input 
                    type="number" 
                    min="1" 
                    max="54" 
                    value={renewalForm.weeks} 
                    onChange={(e) => setRenewalForm({ ...renewalForm, weeks: e.target.value })} 
                    className={theme === 'light' 
                      ? 'bg-white border-slate-300 text-slate-800' 
                      : 'bg-slate-800/50 border-slate-700 text-slate-200'
                    } 
                    placeholder="Default: 12"
                  />
                </div>
              </div>

              {/* Info Alert */}
              <div className={`rounded-lg p-3 flex items-start space-x-2 border ${
                theme === 'light'
                  ? 'bg-blue-50 border-blue-200'
                  : 'bg-blue-500/10 border-blue-500/30'
              }`}>
                <AlertCircle className={`w-4 h-4 mt-0.5 flex-shrink-0 ${
                  theme === 'light' ? 'text-blue-600' : 'text-blue-400'
                }`} />
                <p className={`text-xs ${
                  theme === 'light' ? 'text-blue-700' : 'text-blue-300'
                }`}>
                  The renewal amount will be deducted from your BF (Balance Forward) and will be displayed on the customer card.
                </p>
              </div>

              {/* Action Buttons */}
              <div className="flex space-x-2 pt-2">
                <Button 
                  onClick={handleSaveRenewal} 
                  className="flex-1 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 shadow-lg shadow-blue-500/20"
                >
                  <RefreshCw className="w-4 h-4 mr-2" />
                  Save Renewal
                </Button>
                <Button 
                  onClick={() => {
                    setIsRenewalModalOpen(false);
                    setRenewalCustomer(null);
                  }} 
                  variant="outline" 
                  className={theme === 'light'
                    ? 'flex-1 border-slate-300 text-slate-700 hover:bg-slate-100'
                    : 'flex-1 border-slate-600 text-slate-300 hover:bg-slate-800'
                  }
                >
                  Cancel
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* Delete Day Confirmation Modal */}
      <Dialog open={isDeleteDayModalOpen} onOpenChange={setIsDeleteDayModalOpen}>
        <DialogContent className={theme === 'light' ? 'bg-white border-slate-300 text-slate-800' : 'bg-[#1a1f2e] border-slate-700 text-slate-200'}>
          <DialogHeader>
            <DialogTitle className={theme === 'light' ? 'text-red-600' : 'text-red-400'}>Confirm Delete Day</DialogTitle>
          </DialogHeader>
          <div className="space-y-4 mt-4">
            <p className={theme === 'light' ? 'text-slate-700' : 'text-slate-300'}>
              Are you sure you want to delete <strong className={theme === 'light' ? 'text-red-600' : 'text-red-400'}>"{dayToDelete}"</strong>? This will also delete all customers and transactions for this day.
            </p>
            <div>
              <Label className={theme === 'light' ? 'text-slate-700' : 'text-slate-300'}>Type "delete" to confirm</Label>
              <Input
                type="text"
                value={deleteConfirmText}
                onChange={(e) => setDeleteConfirmText(e.target.value)}
                placeholder="Type delete"
                className={`mt-1 ${
                  theme === 'light'
                    ? 'bg-white border-slate-300 text-slate-800 placeholder:text-slate-400'
                    : 'bg-slate-800/50 border-slate-700 text-slate-200 placeholder:text-slate-500'
                }`}
              />
            </div>
            <div className="flex space-x-2">
              <Button 
                onClick={confirmDeleteDay} 
                className="flex-1 bg-gradient-to-r from-red-500 to-rose-500 hover:from-red-600 hover:to-rose-600 shadow-lg shadow-red-500/20"
                disabled={deleteConfirmText.toLowerCase() !== 'delete'}
              >
                Delete
              </Button>
              <Button 
                onClick={() => {
                  setIsDeleteDayModalOpen(false);
                  setDayToDelete(null);
                  setDeleteConfirmText('');
                }}
                variant="outline"
                className={theme === 'light' 
                  ? 'flex-1 border-slate-300 hover:bg-slate-100 text-slate-700' 
                  : 'flex-1 border-slate-700 hover:bg-slate-800 text-slate-300'
                }
              >
                Cancel
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* Delete Customer Confirmation Modal */}
      <Dialog open={isDeleteCustomerModalOpen} onOpenChange={setIsDeleteCustomerModalOpen}>
        <DialogContent className={theme === 'light' ? 'bg-white border-slate-300 text-slate-800' : 'bg-[#1a1f2e] border-slate-700 text-slate-200'}>
          <DialogHeader>
            <DialogTitle className={theme === 'light' ? 'text-red-600' : 'text-red-400'}>Confirm Delete Customer</DialogTitle>
          </DialogHeader>
          <div className="space-y-4 mt-4">
            <p className={theme === 'light' ? 'text-slate-700' : 'text-slate-300'}>
              Are you sure you want to move customer <strong className={theme === 'light' ? 'text-red-600' : 'text-red-400'}>"{customerToDelete?.name}"</strong> (ID: {customerToDelete?.id}) to the deleted section?
            </p>
            <div className={`p-3 rounded-lg border ${
              theme === 'light' 
                ? 'bg-blue-50 border-blue-200' 
                : 'bg-blue-500/10 border-blue-500/30'
            }`}>
              <p className={`text-xs ${theme === 'light' ? 'text-blue-700' : 'text-blue-300'}`}>
                📝 Note: Transaction history will be preserved for record keeping.
              </p>
            </div>
            <div>
              <Label className={theme === 'light' ? 'text-slate-700' : 'text-slate-300'}>Type "delete" to confirm</Label>
              <Input
                type="text"
                value={deleteConfirmText}
                onChange={(e) => setDeleteConfirmText(e.target.value)}
                placeholder="Type delete"
                className={`mt-1 ${
                  theme === 'light'
                    ? 'bg-white border-slate-300 text-slate-800 placeholder:text-slate-400'
                    : 'bg-slate-800/50 border-slate-700 text-slate-200 placeholder:text-slate-500'
                }`}
              />
            </div>
            <div className="flex space-x-2">
              <Button 
                onClick={confirmDeleteCustomer} 
                className="flex-1 bg-gradient-to-r from-red-500 to-rose-500 hover:from-red-600 hover:to-rose-600 shadow-lg shadow-red-500/20"
                disabled={deleteConfirmText.toLowerCase() !== 'delete'}
              >
                Delete
              </Button>
              <Button 
                onClick={() => {
                  setIsDeleteCustomerModalOpen(false);
                  setCustomerToDelete(null);
                  setDeleteConfirmText('');
                }}
                variant="outline"
                className={theme === 'light'
                  ? 'flex-1 border-slate-300 hover:bg-slate-100 text-slate-700'
                  : 'flex-1 border-slate-700 hover:bg-slate-800 text-slate-300'
                }
              >
                Cancel
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* Error Alert for Pending Amount */}
      <AlertDialog open={isErrorAlertOpen} onOpenChange={setIsErrorAlertOpen}>
        <AlertDialogContent className={theme === 'light' ? 'bg-white border-slate-300 text-slate-800' : 'bg-[#1a1f2e] border-slate-700 text-slate-200'}>
          <AlertDialogHeader>
            <AlertDialogTitle className={theme === 'light' ? 'text-red-600' : 'text-red-400'}>Cannot Delete Customer</AlertDialogTitle>
            <AlertDialogDescription className={`text-base ${theme === 'light' ? 'text-slate-700' : 'text-slate-300'}`}>
              {deleteCustomerError}
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogAction onClick={() => setIsErrorAlertOpen(false)} className="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white">
              OK
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

      {/* Restore Customer Modal */}
      <Dialog open={isRestoreModalOpen} onOpenChange={setIsRestoreModalOpen}>
        <DialogContent className={`max-w-md ${
          theme === 'light'
            ? 'bg-white border-slate-300 text-slate-800'
            : 'bg-[#1a1f2e] border-slate-700 text-slate-200'
        }`}>
          <DialogHeader>
            <DialogTitle className={`text-xl font-bold ${
              theme === 'light'
                ? 'text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-600'
                : 'text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400'
            }`}>
              Restore Customer to Active
            </DialogTitle>
          </DialogHeader>
          
          {customerToRestore && (
            <div className="space-y-4">
              {/* Customer Info */}
              <div className={`p-3 rounded-lg border ${
                theme === 'light'
                  ? 'bg-blue-50 border-blue-200'
                  : 'bg-slate-800/50 border-slate-700'
              }`}>
                <p className={`text-sm mb-1 ${
                  theme === 'light' ? 'text-slate-600' : 'text-slate-400'
                }`}>Restoring Customer:</p>
                <p className={`font-bold ${
                  theme === 'light' ? 'text-cyan-600' : 'text-cyan-400'
                }`}>{customerToRestore.name}</p>
                <p className={`text-xs ${
                  theme === 'light' ? 'text-slate-500' : 'text-slate-500'
                }`}>Old ID: {customerToRestore.id} (Will be changed)</p>
              </div>
              
              {/* New ID */}
              <div>
                <Label htmlFor="newId" className={
                  theme === 'light' ? 'text-slate-700' : 'text-slate-300'
                }>New Customer ID *</Label>
                <Input
                  id="newId"
                  value={restoreForm.newId}
                  onChange={(e) => setRestoreForm({ ...restoreForm, newId: e.target.value })}
                  className={`mt-1 ${
                    theme === 'light'
                      ? 'bg-white border-slate-300 text-slate-800'
                      : 'bg-slate-800/50 border-slate-700 text-slate-200'
                  }`}
                  placeholder="Enter new ID"
                />
              </div>

              {/* Renewal Details */}
              <div className={`pt-3 border-t ${
                theme === 'light' ? 'border-slate-200' : 'border-slate-700'
              }`}>
                <p className={`text-sm font-semibold mb-3 ${
                  theme === 'light' ? 'text-blue-600' : 'text-blue-400'
                }`}>New Loan Details</p>
                
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <Label htmlFor="takenAmount" className={`text-xs ${
                      theme === 'light' ? 'text-slate-700' : 'text-slate-300'
                    }`}>Taken Amount *</Label>
                    <Input
                      id="takenAmount"
                      type="number"
                      value={restoreForm.takenAmount}
                      onChange={(e) => setRestoreForm({ ...restoreForm, takenAmount: e.target.value })}
                      className={`mt-1 ${
                        theme === 'light'
                          ? 'bg-white border-slate-300 text-slate-800'
                          : 'bg-slate-800/50 border-slate-700 text-slate-200'
                      }`}
                      placeholder="Amount"
                    />
                  </div>
                  <div>
                    <Label htmlFor="interest" className={`text-xs ${
                      theme === 'light' ? 'text-slate-700' : 'text-slate-300'
                    }`}>Interest</Label>
                    <Input
                      id="interest"
                      value={restoreForm.interest}
                      onChange={(e) => setRestoreForm({ ...restoreForm, interest: e.target.value })}
                      className={`mt-1 ${
                        theme === 'light'
                          ? 'bg-white border-slate-300 text-slate-800'
                          : 'bg-slate-800/50 border-slate-700 text-slate-200'
                      }`}
                      placeholder="Interest"
                    />
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-3 mt-3">
                  <div>
                    <Label htmlFor="pc" className={`text-xs ${
                      theme === 'light' ? 'text-slate-700' : 'text-slate-300'
                    }`}>PC</Label>
                    <Input
                      id="pc"
                      value={restoreForm.pc}
                      onChange={(e) => setRestoreForm({ ...restoreForm, pc: e.target.value })}
                      className={`mt-1 ${
                        theme === 'light'
                          ? 'bg-white border-slate-300 text-slate-800'
                          : 'bg-slate-800/50 border-slate-700 text-slate-200'
                      }`}
                      placeholder="PC"
                    />
                  </div>
                  <div>
                    <Label htmlFor="weeks" className={`text-xs ${
                      theme === 'light' ? 'text-slate-700' : 'text-slate-300'
                    }`}>Weeks</Label>
                    <Input
                      id="weeks"
                      type="number"
                      value={restoreForm.weeks}
                      onChange={(e) => setRestoreForm({ ...restoreForm, weeks: e.target.value })}
                      className={`mt-1 ${
                        theme === 'light'
                          ? 'bg-white border-slate-300 text-slate-800'
                          : 'bg-slate-800/50 border-slate-700 text-slate-200'
                      }`}
                      placeholder="Weeks"
                    />
                  </div>
                </div>

                <div className="mt-3">
                  <Label htmlFor="date" className={`text-xs ${
                    theme === 'light' ? 'text-slate-700' : 'text-slate-300'
                  }`}>Date</Label>
                  <Input
                    id="date"
                    type="date"
                    value={restoreForm.date}
                    onChange={(e) => setRestoreForm({ ...restoreForm, date: e.target.value })}
                    className={`mt-1 ${
                      theme === 'light'
                        ? 'bg-white border-slate-300 text-slate-800'
                        : 'bg-slate-800/50 border-slate-700 text-slate-200'
                    }`}
                  />
                </div>
              </div>
            </div>
          )}

          <div className="flex justify-end gap-3 pt-4">
            <Button
              onClick={() => setIsRestoreModalOpen(false)}
              variant="outline"
              className={theme === 'light'
                ? 'border-slate-300 text-slate-700 hover:bg-slate-100'
                : 'border-slate-700 text-slate-300 hover:bg-slate-800'
              }
            >
              Cancel
            </Button>
            <Button
              onClick={handleRestoreCustomer}
              className="bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white shadow-lg shadow-blue-500/20"
            >
              <RotateCcw className="w-4 h-4 mr-2" />
              Restore Customer
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Success Modal */}
      <AlertDialog open={isSuccessModalOpen} onOpenChange={setIsSuccessModalOpen}>
        <AlertDialogContent className={`shadow-2xl max-w-md ${
          theme === 'light'
            ? 'bg-gradient-to-br from-white to-blue-50 border-blue-300 text-slate-800 shadow-blue-300/30'
            : 'bg-gradient-to-br from-[#1a1f2e] to-[#0f1419] border-blue-500/50 text-slate-200 shadow-blue-500/20'
        }`}>
          <AlertDialogHeader>
            <div className="flex flex-col items-center justify-center space-y-4 py-4">
              <div className="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center animate-pulse">
                <CheckCircle className="w-10 h-10 text-white" />
              </div>
              <AlertDialogTitle className={`text-2xl font-bold text-transparent bg-clip-text text-center ${
                theme === 'light'
                  ? 'bg-gradient-to-r from-blue-600 to-cyan-600'
                  : 'bg-gradient-to-r from-blue-400 to-cyan-400'
              }`}>
                Success!
              </AlertDialogTitle>
              <AlertDialogDescription className={`text-base text-center leading-relaxed ${
                theme === 'light' ? 'text-slate-700' : 'text-slate-300'
              }`}>
                {successMessage}
              </AlertDialogDescription>
            </div>
          </AlertDialogHeader>
          <AlertDialogFooter className="flex justify-center">
            <AlertDialogAction 
              onClick={() => setIsSuccessModalOpen(false)} 
              className="bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white px-8 py-2 rounded-lg shadow-lg shadow-blue-500/30 transition-all"
            >
              OK
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

      {/* Print Modal */}
      <Dialog open={isPrintModalOpen} onOpenChange={setIsPrintModalOpen}>
        <DialogContent className={`max-w-3xl ${
          theme === 'light' ? 'bg-white text-slate-800' : 'bg-slate-800 text-slate-200'
        }`}>
          <DialogHeader>
            <DialogTitle className={`text-xl font-bold ${
              theme === 'light' ? 'text-blue-700' : 'text-blue-400'
            }`}>
              Print Options
            </DialogTitle>
          </DialogHeader>
          
          <div className="space-y-4 py-4">
            {/* Print Type Selection - Side by Side */}
            <div>
              <Label className={`text-sm font-semibold mb-3 block ${
                theme === 'light' ? 'text-slate-700' : 'text-slate-300'
              }`}>
                Select Print Type
              </Label>
              <div className="grid grid-cols-2 gap-4">
                <label className={`flex items-center gap-3 p-4 rounded-lg cursor-pointer border-2 transition-all ${
                  printType === 'transactions'
                    ? theme === 'light'
                      ? 'bg-blue-50 border-blue-500'
                      : 'bg-blue-500/20 border-blue-500'
                    : theme === 'light'
                      ? 'bg-gray-50 border-gray-200 hover:border-gray-300'
                      : 'bg-slate-700/30 border-slate-600 hover:border-slate-500'
                }`}>
                  <input
                    type="radio"
                    name="printType"
                    value="transactions"
                    checked={printType === 'transactions'}
                    onChange={(e) => setPrintType(e.target.value)}
                    className="w-4 h-4 flex-shrink-0"
                  />
                  <div className="flex-1">
                    <div className={`font-semibold text-sm ${
                      theme === 'light' ? 'text-slate-800' : 'text-slate-200'
                    }`}>
                      Customer Transactions
                    </div>
                    <div className={`text-xs mt-1 ${
                      theme === 'light' ? 'text-slate-600' : 'text-slate-400'
                    }`}>
                      Print transactions for a specific customer
                    </div>
                  </div>
                </label>
                
                <label className={`flex items-center gap-3 p-4 rounded-lg cursor-pointer border-2 transition-all ${
                  printType === 'summary'
                    ? theme === 'light'
                      ? 'bg-blue-50 border-blue-500'
                      : 'bg-blue-500/20 border-blue-500'
                    : theme === 'light'
                      ? 'bg-gray-50 border-gray-200 hover:border-gray-300'
                      : 'bg-slate-700/30 border-slate-600 hover:border-slate-500'
                }`}>
                  <input
                    type="radio"
                    name="printType"
                    value="summary"
                    checked={printType === 'summary'}
                    onChange={(e) => setPrintType(e.target.value)}
                    className="w-4 h-4 flex-shrink-0"
                  />
                  <div className="flex-1">
                    <div className={`font-semibold text-sm ${
                      theme === 'light' ? 'text-slate-800' : 'text-slate-200'
                    }`}>
                      Customer Summary
                    </div>
                    <div className={`text-xs mt-1 ${
                      theme === 'light' ? 'text-slate-600' : 'text-slate-400'
                    }`}>
                      Print summary of all customers
                    </div>
                  </div>
                </label>
              </div>
            </div>

            {/* Customer ID and Name - Side by Side (only for transactions) */}
            {printType === 'transactions' && (
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label htmlFor="printCustomerId" className={`text-sm font-semibold ${
                    theme === 'light' ? 'text-slate-700' : 'text-slate-300'
                  }`}>
                    Customer ID
                  </Label>
                  <Input
                    id="printCustomerId"
                    value={printCustomerId}
                    onChange={(e) => {
                      const id = e.target.value;
                      setPrintCustomerId(id);
                      
                      // Auto-fill customer name
                      if (id.trim()) {
                        const foundCustomer = customers.find(c => c.id === id.trim());
                        if (foundCustomer) {
                          setPrintCustomerName(foundCustomer.name);
                        } else {
                          setPrintCustomerName('Customer not found');
                        }
                      } else {
                        setPrintCustomerName('');
                      }
                    }}
                    placeholder="Enter Customer ID"
                    className={`mt-2 ${
                      theme === 'light'
                        ? 'bg-white border-gray-300'
                        : 'bg-slate-700 border-slate-600'
                    }`}
                  />
                </div>
                
                <div>
                  <Label htmlFor="printCustomerName" className={`text-sm font-semibold ${
                    theme === 'light' ? 'text-slate-700' : 'text-slate-300'
                  }`}>
                    Customer Name
                  </Label>
                  <Input
                    id="printCustomerName"
                    value={printCustomerName}
                    disabled
                    placeholder="Auto-filled"
                    className={`mt-2 ${
                      theme === 'light'
                        ? 'bg-gray-100 border-gray-300 text-gray-600 cursor-not-allowed'
                        : 'bg-slate-800 border-slate-700 text-slate-400 cursor-not-allowed'
                    }`}
                  />
                </div>
              </div>
            )}

            {/* Day Selection (only for summary) - Popover Dropdown */}
            {printType === 'summary' && (
              <div>
                <Label className={`text-sm font-semibold mb-2 block ${
                  theme === 'light' ? 'text-slate-700' : 'text-slate-300'
                }`}>
                  Select Days to Include
                </Label>
                
                <Popover>
                  <PopoverTrigger asChild>
                    <Button
                      variant="outline"
                      className={`w-full justify-between ${
                        theme === 'light'
                          ? 'bg-white border-gray-300 hover:bg-gray-50'
                          : 'bg-slate-700 border-slate-600 hover:bg-slate-600'
                      }`}
                    >
                      <span>
                        {selectAllDays || selectedDaysForPrint.length === days.length
                          ? `Select all (${days.length})` 
                          : selectedDaysForPrint.length === 1
                            ? selectedDaysForPrint[0]
                            : `${selectedDaysForPrint.length} Days Selected`}
                      </span>
                      <ChevronDown className="ml-2 h-4 w-4 opacity-50" />
                    </Button>
                  </PopoverTrigger>
                  <PopoverContent className={`w-72 p-2 max-h-80 overflow-y-auto ${
                    theme === 'light' ? 'bg-white' : 'bg-slate-800'
                  }`} align="start">
                    <div className="space-y-1">
                      {/* Select All Option */}
                      <label
                        className={`flex items-center gap-2 px-3 py-2 rounded cursor-pointer transition-colors border-b ${
                          theme === 'light'
                            ? 'hover:bg-blue-50 border-slate-200'
                            : 'hover:bg-slate-700 border-slate-700'
                        }`}
                      >
                        <input
                          type="checkbox"
                          checked={selectAllDays || selectedDaysForPrint.length === days.length}
                          onChange={(e) => {
                            if (e.target.checked) {
                              // Select all days
                              setSelectAllDays(true);
                              setSelectedDaysForPrint(days);
                            } else {
                              // Deselect all days
                              setSelectAllDays(false);
                              setSelectedDaysForPrint([]);
                            }
                          }}
                          className="w-4 h-4 rounded border-2 border-blue-500"
                        />
                        <span className={`text-sm font-bold ${
                          theme === 'light' ? 'text-blue-700' : 'text-blue-400'
                        }`}>
                          Select All ({days.length})
                        </span>
                      </label>
                      
                      {/* Individual Days - Always Clickable */}
                      {days.map((day) => (
                        <label
                          key={day}
                          className={`flex items-center gap-2 px-3 py-2 rounded cursor-pointer transition-colors ${
                            theme === 'light'
                              ? 'hover:bg-blue-50'
                              : 'hover:bg-slate-700'
                          }`}
                        >
                          <input
                            type="checkbox"
                            checked={selectAllDays || selectedDaysForPrint.includes(day)}
                            onChange={(e) => {
                              let newSelected;
                              if (e.target.checked) {
                                // Add this day
                                newSelected = [...selectedDaysForPrint, day];
                                // If all days are now selected, set selectAllDays to true
                                if (newSelected.length === days.length) {
                                  setSelectAllDays(true);
                                  setSelectedDaysForPrint(days);
                                } else {
                                  setSelectAllDays(false);
                                  setSelectedDaysForPrint(newSelected);
                                }
                              } else {
                                // Remove this day
                                setSelectAllDays(false);
                                newSelected = selectedDaysForPrint.filter(d => d !== day);
                                setSelectedDaysForPrint(newSelected);
                              }
                            }}
                            className="w-4 h-4 rounded border-2 border-blue-500"
                          />
                          <span className={`text-sm font-medium ${
                            theme === 'light' ? 'text-slate-700' : 'text-slate-200'
                          }`}>
                            {day}
                          </span>
                        </label>
                      ))}
                    </div>
                  </PopoverContent>
                </Popover>
                
                <div className={`mt-2 text-xs ${
                  theme === 'light' ? 'text-slate-600' : 'text-slate-400'
                }`}>
                  {selectAllDays || selectedDaysForPrint.length === days.length ? (
                    <span className="flex items-center gap-1">
                      <span className="text-green-600">✓</span> All {days.length} days will be included
                    </span>
                  ) : selectedDaysForPrint.length === 0 ? (
                    <span className="text-orange-600">⚠ No days selected</span>
                  ) : (
                    <span>
                      {selectedDaysForPrint.length} day{selectedDaysForPrint.length !== 1 ? 's' : ''} selected
                    </span>
                  )}
                </div>
              </div>
            )}
          </div>

          <div className="flex gap-3 justify-end">
            <Button
              variant="outline"
              onClick={() => setIsPrintModalOpen(false)}
              className={theme === 'light' ? 'border-gray-300' : 'border-slate-600'}
            >
              Cancel
            </Button>
            <Button
              onClick={handlePrint}
              className={`${
                theme === 'light'
                  ? 'bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600'
                  : 'bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600'
              } text-white shadow-lg`}
            >
              <Printer className="w-4 h-4 mr-2" />
              Generate PDF
            </Button>
          </div>
        </DialogContent>
      </Dialog>
    </>
  );
};

export default EntryDetails;