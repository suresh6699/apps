import React, { useState, useEffect } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { Button } from './ui/button';
import { Input } from './ui/input';
import { Label } from './ui/label';
import { ArrowLeft, Calendar, User, CalendarIcon, TrendingUp, TrendingDown, ArrowDownCircle, ArrowUpCircle, ChevronDown, IndianRupee, Printer } from 'lucide-react';
import { Popover, PopoverContent, PopoverTrigger } from './ui/popover';
import { Calendar as CalendarComponent } from './ui/calendar';
import { Tabs, TabsList, TabsTrigger, TabsContent } from './ui/tabs';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from './ui/select';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from './ui/dialog';
import { format } from 'date-fns';
import { useTheme } from '../App';
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';

const Collections = () => {
  const { theme } = useTheme();
  const navigate = useNavigate();
  const [searchParams, setSearchParams] = useSearchParams();
  const lineId = searchParams.get('id');
  const dayParam = searchParams.get('day');

  const [line, setLine] = useState(null);
  const [allTransactions, setAllTransactions] = useState([]);
  const [goingTransactions, setGoingTransactions] = useState([]);
  const [totalAmount, setTotalAmount] = useState(0);
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [filteredTransactions, setFilteredTransactions] = useState([]);
  const [filteredGoingTransactions, setFilteredGoingTransactions] = useState([]);
  const [filteredTotal, setFilteredTotal] = useState(0);
  const [filteredGoingTotal, setFilteredGoingTotal] = useState(0);
  const [datesWithTransactions, setDatesWithTransactions] = useState([]);
  const [calendarOpen, setCalendarOpen] = useState(false);
  const [activeTab, setActiveTab] = useState('all');
  const [bfAmount, setBfAmount] = useState(0);
  const [availableDays, setAvailableDays] = useState([]);
  const [selectedDays, setSelectedDays] = useState([]);
  const [showAllDays, setShowAllDays] = useState(false);
  
  // Print modal states
  const [isPrintModalOpen, setIsPrintModalOpen] = useState(false);
  const [printFromDate, setPrintFromDate] = useState(new Date());
  const [printToDate, setPrintToDate] = useState(new Date());
  const [isFromDateOpen, setIsFromDateOpen] = useState(false);
  const [isToDateOpen, setIsToDateOpen] = useState(false);
  const [printSelectedDays, setPrintSelectedDays] = useState([]);
  const [printDateMode, setPrintDateMode] = useState('single'); // 'single' or 'range'
  const [printSingleDate, setPrintSingleDate] = useState(new Date());
  const [isSingleDateOpen, setIsSingleDateOpen] = useState(false);

  useEffect(() => {
    if (!lineId) return;
    
    // Load line details
    const stored = localStorage.getItem('entries');
    const lines = stored ? JSON.parse(stored) : [];
    const foundLine = lines.find(l => l.id === lineId);
    setLine(foundLine);

    // Load available days for this line - with mockDays fallback for line id='1'
    const storedDays = localStorage.getItem(`days_${lineId}`);
    let loadedDays;
    if (storedDays) {
      loadedDays = JSON.parse(storedDays);
    } else if (lineId === '1') {
      // Use mockDays as fallback for line id='1' (same as EntryDetails.jsx)
      loadedDays = ['2025-01-15'];
    } else {
      loadedDays = [];
    }
    
    setAvailableDays(loadedDays);
    
    // Initialize selected days from URL parameter
    if (dayParam) {
      const daysFromUrl = dayParam.split(',');
      setSelectedDays(daysFromUrl);
    } else {
      // Default to first day
      setSelectedDays(loadedDays.length > 0 ? [loadedDays[0]] : []);
    }

    // Load BF for this line
    const bfKey = `bf_${lineId}`;
    const storedBf = localStorage.getItem(bfKey);
    setBfAmount(storedBf ? parseFloat(storedBf) : (foundLine?.amount || 0));
  }, [lineId, dayParam]);

  useEffect(() => {
    if (!lineId || selectedDays.length === 0) return;

    // Load transactions for ALL selected days
    const transactions = [];
    const transactionDatesSet = new Set();
    const customerMap = new Map();
    
    // Loop through all selected days
    selectedDays.forEach(day => {
      // Load customers for each selected day (ACTIVE customers)
      const customerKey = `customers_${lineId}_${day}`;
      const storedCustomers = localStorage.getItem(customerKey);
      if (storedCustomers) {
        try {
          const customers = JSON.parse(storedCustomers);
          if (Array.isArray(customers)) {
            customers.forEach(customer => {
              if (customer && customer.id) {
                // Use compound key: day + customerId to avoid overwriting customers with same ID from different days
                const compoundKey = `${day}_${customer.id}`;
                customerMap.set(compoundKey, { ...customer, day: day });
              }
            });
          }
        } catch (e) {
          console.error('Error parsing customers:', e);
        }
      }
    });
    
    // ALSO load DELETED customers to show their names in transactions
    const deletedKey = `deleted_customers_${lineId}`;
    const storedDeleted = localStorage.getItem(deletedKey);
    if (storedDeleted) {
      try {
        const deletedCustomers = JSON.parse(storedDeleted);
        if (Array.isArray(deletedCustomers)) {
          deletedCustomers.forEach(customer => {
            if (customer && customer.id && customer.deletedFrom) {
              // IMPORTANT: Use unique key with timestamp to avoid collision with active customers with same ID
              // This ensures deleted customer's creation transaction shows up even if active customer has same ID
              const compoundKey = customer.deletionTimestamp 
                ? `${customer.deletedFrom}_${customer.id}_deleted_${customer.deletionTimestamp}`
                : `${customer.deletedFrom}_${customer.id}_deleted`;
              
              customerMap.set(compoundKey, { 
                ...customer, 
                day: customer.deletedFrom,
                isDeleted: true 
              });
              console.log(`Added DELETED customer to map: ${customer.name} (${customer.id}) with key: ${compoundKey}`);
            }
          });
        }
      } catch (e) {
        console.error('Error parsing deleted customers:', e);
      }
    }
    
    console.log('Total customers loaded:', customerMap.size);
    
    // Process transaction keys for ALL selected days
    const allKeys = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key) {
        allKeys.push(key);
      }
    }
    
    selectedDays.forEach(day => {
      let transCountForDay = 0;
      allKeys.forEach(key => {
        // Load transactions for this specific day from both 'transactions_' and 'chat_' keys
        if (key.startsWith(`transactions_${lineId}_${day}_`) || key.startsWith(`chat_${lineId}_${day}_`)) {
          try {
            const storedTrans = localStorage.getItem(key);
            if (storedTrans) {
              const customerTransactions = JSON.parse(storedTrans);
              
              // Extract customer ID from key
              const keyParts = key.split('_');
              const customerId = keyParts[keyParts.length - 1];
              
              // Get customer from map using compound key
              const compoundKey = `${day}_${customerId}`;
              const customer = customerMap.get(compoundKey);
              
              if (Array.isArray(customerTransactions)) {
                customerTransactions.forEach(trans => {
                  if (trans) {
                    transactions.push({
                      ...trans,
                      customerId: customerId,
                      // Use stored customerName if available, otherwise look up from customer map
                      customerName: trans.customerName || (customer ? customer.name : `Customer ${customerId}`),
                      day: day,
                      isDeleted: customer ? customer.isDeleted : false,
                      // Include full customer details for hover tooltip
                      customerDetails: customer || null
                    });
                    transCountForDay++;
                    
                    if (trans.date) {
                      transactionDatesSet.add(trans.date);
                    }
                  }
                });
              }
            }
          } catch (e) {
            console.error('Error parsing transactions from key:', key, e);
          }
        }
      });
      console.log(`Day ${day}: Loaded ${transCountForDay} incoming transactions`);
    });
    
    // LOAD ARCHIVED TRANSACTIONS from deleted customers
    if (storedDeleted) {
      try {
        const deletedCustomers = JSON.parse(storedDeleted);
        if (Array.isArray(deletedCustomers)) {
          console.log(`ðŸ“¦ Total deleted customers in DB: ${deletedCustomers.length}`);
          let archivedLoadCount = 0;
          deletedCustomers.forEach(deletedCustomer => {
            if (deletedCustomer && deletedCustomer.deletionTimestamp) {
              const dayMatch = selectedDays.includes(deletedCustomer.deletedFrom);
              console.log(`ðŸ” Checking deleted customer: ${deletedCustomer.name} (ID: ${deletedCustomer.id}), Day: ${deletedCustomer.deletedFrom}, isRestored: ${deletedCustomer.isRestored || false}, Day Match: ${dayMatch}`);
              
              if (dayMatch) {
                const day = deletedCustomer.deletedFrom;
                const timestamp = deletedCustomer.deletionTimestamp;
                
                // Load archived transactions
                const archivedTransKey = `transactions_deleted_${lineId}_${day}_${deletedCustomer.id}_${timestamp}`;
                const archivedChatKey = `chat_deleted_${lineId}_${day}_${deletedCustomer.id}_${timestamp}`;
                
                console.log(`ðŸ“¥ Loading archived transactions for ${deletedCustomer.name}:`, {
                  transKey: archivedTransKey,
                  chatKey: archivedChatKey
                });
                
                [archivedTransKey, archivedChatKey].forEach(key => {
                  const storedArchivedTrans = localStorage.getItem(key);
                  if (storedArchivedTrans) {
                    try {
                      const archivedTransactions = JSON.parse(storedArchivedTrans);
                      if (Array.isArray(archivedTransactions)) {
                        archivedLoadCount += archivedTransactions.length;
                        archivedTransactions.forEach(trans => {
                          if (trans) {
                            transactions.push({
                              ...trans,
                              customerId: deletedCustomer.id,
                              customerName: trans.customerName || deletedCustomer.name,
                              day: day,
                              isDeleted: true,
                              // Include full customer details for hover tooltip
                              customerDetails: deletedCustomer || null
                            });
                            
                            if (trans.date) {
                              transactionDatesSet.add(trans.date);
                            }
                          }
                        });
                        console.log(`âœ… Loaded ${archivedTransactions.length} archived transactions from ${key}`);
                      }
                    } catch (e) {
                      console.error('Error parsing archived transactions:', e);
                    }
                  } else {
                    console.log(`âš ï¸ No archived data found at ${key}`);
                  }
                });
              }
            }
          });
          console.log(`ðŸ“Š Total archived transactions loaded: ${archivedLoadCount}`);
        }
      } catch (e) {
        console.error('Error loading archived transactions:', e);
      }
    }

    // Sort by day order (according to availableDays), then by date within each day
    transactions.sort((a, b) => {
      // First, sort by day order in availableDays
      const dayIndexA = availableDays.indexOf(a.day);
      const dayIndexB = availableDays.indexOf(b.day);
      
      if (dayIndexA !== dayIndexB) {
        return dayIndexA - dayIndexB; // Sort by day order
      }
      
      // If same day, sort by date (most recent first)
      const dateA = new Date(a.date);
      const dateB = new Date(b.date);
      return dateB - dateA;
    });
    
    setAllTransactions(transactions);
    
    // Load "going" transactions (money going away from BF) for ALL selected days
    const goingTrans = [];
    
    // 1. Customer creation amounts
    if (customerMap.size > 0) {
      customerMap.forEach((customer, compoundKey) => {
        if (customer && customer.takenAmount && customer.date) {
          const customerDay = customer.day;
          console.log(`Customer creation: ${customer.name} (${customer.id}) - Day: ${customerDay}, Amount: ${customer.takenAmount}, Date: ${customer.date}`);
          goingTrans.push({
            id: `customer_creation_${compoundKey}`,
            customerId: customer.id,
            customerName: customer.name,
            amount: parseFloat(customer.takenAmount),
            date: customer.date,
            type: 'customer_creation',
            comment: 'Customer Created',
            day: customerDay,
            isDeleted: customer.isDeleted || false,
            // Include full customer details for hover tooltip
            customerDetails: customer || null
          });
          transactionDatesSet.add(customer.date);
        }
      });
    }
    
    console.log(`Total customer creation transactions: ${goingTrans.length}`);
    
    console.log(`Total customer creation transactions: ${goingTrans.length}`);
    
    // 2. Renewals for ALL selected days
    selectedDays.forEach(day => {
      let renewalCountForDay = 0;
      allKeys.forEach(key => {
        if (key.startsWith(`renewals_${lineId}_${day}_`)) {
          try {
            const storedRenewals = localStorage.getItem(key);
            if (storedRenewals) {
              const renewals = JSON.parse(storedRenewals);
              const keyParts = key.split('_');
              const customerId = keyParts[keyParts.length - 1];
              
              // Get customer from map using compound key
              const compoundKey = `${day}_${customerId}`;
              const customer = customerMap.get(compoundKey);
              
              if (Array.isArray(renewals)) {
                renewals.forEach(renewal => {
                  if (renewal && renewal.takenAmount && renewal.date) {
                    goingTrans.push({
                      id: renewal.id || `renewal_${Date.now()}`,
                      customerId: customerId,
                      // Use stored customerName if available, otherwise look up from customer map
                      customerName: renewal.customerName || (customer ? customer.name : `Customer ${customerId}`),
                      amount: parseFloat(renewal.takenAmount),
                      date: renewal.date,
                      type: 'renewal',
                      comment: 'Renewal',
                      day: day,
                      isDeleted: customer ? customer.isDeleted : false,
                      // Include full customer details for hover tooltip
                      customerDetails: customer || null
                    });
                    transactionDatesSet.add(renewal.date);
                    renewalCountForDay++;
                  }
                });
              }
            }
          } catch (e) {
            console.error('Error parsing renewals from key:', key, e);
          }
        }
      });
      console.log(`Day ${day}: Loaded ${renewalCountForDay} renewal transactions`);
    });
    
    // LOAD ARCHIVED RENEWALS from deleted customers
    if (storedDeleted) {
      try {
        const deletedCustomers = JSON.parse(storedDeleted);
        if (Array.isArray(deletedCustomers)) {
          console.log(`ðŸ”„ Checking archived renewals for ${deletedCustomers.length} deleted customers...`);
          deletedCustomers.forEach(deletedCustomer => {
            if (deletedCustomer && deletedCustomer.deletionTimestamp && selectedDays.includes(deletedCustomer.deletedFrom)) {
              const day = deletedCustomer.deletedFrom;
              const timestamp = deletedCustomer.deletionTimestamp;
              
              // Load archived renewals
              const archivedRenewalKey = `renewals_deleted_${lineId}_${day}_${deletedCustomer.id}_${timestamp}`;
              const storedArchivedRenewals = localStorage.getItem(archivedRenewalKey);
              
              console.log(`Checking archived renewals for ${deletedCustomer.name} at key: ${archivedRenewalKey}`);
              
              if (storedArchivedRenewals) {
                try {
                  const archivedRenewals = JSON.parse(storedArchivedRenewals);
                  if (Array.isArray(archivedRenewals)) {
                    console.log(`âœ… Found ${archivedRenewals.length} archived renewals for ${deletedCustomer.name}`);
                    archivedRenewals.forEach(renewal => {
                      if (renewal && renewal.takenAmount && renewal.date) {
                        goingTrans.push({
                          id: renewal.id || `renewal_archived_${Date.now()}`,
                          customerId: deletedCustomer.id,
                          customerName: renewal.customerName || deletedCustomer.name,
                          amount: parseFloat(renewal.takenAmount),
                          date: renewal.date,
                          type: 'renewal',
                          comment: 'Renewal',
                          day: day,
                          isDeleted: true,
                          // Include full customer details for hover tooltip
                          customerDetails: deletedCustomer || null
                        });
                        transactionDatesSet.add(renewal.date);
                      }
                    });
                  }
                } catch (e) {
                  console.error('Error parsing archived renewals:', e);
                }
              }
            }
          });
        }
      } catch (e) {
        console.error('Error loading archived renewals:', e);
      }
    }
    
    // Sort going transactions by day order (according to availableDays), then by date within each day
    goingTrans.sort((a, b) => {
      // First, sort by day order in availableDays
      const dayIndexA = availableDays.indexOf(a.day);
      const dayIndexB = availableDays.indexOf(b.day);
      
      if (dayIndexA !== dayIndexB) {
        return dayIndexA - dayIndexB; // Sort by day order
      }
      
      // If same day, sort by date (most recent first)
      const dateA = new Date(a.date);
      const dateB = new Date(b.date);
      return dateB - dateA;
    });
    
    setGoingTransactions(goingTrans);
    console.log(`Total going transactions: ${goingTrans.length}`);
    console.log(`Total incoming transactions: ${transactions.length}`);
    console.log('===========================');
    
    // Convert dates to Date objects for calendar highlighting
    const highlightedDates = Array.from(transactionDatesSet).map(dateStr => new Date(dateStr + 'T00:00:00'));
    setDatesWithTransactions(highlightedDates);
    
    // Calculate total
    const total = transactions.reduce((sum, trans) => sum + (parseFloat(trans.amount) || 0), 0);
    setTotalAmount(total);
  }, [lineId, selectedDays]);

  // Filter transactions by selected date
  useEffect(() => {
    const selectedDateStr = format(selectedDate, 'yyyy-MM-dd');
    
    // Filter incoming transactions
    const filtered = allTransactions.filter(trans => trans.date === selectedDateStr);
    setFilteredTransactions(filtered);
    const total = filtered.reduce((sum, trans) => sum + (trans.amount || 0), 0);
    setFilteredTotal(total);
    
    // Filter going transactions
    const filteredGoing = goingTransactions.filter(trans => trans.date === selectedDateStr);
    setFilteredGoingTransactions(filteredGoing);
    const goingTotal = filteredGoing.reduce((sum, trans) => sum + (trans.amount || 0), 0);
    setFilteredGoingTotal(goingTotal);
  }, [allTransactions, goingTransactions, selectedDate]);

  // Print function to generate PDF
  const handlePrint = () => {
    // Determine date range based on mode
    let fromDateStr, toDateStr;
    if (printDateMode === 'single') {
      fromDateStr = toDateStr = format(printSingleDate, 'yyyy-MM-dd');
    } else {
      fromDateStr = format(printFromDate, 'yyyy-MM-dd');
      toDateStr = format(printToDate, 'yyyy-MM-dd');
    }
    
    // Load transactions for PRINT - independent of main dropdown selection
    // Load ALL transactions for printSelectedDays only
    const printIncomingTrans = [];
    const printGoingTrans = [];
    const customerMap = new Map();
    
    // Get all localStorage keys once
    const allKeys = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key) {
        allKeys.push(key);
      }
    }
    
    // Loop through printSelectedDays to load their data
    printSelectedDays.forEach(day => {
      // Load customers for this day (ACTIVE customers)
      const customerKey = `customers_${lineId}_${day}`;
      const storedCustomers = localStorage.getItem(customerKey);
      if (storedCustomers) {
        try {
          const customers = JSON.parse(storedCustomers);
          if (Array.isArray(customers)) {
            customers.forEach(customer => {
              if (customer && customer.id) {
                const compoundKey = `${day}_${customer.id}`;
                customerMap.set(compoundKey, { ...customer, day: day });
              }
            });
          }
        } catch (e) {
          console.error('Error loading customers for print:', e);
        }
      }
    });
    
    // ALSO load DELETED customers for print
    const deletedKey = `deleted_customers_${lineId}`;
    const storedDeleted = localStorage.getItem(deletedKey);
    if (storedDeleted) {
      try {
        const deletedCustomers = JSON.parse(storedDeleted);
        if (Array.isArray(deletedCustomers)) {
          deletedCustomers.forEach(customer => {
            if (customer && customer.id && customer.deletedFrom) {
              // IMPORTANT: Use unique key with timestamp to avoid collision with active customers
              const compoundKey = customer.deletionTimestamp 
                ? `${customer.deletedFrom}_${customer.id}_deleted_${customer.deletionTimestamp}`
                : `${customer.deletedFrom}_${customer.id}_deleted`;
              
              customerMap.set(compoundKey, { 
                ...customer, 
                day: customer.deletedFrom,
                isDeleted: true 
              });
            }
          });
        }
      } catch (e) {
        console.error('Error loading deleted customers for print:', e);
      }
    }
    
    // Load incoming transactions for selected days
    printSelectedDays.forEach(day => {
      // Load incoming transactions for this day
      allKeys.forEach(key => {
        if (key.startsWith(`transactions_${lineId}_${day}_`) || key.startsWith(`chat_${lineId}_${day}_`)) {
          try {
            const storedTrans = localStorage.getItem(key);
            if (storedTrans) {
              const customerTransactions = JSON.parse(storedTrans);
              const keyParts = key.split('_');
              const customerId = keyParts[keyParts.length - 1];
              const compoundKey = `${day}_${customerId}`;
              const customer = customerMap.get(compoundKey);
              
              if (Array.isArray(customerTransactions)) {
                customerTransactions.forEach(trans => {
                  if (trans) {
                    const transDate = trans.date;
                    if (transDate >= fromDateStr && transDate <= toDateStr) {
                      printIncomingTrans.push({
                        ...trans,
                        customerId: customerId,
                        // Use stored customerName if available, otherwise look up from customer map
                        customerName: trans.customerName || (customer ? customer.name : `Customer ${customerId}`),
                        day: day,
                        isDeleted: customer ? customer.isDeleted : false
                      });
                    }
                  }
                });
              }
            }
          } catch (e) {
            console.error('Error loading transactions for print:', e);
          }
        }
      });
    });
    
    // Load going transactions (customer creation + renewals) for printSelectedDays
    // 1. Customer creations
    customerMap.forEach((customer, compoundKey) => {
      if (customer && customer.takenAmount && customer.date) {
        const transDate = customer.date;
        if (transDate >= fromDateStr && transDate <= toDateStr) {
          printGoingTrans.push({
            id: `customer_creation_${compoundKey}`,
            customerId: customer.id,
            customerName: customer.name,
            amount: parseFloat(customer.takenAmount),
            date: customer.date,
            type: 'customer_creation',
            comment: 'Customer Created',
            day: customer.day,
            isDeleted: customer.isDeleted || false
          });
        }
      }
    });
    
    // 2. Renewals for printSelectedDays
    printSelectedDays.forEach(day => {
      allKeys.forEach(key => {
        if (key.startsWith(`renewals_${lineId}_${day}_`)) {
          try {
            const storedRenewals = localStorage.getItem(key);
            if (storedRenewals) {
              const renewals = JSON.parse(storedRenewals);
              const keyParts = key.split('_');
              const customerId = keyParts[keyParts.length - 1];
              const compoundKey = `${day}_${customerId}`;
              const customer = customerMap.get(compoundKey);
              
              if (Array.isArray(renewals)) {
                renewals.forEach(renewal => {
                  if (renewal && renewal.takenAmount && renewal.date) {
                    const transDate = renewal.date;
                    if (transDate >= fromDateStr && transDate <= toDateStr) {
                      printGoingTrans.push({
                        id: renewal.id || `renewal_${Date.now()}`,
                        customerId: customerId,
                        // Use stored customerName if available, otherwise look up from customer map
                        customerName: renewal.customerName || (customer ? customer.name : `Customer ${customerId}`),
                        amount: parseFloat(renewal.takenAmount),
                        date: renewal.date,
                        type: 'renewal',
                        comment: 'Renewal',
                        day: day,
                        isDeleted: customer ? customer.isDeleted : false
                      });
                    }
                  }
                });
              }
            }
          } catch (e) {
            console.error('Error loading renewals for print:', e);
          }
        }
      });
    });
    
    // LOAD ARCHIVED TRANSACTIONS for PRINT (reuse storedDeleted from above)
    if (storedDeleted) {
      try {
        const deletedCustomers = JSON.parse(storedDeleted);
        if (Array.isArray(deletedCustomers)) {
          deletedCustomers.forEach(deletedCustomer => {
            if (deletedCustomer && deletedCustomer.deletionTimestamp && printSelectedDays.includes(deletedCustomer.deletedFrom)) {
              const day = deletedCustomer.deletedFrom;
              const timestamp = deletedCustomer.deletionTimestamp;
              
              // Load archived incoming transactions (transactions + chat)
              const archivedTransKey = `transactions_deleted_${lineId}_${day}_${deletedCustomer.id}_${timestamp}`;
              const archivedChatKey = `chat_deleted_${lineId}_${day}_${deletedCustomer.id}_${timestamp}`;
              
              [archivedTransKey, archivedChatKey].forEach(key => {
                const storedArchivedTrans = localStorage.getItem(key);
                if (storedArchivedTrans) {
                  try {
                    const archivedTransactions = JSON.parse(storedArchivedTrans);
                    if (Array.isArray(archivedTransactions)) {
                      archivedTransactions.forEach(trans => {
                        if (trans) {
                          const transDate = trans.date;
                          if (transDate >= fromDateStr && transDate <= toDateStr) {
                            printIncomingTrans.push({
                              ...trans,
                              customerId: deletedCustomer.id,
                              customerName: trans.customerName || deletedCustomer.name,
                              day: day,
                              isDeleted: true
                            });
                          }
                        }
                      });
                    }
                  } catch (e) {
                    console.error('Error parsing archived transactions for print:', e);
                  }
                }
              });
              
              // Load archived renewals
              const archivedRenewalKey = `renewals_deleted_${lineId}_${day}_${deletedCustomer.id}_${timestamp}`;
              const storedArchivedRenewals = localStorage.getItem(archivedRenewalKey);
              
              if (storedArchivedRenewals) {
                try {
                  const archivedRenewals = JSON.parse(storedArchivedRenewals);
                  if (Array.isArray(archivedRenewals)) {
                    archivedRenewals.forEach(renewal => {
                      if (renewal && renewal.takenAmount && renewal.date) {
                        const transDate = renewal.date;
                        if (transDate >= fromDateStr && transDate <= toDateStr) {
                          printGoingTrans.push({
                            id: renewal.id || `renewal_archived_${Date.now()}`,
                            customerId: deletedCustomer.id,
                            customerName: renewal.customerName || deletedCustomer.name,
                            amount: parseFloat(renewal.takenAmount),
                            date: renewal.date,
                            type: 'renewal',
                            comment: 'Renewal',
                            day: day,
                            isDeleted: true
                          });
                        }
                      }
                    });
                  }
                } catch (e) {
                  console.error('Error parsing archived renewals for print:', e);
                }
              }
              
              // Add customer creation transaction for deleted customer (going)
              if (deletedCustomer.takenAmount && deletedCustomer.date) {
                const transDate = deletedCustomer.date;
                if (transDate >= fromDateStr && transDate <= toDateStr) {
                  printGoingTrans.push({
                    id: `customer_creation_deleted_${deletedCustomer.id}_${timestamp}`,
                    customerId: deletedCustomer.id,
                    customerName: deletedCustomer.name,
                    amount: parseFloat(deletedCustomer.takenAmount),
                    date: deletedCustomer.date,
                    type: 'customer_creation',
                    comment: 'Customer Created',
                    day: day,
                    isDeleted: true
                  });
                }
              }
            }
          });
        }
      } catch (e) {
        console.error('Error loading archived data for print:', e);
      }
    }
    
    // Calculate totals
    const incomingTotal = printIncomingTrans.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
    const goingTotal = printGoingTrans.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
    const netFlow = incomingTotal - goingTotal;
    
    // Create PDF
    const doc = new jsPDF();
    
    // Helper function to add header section
    const addHeaderSection = (dayLabel, goingTrans, incomingTrans) => {
      const sectionGoingTotal = goingTrans.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
      const sectionIncomingTotal = incomingTrans.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
      const sectionNetFlow = sectionIncomingTotal - sectionGoingTotal;
      
      // Set Arial font globally
      doc.setFont('helvetica', 'normal');
      
      // Enhanced Header - Clean and Professional
      // Main blue header background
      doc.setFillColor(59, 130, 246);
      doc.rect(0, 0, 210, 40, 'F');
      
      // Title
      doc.setFontSize(24);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(255, 255, 255);
      doc.text('COLLECTIONS STATEMENT', 105, 16, { align: 'center' });
      
      // Decorative lines
      doc.setDrawColor(255, 255, 255);
      doc.setLineWidth(0.8);
      doc.line(35, 22, 175, 22);
      
      // Bottom info bar with white background boxes
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      
      // Left box background - increased height for better centering
      doc.setFillColor(255, 255, 255);
      doc.roundedRect(14, 26, 88, 9, 1.5, 1.5, 'F');
      
      // Right box background - increased height for better centering
      doc.roundedRect(108, 26, 88, 9, 1.5, 1.5, 'F');
      
      // Text in boxes - vertically centered
      doc.setTextColor(59, 130, 246);
      doc.setFont('helvetica', 'bold');
      doc.text(`BF: Rs.${bfAmount.toFixed(2)}`, 58, 31.5, { align: 'center' });
      doc.text(`Generated: ${format(new Date(), 'dd MMM yyyy HH:mm')}`, 152, 31.5, { align: 'center' });
      
      // Reset text color to black for rest of document
      doc.setTextColor(0, 0, 0);
      
      // Info section with two columns
      let yPos = 48;
      
      // Left Column - Line Details Box
      const leftBoxX = 14;
      const leftBoxY = yPos;
      const leftBoxWidth = 90;
      const leftBoxHeight = 32;
      
      // Line Details background
      doc.setFillColor(240, 248, 255);
      doc.setDrawColor(59, 130, 246);
      doc.setLineWidth(0.5);
      doc.roundedRect(leftBoxX, leftBoxY, leftBoxWidth, leftBoxHeight, 2, 2, 'FD');
      
      // Line Details content - All BOLD
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.text('Line Details:', leftBoxX + 4, leftBoxY + 7);
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      doc.text(`Line: ${line?.name || 'Unknown'}`, leftBoxX + 4, leftBoxY + 13);
      doc.text(`Day: ${dayLabel}`, leftBoxX + 4, leftBoxY + 19);
      const periodText = printDateMode === 'single'
        ? format(printSingleDate, 'dd MMM yyyy')
        : `${format(printFromDate, 'dd MMM yyyy')} - ${format(printToDate, 'dd MMM yyyy')}`;
      doc.text(`Period: ${periodText}`, leftBoxX + 4, leftBoxY + 25);
      
      // Right Column - Summary Box
      const summaryX = 110;
      const summaryY = yPos;
      const summaryWidth = 86;
      const summaryHeight = 32;
      
      // Summary background
      doc.setFillColor(240, 248, 255);
      doc.setDrawColor(59, 130, 246);
      doc.setLineWidth(0.5);
      doc.roundedRect(summaryX, summaryY, summaryWidth, summaryHeight, 2, 2, 'FD');
      
      // Summary content - All BOLD
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.text('Summary:', summaryX + 4, summaryY + 7);
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      doc.setTextColor(22, 163, 74);
      doc.text(`Incoming:`, summaryX + 4, summaryY + 13);
      doc.text(`Rs.${sectionIncomingTotal.toFixed(2)}`, summaryX + 82, summaryY + 13, { align: 'right' });
      
      doc.setTextColor(220, 38, 38);
      doc.text(`Going:`, summaryX + 4, summaryY + 19);
      doc.text(`Rs.${sectionGoingTotal.toFixed(2)}`, summaryX + 82, summaryY + 19, { align: 'right' });
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(sectionNetFlow >= 0 ? 22 : 220, sectionNetFlow >= 0 ? 163 : 38, sectionNetFlow >= 0 ? 74 : 38);
      doc.text(`Net Flow:`, summaryX + 4, summaryY + 26);
      doc.text(`Rs.${sectionNetFlow.toFixed(2)}`, summaryX + 82, summaryY + 26, { align: 'right' });
      
      // Reset text color
      doc.setTextColor(0, 0, 0);
      
      return 88; // Return starting Y position for content
    };
    
    // Helper function to add transactions tables
    const addTransactionsTables = (goingTrans, incomingTrans, startY) => {
      let yPos = startY;
      
      // Going Transactions Table
      if (goingTrans.length > 0) {
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(13);
        doc.setTextColor(220, 38, 38);
        doc.text('Going Transactions', 14, yPos);
        doc.setTextColor(0, 0, 0);
        yPos += 5;
        
        autoTable(doc, {
          startY: yPos,
          head: [['Date', 'Customer', 'ID', 'Amount']],
          body: goingTrans.map(trans => {
            let customerNameWithType = trans.customerName || 'Unknown';
            // Add transaction type
            if (trans.type === 'renewal') {
              customerNameWithType += ' (R)';
            } else if (trans.type === 'customer_creation') {
              customerNameWithType += ' (N)';
            } else if (trans.type === 'restore') {
              customerNameWithType += ' (RS)';
            }
            // Add deleted indicator at the end
            if (trans.isDeleted) {
              customerNameWithType += ' [D]';
            }
            
            return [
              trans.date,
              customerNameWithType,
              trans.customerId,
              `-Rs.${trans.amount.toFixed(2)}`
            ];
          }),
          theme: 'striped',
          headStyles: { 
            fillColor: [220, 38, 38], 
            textColor: 255, 
            fontStyle: 'bold', 
            font: 'helvetica',
            fontSize: 10,
            halign: 'center'
          },
          styles: { 
            fontSize: 9.5, 
            font: 'helvetica',
            fontStyle: 'bold',
            halign: 'center'
          },
          margin: { left: 14, right: 14 },
          tableWidth: 'auto',
          columnStyles: {
            0: { cellWidth: 35, fontStyle: 'bold', halign: 'center' },
            1: { cellWidth: 80, fontStyle: 'bold', halign: 'center' },
            2: { cellWidth: 32, fontStyle: 'bold', halign: 'center' },
            3: { cellWidth: 35, halign: 'center', fontStyle: 'bold' }
          }
        });
        
        yPos = doc.lastAutoTable.finalY + 10;
      }
      
      // Incoming Transactions Table
      if (incomingTrans.length > 0) {
        if (yPos > 250) {
          doc.addPage();
          yPos = 20;
        }
        
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(13);
        doc.setTextColor(59, 130, 246);
        doc.text('Incoming Transactions', 14, yPos);
        doc.setTextColor(0, 0, 0);
        yPos += 5;
        
        autoTable(doc, {
          startY: yPos,
          head: [['Date', 'Customer', 'ID', 'Amount']],
          body: incomingTrans.map(trans => {
            let customerName = trans.customerName || 'Unknown';
            // Add deleted indicator at the end
            if (trans.isDeleted) {
              customerName += ' [D]';
            }
            
            return [
              trans.date,
              customerName,
              trans.customerId,
              `+Rs.${(trans.amount || 0).toFixed(2)}`
            ];
          }),
          theme: 'striped',
          headStyles: { 
            fillColor: [59, 130, 246], 
            textColor: 255, 
            fontStyle: 'bold', 
            font: 'helvetica',
            fontSize: 10,
            halign: 'center'
          },
          styles: { 
            fontSize: 9.5, 
            font: 'helvetica',
            fontStyle: 'bold',
            halign: 'center'
          },
          margin: { left: 14, right: 14 },
          tableWidth: 'auto',
          columnStyles: {
            0: { cellWidth: 35, fontStyle: 'bold', halign: 'center' },
            1: { cellWidth: 80, fontStyle: 'bold', halign: 'center' },
            2: { cellWidth: 32, fontStyle: 'bold', halign: 'center' },
            3: { cellWidth: 35, halign: 'center', fontStyle: 'bold' }
          }
        });
      }
    };
    
    // SECTION 1: ALL DATA (Combined for all selected days)
    const daysText = printSelectedDays.length === availableDays.length 
      ? 'All Days' 
      : printSelectedDays.join(', ');
    
    addHeaderSection(daysText, printGoingTrans, printIncomingTrans);
    addTransactionsTables(printGoingTrans, printIncomingTrans, 88);
    
    // SECTION 2 onwards: Individual day breakdown (one section per selected day)
    // Always show individual breakdown if there's data for multiple days
    if (printSelectedDays.length >= 1) {
      printSelectedDays.forEach((dayName) => {
        // Filter transactions for this specific day
        const dayGoingTrans = printGoingTrans.filter(t => t.day === dayName);
        const dayIncomingTrans = printIncomingTrans.filter(t => t.day === dayName);
        
        // Skip if no transactions for this day
        if (dayGoingTrans.length === 0 && dayIncomingTrans.length === 0) {
          return;
        }
        
        // Add new page for each individual day
        doc.addPage();
        
        // Add header section for this specific day
        addHeaderSection(dayName, dayGoingTrans, dayIncomingTrans);
        
        // Add transaction tables for this specific day
        addTransactionsTables(dayGoingTrans, dayIncomingTrans, 88);
      });
    }
    
    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      
      // Footer line
      doc.setDrawColor(200, 200, 200);
      doc.setLineWidth(0.3);
      doc.line(14, 282, 196, 282);
      
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(100, 100, 100);
      doc.text(`Page ${i} of ${pageCount}`, 105, 287, { align: 'center' });
      doc.text('Generated by Collections System', 14, 287);
      doc.setTextColor(0, 0, 0);
    }
    
    // Save PDF
    const fileName = `Collections_${line?.name || 'Statement'}_${format(printFromDate, 'ddMMMyyyy')}_${format(printToDate, 'ddMMMyyyy')}.pdf`;
    doc.save(fileName);
    
    setIsPrintModalOpen(false);
  };

  if (!line) return (
    <div className={`min-h-screen flex items-center justify-center ${
      theme === 'light' ? 'bg-white text-slate-800' : 'bg-slate-900 text-white'
    }`}>
      Loading...
    </div>
  );

  return (
    <div className={`min-h-screen ${
      theme === 'light' 
        ? 'bg-slate-50' 
        : 'bg-slate-900'
    }`}>
      {/* BRAND NEW HEADER - COMPACT & ALIGNED */}
      <header className={`sticky top-0 z-20 border-b shadow-md backdrop-blur-xl ${
        theme === 'light'
          ? 'trading-bg border-slate-200'
          : 'bg-slate-900/95 border-slate-700'
      }`}>
        {/* Chart bars for trading visualization */}
        {theme === 'light' && (
          <>
            <div className="chart-bars">
              <div className="chart-bar"></div>
              <div className="chart-bar"></div>
              <div className="chart-bar"></div>
              <div className="chart-bar"></div>
              <div className="chart-bar"></div>
              <div className="chart-bar"></div>
              <div className="chart-bar"></div>
              <div className="chart-bar"></div>
            </div>
            <div className="chart-dots">
              <div className="chart-dot"></div>
              <div className="chart-dot"></div>
              <div className="chart-dot"></div>
              <div className="chart-dot"></div>
              <div className="chart-dot"></div>
            </div>
          </>
        )}
        <div className="container mx-auto px-4 py-3 relative z-10">
          {/* Back Button - Absolutely positioned and centered */}
          <Button 
            onClick={() => navigate(-1)} 
            variant="ghost" 
            size="icon"
            className={`absolute left-4 top-1/2 -translate-y-1/2 h-10 w-10 rounded-full flex-shrink-0 shadow-md transition-all hover:shadow-lg z-20 ${
              theme === 'light'
                ? 'bg-white/80 hover:bg-white border-2 border-slate-300 hover:border-slate-400 text-slate-700 hover:text-slate-900'
                : 'hover:bg-slate-800'
            }`}
          >
            <ArrowLeft className="h-5 w-5" />
          </Button>

          {/* Top Row with absolute centered BF Badge */}
          <div className="relative flex items-center justify-between gap-4 mb-2">
            {/* Left: Title (with Main Line below) - with padding for back button */}
            <div className="flex items-center gap-3 pl-14">
              <div className="flex flex-col gap-1">
                <h1 className={`text-2xl md:text-3xl font-bold ${
                  theme === 'light'
                    ? 'text-slate-800'
                    : 'text-blue-400'
                } whitespace-nowrap leading-none`}>
                  Collections
                </h1>
                
                <span className={`inline-block self-start px-2.5 py-0.5 rounded-md text-xs font-semibold ${
                  theme === 'light'
                    ? 'bg-blue-100 text-blue-700 border border-blue-200'
                    : 'bg-blue-900/30 text-blue-400 border border-blue-700'
                }`}>
                  {line?.name || 'Unknown'}
                </span>
              </div>
            </div>

            {/* Center: BF Badge (absolute positioned) */}
            <div className={`hidden md:inline-flex absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 items-center gap-2 px-5 py-2 rounded-full shadow-lg transition-all hover:shadow-xl ${
              theme === 'light'
                ? 'bg-gradient-to-r from-emerald-50 via-white to-emerald-50 border-2 border-emerald-300'
                : 'bg-slate-800/50 border border-slate-700'
            }`}>
              <span className="text-base">ðŸ’¼</span>
              <span className={`text-xs font-semibold uppercase tracking-wider ${
                theme === 'light' ? 'text-emerald-700' : 'text-slate-400'
              }`}>
                BF
              </span>
              <span className={`text-lg font-bold ${
                theme === 'light'
                  ? 'text-emerald-900'
                  : 'text-blue-400'
              }`}>
                â‚¹{bfAmount.toFixed(2)}
              </span>
            </div>

            {/* Right: Day selector + Date picker */}
            <div className="flex items-center gap-3">
              {/* Day multiselect - SECOND */}
              <Popover>
                <PopoverTrigger asChild>
                  <Button
                    variant="outline"
                    className={`h-10 w-auto min-w-32 max-w-48 text-sm font-semibold shadow-md transition-all hover:shadow-lg ${
                      theme === 'light'
                        ? 'bg-gradient-to-br from-blue-50 to-white border-2 border-blue-300 text-blue-900 hover:from-blue-100 hover:to-white hover:border-blue-400'
                        : 'bg-slate-800 border-slate-600'
                    }`}
                  >
                    <ChevronDown className="h-4 w-4 mr-2" />
                    <span className="truncate">
                      {selectedDays.length === 0 
                        ? 'Select Days' 
                        : selectedDays.length === 1 
                          ? selectedDays[0] 
                          : `${selectedDays.length} Days`}
                    </span>
                  </Button>
                </PopoverTrigger>
                <PopoverContent className={`w-56 p-2 ${
                  theme === 'light' ? 'bg-white' : 'bg-slate-800'
                }`} align="end">
                  <div className="space-y-1">
                    {/* Select All Option */}
                    {availableDays.length > 0 && (
                      <label
                        className={`flex items-center gap-2 px-3 py-2 rounded cursor-pointer transition-colors border-b ${
                          theme === 'light'
                            ? 'hover:bg-amber-50 border-slate-200'
                            : 'hover:bg-slate-700 border-slate-700'
                        }`}
                      >
                        <input
                          type="checkbox"
                          checked={selectedDays.length === availableDays.length}
                          onChange={(e) => {
                            if (e.target.checked) {
                              // Select all days
                              setSelectedDays(availableDays);
                              setShowAllDays(true);
                              setSearchParams({ id: lineId, day: availableDays.join(',') }, { replace: true });
                            } else {
                              // Deselect all - reset to first day
                              const firstDay = availableDays[0];
                              setSelectedDays([firstDay]);
                              setShowAllDays(false);
                              setSearchParams({ id: lineId, day: firstDay }, { replace: true });
                            }
                          }}
                          className="w-4 h-4 rounded border-2 border-amber-500"
                        />
                        <span className={`text-sm font-bold ${
                          theme === 'light' ? 'text-amber-700' : 'text-amber-400'
                        }`}>
                          Select All
                        </span>
                      </label>
                    )}
                    
                    {availableDays.map((availableDay) => (
                      <label
                        key={availableDay}
                        className={`flex items-center gap-2 px-3 py-2 rounded cursor-pointer transition-colors ${
                          theme === 'light'
                            ? 'hover:bg-blue-50'
                            : 'hover:bg-slate-700'
                        }`}
                      >
                        <input
                          type="checkbox"
                          checked={selectedDays.includes(availableDay)}
                          onChange={(e) => {
                            let newSelectedDays;
                            if (e.target.checked) {
                              newSelectedDays = [...selectedDays, availableDay];
                            } else {
                              newSelectedDays = selectedDays.filter(d => d !== availableDay);
                              if (newSelectedDays.length === 0) {
                                newSelectedDays = [availableDay]; // Keep at least one
                                return;
                              }
                            }
                            setSelectedDays(newSelectedDays);
                            setShowAllDays(newSelectedDays.length === availableDays.length);
                            setSearchParams({ id: lineId, day: newSelectedDays.join(',') }, { replace: true });
                          }}
                          className="w-4 h-4 rounded border-2 border-blue-500"
                        />
                        <span className={`text-sm font-medium ${
                          theme === 'light' ? 'text-slate-700' : 'text-slate-200'
                        }`}>
                          {availableDay}
                        </span>
                      </label>
                    ))}
                  </div>
                </PopoverContent>
              </Popover>

              {/* Date picker - THIRD */}
              <Popover open={calendarOpen} onOpenChange={setCalendarOpen}>
                <PopoverTrigger asChild>
                  <Button
                    variant="outline"
                    className={`h-10 px-4 text-sm font-semibold shadow-md transition-all hover:shadow-lg ${
                      theme === 'light'
                        ? 'bg-gradient-to-br from-purple-50 to-white border-2 border-purple-300 text-purple-900 hover:from-purple-100 hover:to-white hover:border-purple-400'
                        : 'bg-slate-800 border-slate-600'
                    }`}
                  >
                    <CalendarIcon className="h-4 w-4 mr-2" />
                    <span className="hidden sm:inline">{format(selectedDate, 'MMM dd, yyyy')}</span>
                  </Button>
                </PopoverTrigger>
                <PopoverContent className="w-auto p-0" align="end">
                  <CalendarComponent
                    mode="single"
                    selected={selectedDate}
                    onSelect={(date) => {
                      if (date) {
                        setSelectedDate(date);
                        setCalendarOpen(false);
                      }
                    }}
                    highlightedDates={datesWithTransactions}
                    initialFocus
                  />
                </PopoverContent>
              </Popover>
            </div>
          </div>

          {/* Mobile BF Badge */}
          <div className={`md:hidden inline-flex items-center gap-2 px-5 py-2 rounded-full mb-3 shadow-lg ${
            theme === 'light'
              ? 'bg-gradient-to-r from-emerald-50 via-white to-emerald-50 border-2 border-emerald-300'
              : 'bg-slate-800/50 border border-slate-700'
          }`}>
            <span className="text-base">ðŸ’¼</span>
            <span className={`text-xs font-semibold uppercase tracking-wider ${
              theme === 'light' ? 'text-emerald-700' : 'text-slate-400'
            }`}>
              BF
            </span>
            <span className={`text-lg font-bold ${
              theme === 'light'
                ? 'text-emerald-900'
                : 'text-blue-400'
            }`}>
              â‚¹{bfAmount.toFixed(2)}
            </span>
          </div>

          {/* Tab Navigation and Print Button Row - Centered with Print on Right */}
          <div className="relative flex justify-center items-center">
            <div className="relative">
              <div className={`inline-flex items-center rounded-full p-1 min-w-[480px] ${
                theme === 'light'
                  ? 'bg-slate-100 border border-slate-200'
                  : 'bg-slate-800 border border-slate-700'
              }`}>
                {/* Smooth Sliding Background */}
                <div 
                  className={`absolute top-1 bottom-1 rounded-full transition-all duration-200 ease-out ${
                    activeTab === 'going'
                      ? 'bg-red-500 shadow-lg'
                      : activeTab === 'incoming'
                        ? 'bg-blue-500 shadow-lg'
                        : 'bg-purple-500 shadow-lg'
                  }`}
                  style={{
                    left: activeTab === 'going' 
                      ? '4px' 
                      : activeTab === 'incoming' 
                        ? 'calc(33.333% + 2px)' 
                        : 'calc(66.666% + 0px)',
                    width: 'calc(33.333% - 6px)',
                    transform: 'translateZ(0)',
                    willChange: 'left'
                  }}
                />
                
                <button
                  onClick={() => setActiveTab('going')}
                  className={`relative flex-1 flex items-center justify-center gap-2 px-6 py-2 rounded-full text-sm font-semibold transition-colors duration-150 z-10 ${
                    activeTab === 'going'
                      ? 'text-white'
                      : theme === 'light'
                        ? 'text-slate-600 hover:text-slate-900'
                        : 'text-slate-400 hover:text-slate-200'
                  }`}
                >
                  <ArrowUpCircle className="h-4 w-4" />
                  <span>Going</span>
                </button>
                
                <button
                  onClick={() => setActiveTab('incoming')}
                  className={`relative flex-1 flex items-center justify-center gap-2 px-6 py-2 rounded-full text-sm font-semibold transition-colors duration-150 z-10 ${
                    activeTab === 'incoming'
                      ? 'text-white'
                      : theme === 'light'
                        ? 'text-slate-600 hover:text-slate-900'
                        : 'text-slate-400 hover:text-slate-200'
                  }`}
                >
                  <ArrowDownCircle className="h-4 w-4" />
                  <span>Incoming</span>
                </button>
                
                <button
                  onClick={() => setActiveTab('all')}
                  className={`relative flex-1 flex items-center justify-center gap-2 px-6 py-2 rounded-full text-sm font-semibold transition-colors duration-150 z-10 ${
                    activeTab === 'all'
                      ? 'text-white'
                      : theme === 'light'
                        ? 'text-slate-600 hover:text-slate-900'
                        : 'text-slate-400 hover:text-slate-200'
                  }`}
                >
                  <IndianRupee className="h-4 w-4" />
                  <span>All</span>
                </button>
              </div>
            </div>
            
            {/* Print Button - Absolute positioned to right */}
            <Button
              onClick={() => {
                setPrintSelectedDays(availableDays);
                setPrintSingleDate(selectedDate);
                setIsPrintModalOpen(true);
              }}
              variant="outline"
              className={`absolute right-0 h-10 px-4 text-sm font-semibold shadow-md transition-all hover:shadow-lg ${
                theme === 'light'
                  ? 'bg-gradient-to-br from-green-50 to-white border-2 border-green-300 text-green-900 hover:from-green-100 hover:to-white hover:border-green-400'
                  : 'bg-slate-800 border-slate-600 text-slate-200 hover:text-white'
              }`}
            >
              <Printer className="h-4 w-4 mr-2" />
              <span className="hidden sm:inline">Print</span>
            </Button>
          </div>
        </div>
      </header>

      {/* Content */}
      <div className="container mx-auto px-4 py-6">
        <div className="max-w-6xl mx-auto">
          {/* Going Tab Content */}
          {activeTab === 'going' && (
            <div>
              {/* Stats Cards */}
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 max-w-3xl">
                <div className={`rounded-xl p-5 shadow-lg border ${
                  theme === 'light'
                    ? 'bg-red-50 border-red-200'
                    : 'bg-slate-800/80 border-red-500/30'
                }`}>
                  <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center ${
                      theme === 'light'
                        ? 'bg-red-100 border-2 border-red-300'
                        : 'bg-red-500/20 border-2 border-red-500/30'
                    }`}>
                      <ArrowUpCircle className={`w-6 h-6 ${theme === 'light' ? 'text-red-600' : 'text-red-400'}`} />
                    </div>
                    <div>
                      <p className={`text-sm ${theme === 'light' ? 'text-slate-600' : 'text-slate-400'}`}>
                        Total Going Out
                      </p>
                      <p className={`text-2xl font-bold ${theme === 'light' ? 'text-red-600' : 'text-red-400'}`}>
                        â‚¹{filteredGoingTotal.toFixed(2)}
                      </p>
                    </div>
                  </div>
                </div>

                <div className={`rounded-xl p-5 shadow-lg border ${
                  theme === 'light'
                    ? 'bg-orange-50 border-orange-200'
                    : 'bg-slate-800/80 border-orange-500/30'
                }`}>
                  <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center ${
                      theme === 'light'
                        ? 'bg-orange-100 border-2 border-orange-300'
                        : 'bg-orange-500/20 border-2 border-orange-500/30'
                    }`}>
                      <IndianRupee className={`w-6 h-6 ${theme === 'light' ? 'text-orange-600' : 'text-orange-400'}`} />
                    </div>
                    <div>
                      <p className={`text-sm ${theme === 'light' ? 'text-slate-600' : 'text-slate-400'}`}>
                        Transactions
                      </p>
                      <p className={`text-2xl font-bold ${theme === 'light' ? 'text-slate-800' : 'text-slate-200'}`}>
                        {filteredGoingTransactions.length}
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Transaction List */}
              <div className={`rounded-xl shadow-xl border overflow-hidden ${
                theme === 'light'
                  ? 'bg-white border-slate-200'
                  : 'bg-slate-800/50 border-slate-700'
              }`}>
                <div className={`px-6 py-4 border-b ${
                  theme === 'light'
                    ? 'bg-red-50 border-red-200'
                    : 'bg-red-500/20 border-red-500/30'
                }`}>
                  <h2 className={`text-lg font-bold flex items-center ${
                    theme === 'light' ? 'text-red-700' : 'text-red-400'
                  }`}>
                    <TrendingUp className="w-5 h-5 mr-2" />
                    Going Transactions
                  </h2>
                </div>

                {filteredGoingTransactions.length === 0 ? (
                  <div className={`text-center py-12 ${theme === 'light' ? 'text-slate-500' : 'text-slate-500'}`}>
                    <ArrowUpCircle className="w-16 h-16 mx-auto mb-3 opacity-30" />
                    <p>No outgoing transactions on this date</p>
                  </div>
                ) : (
                  <div className={`divide-y ${theme === 'light' ? 'divide-slate-200' : 'divide-slate-700/50'}`}>
                    {filteredGoingTransactions.map((trans, index) => (
                      <div 
                        key={`going-${trans.customerId}-${trans.id}-${index}`}
                        className={`px-4 py-3 transition-colors ${
                          theme === 'light' ? 'hover:bg-slate-50' : 'hover:bg-slate-700/30'
                        }`}
                      >
                          <div className="flex items-center justify-between gap-3">
                            <div className="flex items-center gap-3 flex-1 min-w-0">
                              <div 
                                className="relative group/profile"
                                onMouseEnter={(e) => {
                                  const rect = e.currentTarget.getBoundingClientRect();
                                  const tooltip = e.currentTarget.querySelector('.tooltip-content');
                                  if (tooltip) {
                                    tooltip.style.left = `${rect.left + rect.width / 2}px`;
                                    tooltip.style.top = `${rect.top - 10}px`;
                                  }
                                }}
                              >
                                <div className={`w-9 h-9 rounded-full bg-red-500 flex items-center justify-center font-bold text-white text-xs border ${
                                  theme === 'light' ? 'border-red-400/50' : 'border-red-400/30'
                                }`}>
                                  {trans.customerName ? trans.customerName.substring(0, 2).toUpperCase() : trans.customerId.slice(-2)}
                                </div>
                                
                                {/* Hover Tooltip - Fixed Position */}
                                {trans.customerDetails && (
                                  <div className={`tooltip-content fixed -translate-x-1/2 -translate-y-full w-64 border p-4 rounded-xl shadow-2xl opacity-0 invisible group-hover/profile:opacity-100 group-hover/profile:visible transition-all duration-200 z-[9999] text-xs space-y-1.5 backdrop-blur-xl pointer-events-none ${theme === 'light' ? 'bg-white border-gray-200 text-gray-800' : 'bg-[#1a1f2e] border-slate-700 text-slate-200'}`}>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Name:</strong> {trans.customerDetails.name}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>ID:</strong> {trans.customerDetails.id}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Village:</strong> {trans.customerDetails.village || 'N/A'}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Phone:</strong> {trans.customerDetails.phone || 'N/A'}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Taken Amount:</strong> â‚¹{trans.customerDetails.takenAmount || 0}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Interest:</strong> {trans.customerDetails.interest || 'N/A'}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>PC:</strong> {trans.customerDetails.pc || 'N/A'}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Date:</strong> {trans.customerDetails.date || 'N/A'}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Weeks:</strong> {trans.customerDetails.weeks || 'N/A'}</p>
                                  </div>
                                )}
                              </div>
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2 flex-wrap">
                                <p className={`font-semibold text-sm truncate ${
                                  theme === 'light' ? 'text-slate-800' : 'text-slate-200'
                                }`}>
                                  {trans.customerName || 'Unknown Customer'}
                                </p>
                                {trans.day && (
                                  <span className={`text-[10px] font-semibold px-1.5 py-0.5 rounded ${
                                    theme === 'light' 
                                      ? 'bg-blue-100 text-blue-700 border border-blue-300' 
                                      : 'bg-blue-500/20 text-blue-400 border border-blue-500/30'
                                  }`}>
                                    {trans.day}
                                  </span>
                                )}
                                {trans.isDeleted && (
                                  <span className="text-red-500 text-lg leading-none" title="Customer Deleted">ðŸ”´</span>
                                )}
                              </div>
                              <div className="flex items-center gap-2 flex-wrap">
                                {trans.comment && (
                                  <span className={`px-1.5 py-0.5 rounded text-[10px] ${
                                    theme === 'light'
                                      ? 'bg-orange-100 border border-orange-300 text-orange-700'
                                      : 'bg-orange-500/20 border border-orange-500/30 text-orange-400'
                                  }`}>
                                    {trans.type === 'renewal' ? 'RENEWAL' : trans.type === 'customer_creation' ? 'NEW' : 'RESTORE'}
                                  </span>
                                )}
                                <p className={`text-xs ${theme === 'light' ? 'text-slate-500' : 'text-slate-400'}`}>
                                  ID: {trans.customerId}
                                </p>
                              </div>
                            </div>
                          </div>
                          
                          <div className="text-right flex-shrink-0">
                            <p className={`text-lg font-bold ${theme === 'light' ? 'text-red-600' : 'text-red-400'}`}>
                              -â‚¹{trans.amount.toFixed(2)}
                            </p>
                            <p className={`text-xs flex items-center justify-end ${
                              theme === 'light' ? 'text-slate-500' : 'text-slate-500'
                            }`}>
                              <Calendar className="w-3 h-3 mr-1" />
                              {trans.date}
                            </p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Incoming Tab Content */}
          {activeTab === 'incoming' && (
            <div>
              {/* Stats Cards */}
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 max-w-3xl">
                <div className={`rounded-xl p-5 shadow-lg border ${
                  theme === 'light'
                    ? 'bg-blue-50 border-blue-200'
                    : 'bg-slate-800/80 border-blue-500/30'
                }`}>
                  <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center ${
                      theme === 'light'
                        ? 'bg-blue-100 border-2 border-blue-300'
                        : 'bg-blue-500/20 border-2 border-blue-500/30'
                    }`}>
                      <ArrowDownCircle className={`w-6 h-6 ${theme === 'light' ? 'text-blue-600' : 'text-blue-400'}`} />
                    </div>
                    <div>
                      <p className={`text-sm ${theme === 'light' ? 'text-slate-600' : 'text-slate-400'}`}>
                        Total Collected
                      </p>
                      <p className={`text-2xl font-bold ${theme === 'light' ? 'text-blue-600' : 'text-blue-400'}`}>
                        â‚¹{filteredTotal.toFixed(2)}
                      </p>
                    </div>
                  </div>
                </div>

                <div className={`rounded-xl p-5 shadow-lg border ${
                  theme === 'light'
                    ? 'bg-indigo-50 border-indigo-200'
                    : 'bg-slate-800/80 border-indigo-500/30'
                }`}>
                  <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center ${
                      theme === 'light'
                        ? 'bg-indigo-100 border-2 border-indigo-300'
                        : 'bg-indigo-500/20 border-2 border-indigo-500/30'
                    }`}>
                      <IndianRupee className={`w-6 h-6 ${theme === 'light' ? 'text-indigo-600' : 'text-indigo-400'}`} />
                    </div>
                    <div>
                      <p className={`text-sm ${theme === 'light' ? 'text-slate-600' : 'text-slate-400'}`}>
                        Transactions
                      </p>
                      <p className={`text-2xl font-bold ${theme === 'light' ? 'text-slate-800' : 'text-slate-200'}`}>
                        {filteredTransactions.length}
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Transaction List */}
              <div className={`rounded-xl shadow-xl border overflow-hidden ${
                theme === 'light'
                  ? 'bg-white border-slate-200'
                  : 'bg-slate-800/50 border-slate-700'
              }`}>
                <div className={`px-6 py-4 border-b ${
                  theme === 'light'
                    ? 'bg-blue-50 border-blue-200'
                    : 'bg-blue-500/20 border-blue-500/30'
                }`}>
                  <h2 className={`text-lg font-bold flex items-center ${
                    theme === 'light' ? 'text-blue-700' : 'text-blue-400'
                  }`}>
                    <TrendingDown className="w-5 h-5 mr-2" />
                    Incoming Transactions
                  </h2>
                </div>

                {filteredTransactions.length === 0 ? (
                  <div className={`text-center py-12 ${theme === 'light' ? 'text-slate-500' : 'text-slate-500'}`}>
                    <ArrowDownCircle className="w-16 h-16 mx-auto mb-3 opacity-30" />
                    <p>No collections on this date</p>
                  </div>
                ) : (
                  <div className={`divide-y ${theme === 'light' ? 'divide-slate-200' : 'divide-slate-700/50'}`}>
                    {filteredTransactions.map((trans, index) => (
                      <div 
                        key={`incoming-${trans.customerId}-${trans.id}-${index}`}
                        className={`px-4 py-3 transition-colors ${
                          theme === 'light' ? 'hover:bg-slate-50' : 'hover:bg-slate-700/30'
                        }`}
                      >
                        <div className="flex items-center justify-between gap-3">
                          <div className="flex items-center gap-3 flex-1 min-w-0">
                            <div 
                              className="relative group/profile"
                              onMouseEnter={(e) => {
                                const rect = e.currentTarget.getBoundingClientRect();
                                const tooltip = e.currentTarget.querySelector('.tooltip-content');
                                if (tooltip) {
                                  tooltip.style.left = `${rect.left + rect.width / 2}px`;
                                  tooltip.style.top = `${rect.top - 10}px`;
                                }
                              }}
                            >
                              <div className={`w-9 h-9 rounded-full bg-blue-500 flex items-center justify-center font-bold text-white text-xs border ${
                                theme === 'light' ? 'border-blue-400/50' : 'border-blue-400/30'
                              }`}>
                                {trans.customerName ? trans.customerName.substring(0, 2).toUpperCase() : trans.customerId.slice(-2)}
                              </div>
                              
                              {/* Hover Tooltip - Fixed Position */}
                              {trans.customerDetails && (
                                <div className={`tooltip-content fixed -translate-x-1/2 -translate-y-full w-64 border p-4 rounded-xl shadow-2xl opacity-0 invisible group-hover/profile:opacity-100 group-hover/profile:visible transition-all duration-200 z-[9999] text-xs space-y-1.5 backdrop-blur-xl pointer-events-none ${theme === 'light' ? 'bg-white border-gray-200 text-gray-800' : 'bg-[#1a1f2e] border-slate-700 text-slate-200'}`}>
                                  <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Name:</strong> {trans.customerDetails.name}</p>
                                  <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>ID:</strong> {trans.customerDetails.id}</p>
                                  <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Village:</strong> {trans.customerDetails.village || 'N/A'}</p>
                                  <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Phone:</strong> {trans.customerDetails.phone || 'N/A'}</p>
                                  <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Taken Amount:</strong> â‚¹{trans.customerDetails.takenAmount || 0}</p>
                                  <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Interest:</strong> {trans.customerDetails.interest || 'N/A'}</p>
                                  <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>PC:</strong> {trans.customerDetails.pc || 'N/A'}</p>
                                  <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Date:</strong> {trans.customerDetails.date || 'N/A'}</p>
                                  <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Weeks:</strong> {trans.customerDetails.weeks || 'N/A'}</p>
                                </div>
                              )}
                            </div>
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2 flex-wrap">
                                <p className={`font-semibold text-sm truncate ${
                                  theme === 'light' ? 'text-slate-800' : 'text-slate-200'
                                }`}>
                                  {trans.customerName || 'Unknown Customer'}
                                </p>
                                {trans.day && (
                                  <span className={`text-[10px] font-semibold px-1.5 py-0.5 rounded ${
                                    theme === 'light' 
                                      ? 'bg-blue-100 text-blue-700 border border-blue-300' 
                                      : 'bg-blue-500/20 text-blue-400 border border-blue-500/30'
                                  }`}>
                                    {trans.day}
                                  </span>
                                )}
                                {trans.isDeleted && (
                                  <span className="text-red-500 text-lg leading-none" title="Customer Deleted">ðŸ”´</span>
                                )}
                              </div>
                              <div className="flex items-center gap-2 flex-wrap">
                                {trans.comment && (
                                  <p className={`text-xs italic truncate ${
                                    theme === 'light' ? 'text-indigo-600' : 'text-indigo-400'
                                  }`}>
                                    {trans.comment}
                                  </p>
                                )}
                                <p className={`text-xs ${theme === 'light' ? 'text-slate-500' : 'text-slate-400'}`}>
                                  ID: {trans.customerId}
                                </p>
                              </div>
                            </div>
                          </div>
                          
                          <div className="text-right flex-shrink-0">
                            <p className={`text-lg font-bold ${theme === 'light' ? 'text-blue-600' : 'text-blue-400'}`}>
                              +â‚¹{trans.amount || 0}
                            </p>
                            <p className={`text-xs flex items-center justify-end ${
                              theme === 'light' ? 'text-slate-500' : 'text-slate-500'
                            }`}>
                              <Calendar className="w-3 h-3 mr-1" />
                              {trans.date}
                            </p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          )}

          {/* All Tab Content */}
          {activeTab === 'all' && (
            <div>
              {/* Stats Cards */}
              <div className="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">
                <div className={`rounded-xl p-5 shadow-lg border ${
                  theme === 'light'
                    ? 'bg-blue-50 border-blue-200'
                    : 'bg-slate-800/80 border-blue-500/30'
                }`}>
                  <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center ${
                      theme === 'light'
                        ? 'bg-blue-100 border-2 border-blue-300'
                        : 'bg-blue-500/20 border-2 border-blue-500/30'
                    }`}>
                      <IndianRupee className={`w-6 h-6 ${theme === 'light' ? 'text-blue-600' : 'text-blue-400'}`} />
                    </div>
                    <div>
                      <p className={`text-sm ${theme === 'light' ? 'text-slate-600' : 'text-slate-400'}`}>
                        Net Flow
                      </p>
                      <p className={`text-2xl font-bold ${
                        (filteredTotal - filteredGoingTotal) >= 0 
                          ? (theme === 'light' ? 'text-blue-600' : 'text-blue-400')
                          : (theme === 'light' ? 'text-red-600' : 'text-red-400')
                      }`}>
                        â‚¹{(filteredTotal - filteredGoingTotal).toFixed(2)}
                      </p>
                    </div>
                  </div>
                </div>

                <div className={`rounded-xl p-5 shadow-lg border ${
                  theme === 'light'
                    ? 'bg-blue-50 border-blue-200'
                    : 'bg-slate-800/80 border-blue-500/30'
                }`}>
                  <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center ${
                      theme === 'light'
                        ? 'bg-blue-100 border-2 border-blue-300'
                        : 'bg-blue-500/20 border-2 border-blue-500/30'
                    }`}>
                      <ArrowDownCircle className={`w-6 h-6 ${theme === 'light' ? 'text-blue-600' : 'text-blue-400'}`} />
                    </div>
                    <div>
                      <p className={`text-sm ${theme === 'light' ? 'text-slate-600' : 'text-slate-400'}`}>
                        Incoming
                      </p>
                      <p className={`text-2xl font-bold ${theme === 'light' ? 'text-blue-600' : 'text-blue-400'}`}>
                        â‚¹{filteredTotal.toFixed(2)}
                      </p>
                    </div>
                  </div>
                </div>

                <div className={`rounded-xl p-5 shadow-lg border ${
                  theme === 'light'
                    ? 'bg-red-50 border-red-200'
                    : 'bg-slate-800/80 border-red-500/30'
                }`}>
                  <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center ${
                      theme === 'light'
                        ? 'bg-red-100 border-2 border-red-300'
                        : 'bg-red-500/20 border-2 border-red-500/30'
                    }`}>
                      <ArrowUpCircle className={`w-6 h-6 ${theme === 'light' ? 'text-red-600' : 'text-red-400'}`} />
                    </div>
                    <div>
                      <p className={`text-sm ${theme === 'light' ? 'text-slate-600' : 'text-slate-400'}`}>
                        Going
                      </p>
                      <p className={`text-2xl font-bold ${theme === 'light' ? 'text-red-600' : 'text-red-400'}`}>
                        â‚¹{filteredGoingTotal.toFixed(2)}
                      </p>
                    </div>
                  </div>
                </div>

                <div className={`rounded-xl p-5 shadow-lg border ${
                  theme === 'light'
                    ? 'bg-indigo-50 border-indigo-200'
                    : 'bg-slate-800/80 border-indigo-500/30'
                }`}>
                  <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center ${
                      theme === 'light'
                        ? 'bg-indigo-100 border-2 border-indigo-300'
                        : 'bg-indigo-500/20 border-2 border-indigo-500/30'
                    }`}>
                      <IndianRupee className={`w-6 h-6 ${theme === 'light' ? 'text-indigo-600' : 'text-indigo-400'}`} />
                    </div>
                    <div>
                      <p className={`text-sm ${theme === 'light' ? 'text-slate-600' : 'text-slate-400'}`}>
                        Total Trans
                      </p>
                      <p className={`text-2xl font-bold ${theme === 'light' ? 'text-slate-800' : 'text-slate-200'}`}>
                        {filteredTransactions.length + filteredGoingTransactions.length}
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Combined Lists */}
              <div className="space-y-6">
                {/* Going Transactions */}
                {filteredGoingTransactions.length > 0 && (
                  <div className={`rounded-xl shadow-xl border overflow-hidden ${
                    theme === 'light'
                      ? 'bg-white border-slate-200'
                      : 'bg-slate-800/50 border-slate-700'
                  }`}>
                    <div className={`px-6 py-4 border-b ${
                      theme === 'light'
                        ? 'bg-red-50 border-red-200'
                        : 'bg-red-500/20 border-red-500/30'
                    }`}>
                      <h2 className={`text-lg font-bold flex items-center ${
                        theme === 'light' ? 'text-red-700' : 'text-red-400'
                      }`}>
                        <TrendingUp className="w-5 h-5 mr-2" />
                        Going Transactions
                      </h2>
                    </div>
                    <div className={`divide-y ${theme === 'light' ? 'divide-slate-200' : 'divide-slate-700/50'}`}>
                      {filteredGoingTransactions.map((trans, index) => (
                        <div 
                          key={`all-going-${trans.customerId}-${trans.id}-${index}`}
                          className={`px-4 py-3 transition-colors ${
                            theme === 'light' ? 'hover:bg-slate-50' : 'hover:bg-slate-700/30'
                          }`}
                        >
                          <div className="flex items-center justify-between gap-3">
                            <div className="flex items-center gap-3 flex-1 min-w-0">
                              <div 
                                className="relative group/profile"
                                onMouseEnter={(e) => {
                                  const rect = e.currentTarget.getBoundingClientRect();
                                  const tooltip = e.currentTarget.querySelector('.tooltip-content');
                                  if (tooltip) {
                                    tooltip.style.left = `${rect.left + rect.width / 2}px`;
                                    tooltip.style.top = `${rect.top - 10}px`;
                                  }
                                }}
                              >
                                <div className={`w-9 h-9 rounded-full bg-red-500 flex items-center justify-center font-bold text-white text-xs border ${
                                  theme === 'light' ? 'border-red-400/50' : 'border-red-400/30'
                                }`}>
                                  {trans.customerName ? trans.customerName.substring(0, 2).toUpperCase() : trans.customerId.slice(-2)}
                                </div>
                                
                                {/* Hover Tooltip - Fixed Position */}
                                {trans.customerDetails && (
                                  <div className={`tooltip-content fixed -translate-x-1/2 -translate-y-full w-64 border p-4 rounded-xl shadow-2xl opacity-0 invisible group-hover/profile:opacity-100 group-hover/profile:visible transition-all duration-200 z-[9999] text-xs space-y-1.5 backdrop-blur-xl pointer-events-none ${theme === 'light' ? 'bg-white border-gray-200 text-gray-800' : 'bg-[#1a1f2e] border-slate-700 text-slate-200'}`}>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Name:</strong> {trans.customerDetails.name}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>ID:</strong> {trans.customerDetails.id}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Village:</strong> {trans.customerDetails.village || 'N/A'}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Phone:</strong> {trans.customerDetails.phone || 'N/A'}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Taken Amount:</strong> â‚¹{trans.customerDetails.takenAmount || 0}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Interest:</strong> {trans.customerDetails.interest || 'N/A'}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>PC:</strong> {trans.customerDetails.pc || 'N/A'}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Date:</strong> {trans.customerDetails.date || 'N/A'}</p>
                                    <p><strong className={theme === 'light' ? 'text-red-600' : 'text-cyan-400'}>Weeks:</strong> {trans.customerDetails.weeks || 'N/A'}</p>
                                  </div>
                                )}
                              </div>
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 flex-wrap">
                                  <p className={`font-semibold text-sm truncate ${
                                    theme === 'light' ? 'text-slate-800' : 'text-slate-200'
                                  }`}>
                                    {trans.customerName || 'Unknown Customer'}
                                  </p>
                                  {trans.day && (
                                    <span className={`text-[10px] font-semibold px-1.5 py-0.5 rounded ${
                                      theme === 'light' 
                                        ? 'bg-blue-100 text-blue-700 border border-blue-300' 
                                        : 'bg-blue-500/20 text-blue-400 border border-blue-500/30'
                                    }`}>
                                      {trans.day}
                                    </span>
                                  )}
                                  {trans.isDeleted && (
                                    <span className="text-red-500 text-lg leading-none" title="Customer Deleted">ðŸ”´</span>
                                  )}
                                </div>
                                <div className="flex items-center gap-2 flex-wrap">
                                  {trans.comment && (
                                    <span className={`px-1.5 py-0.5 rounded text-[10px] ${
                                      theme === 'light'
                                        ? 'bg-orange-100 border border-orange-300 text-orange-700'
                                        : 'bg-orange-500/20 border border-orange-500/30 text-orange-400'
                                    }`}>
                                      {trans.type === 'renewal' ? 'RENEWAL' : trans.type === 'customer_creation' ? 'NEW' : 'RESTORE'}
                                    </span>
                                  )}
                                  <p className={`text-xs ${theme === 'light' ? 'text-slate-500' : 'text-slate-400'}`}>
                                    ID: {trans.customerId}
                                  </p>
                                </div>
                              </div>
                            </div>
                            
                            <div className="text-right flex-shrink-0">
                              <p className={`text-lg font-bold ${theme === 'light' ? 'text-red-600' : 'text-red-400'}`}>
                                -â‚¹{trans.amount.toFixed(2)}
                              </p>
                              <p className={`text-xs flex items-center justify-end ${
                                theme === 'light' ? 'text-slate-500' : 'text-slate-500'
                              }`}>
                                <Calendar className="w-3 h-3 mr-1" />
                                {trans.date}
                              </p>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Incoming Transactions */}
                {filteredTransactions.length > 0 && (
                  <div className={`rounded-xl shadow-xl border overflow-hidden ${
                    theme === 'light'
                      ? 'bg-white border-slate-200'
                      : 'bg-slate-800/50 border-slate-700'
                  }`}>
                    <div className={`px-6 py-4 border-b ${
                      theme === 'light'
                        ? 'bg-blue-50 border-blue-200'
                        : 'bg-blue-500/20 border-blue-500/30'
                    }`}>
                      <h2 className={`text-lg font-bold flex items-center ${
                        theme === 'light' ? 'text-blue-700' : 'text-blue-400'
                      }`}>
                        <TrendingDown className="w-5 h-5 mr-2" />
                        Incoming Transactions
                      </h2>
                    </div>
                    <div className={`divide-y ${theme === 'light' ? 'divide-slate-200' : 'divide-slate-700/50'}`}>
                      {filteredTransactions.map((trans, index) => (
                        <div 
                          key={`all-incoming-${trans.customerId}-${trans.id}-${index}`}
                          className={`px-4 py-3 transition-colors ${
                            theme === 'light' ? 'hover:bg-slate-50' : 'hover:bg-slate-700/30'
                          }`}
                        >
                          <div className="flex items-center justify-between gap-3">
                            <div className="flex items-center gap-3 flex-1 min-w-0">
                              <div 
                                className="relative group/profile"
                                onMouseEnter={(e) => {
                                  const rect = e.currentTarget.getBoundingClientRect();
                                  const tooltip = e.currentTarget.querySelector('.tooltip-content');
                                  if (tooltip) {
                                    tooltip.style.left = `${rect.left + rect.width / 2}px`;
                                    tooltip.style.top = `${rect.top - 10}px`;
                                  }
                                }}
                              >
                                <div className={`w-9 h-9 rounded-full bg-blue-500 flex items-center justify-center font-bold text-white text-xs border ${
                                  theme === 'light' ? 'border-blue-400/50' : 'border-blue-400/30'
                                }`}>
                                  {trans.customerName ? trans.customerName.substring(0, 2).toUpperCase() : trans.customerId.slice(-2)}
                                </div>
                                
                                {/* Hover Tooltip - Fixed Position */}
                                {trans.customerDetails && (
                                  <div className={`tooltip-content fixed -translate-x-1/2 -translate-y-full w-64 border p-4 rounded-xl shadow-2xl opacity-0 invisible group-hover/profile:opacity-100 group-hover/profile:visible transition-all duration-200 z-[9999] text-xs space-y-1.5 backdrop-blur-xl pointer-events-none ${theme === 'light' ? 'bg-white border-gray-200 text-gray-800' : 'bg-[#1a1f2e] border-slate-700 text-slate-200'}`}>
                                    <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Name:</strong> {trans.customerDetails.name}</p>
                                    <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>ID:</strong> {trans.customerDetails.id}</p>
                                    <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Village:</strong> {trans.customerDetails.village || 'N/A'}</p>
                                    <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Phone:</strong> {trans.customerDetails.phone || 'N/A'}</p>
                                    <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Taken Amount:</strong> â‚¹{trans.customerDetails.takenAmount || 0}</p>
                                    <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Interest:</strong> {trans.customerDetails.interest || 'N/A'}</p>
                                    <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>PC:</strong> {trans.customerDetails.pc || 'N/A'}</p>
                                    <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Date:</strong> {trans.customerDetails.date || 'N/A'}</p>
                                    <p><strong className={theme === 'light' ? 'text-blue-600' : 'text-cyan-400'}>Weeks:</strong> {trans.customerDetails.weeks || 'N/A'}</p>
                                  </div>
                                )}
                              </div>
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 flex-wrap">
                                  <p className={`font-semibold text-sm truncate ${
                                    theme === 'light' ? 'text-slate-800' : 'text-slate-200'
                                  }`}>
                                    {trans.customerName || 'Unknown Customer'}
                                  </p>
                                  {trans.day && (
                                    <span className={`text-[10px] font-semibold px-1.5 py-0.5 rounded ${
                                      theme === 'light' 
                                        ? 'bg-blue-100 text-blue-700 border border-blue-300' 
                                        : 'bg-blue-500/20 text-blue-400 border border-blue-500/30'
                                    }`}>
                                      {trans.day}
                                    </span>
                                  )}
                                  {trans.isDeleted && (
                                    <span className="text-red-500 text-lg leading-none" title="Customer Deleted">ðŸ”´</span>
                                  )}
                                </div>
                                <div className="flex items-center gap-2 flex-wrap">
                                  {trans.comment && (
                                    <p className={`text-xs italic truncate ${
                                      theme === 'light' ? 'text-indigo-600' : 'text-indigo-400'
                                    }`}>
                                      {trans.comment}
                                    </p>
                                  )}
                                  <p className={`text-xs ${theme === 'light' ? 'text-slate-500' : 'text-slate-400'}`}>
                                    ID: {trans.customerId}
                                  </p>
                                </div>
                              </div>
                            </div>
                            
                            <div className="text-right flex-shrink-0">
                              <p className={`text-lg font-bold ${theme === 'light' ? 'text-blue-600' : 'text-blue-400'}`}>
                                +â‚¹{trans.amount || 0}
                              </p>
                              <p className={`text-xs flex items-center justify-end ${
                                theme === 'light' ? 'text-slate-500' : 'text-slate-500'
                              }`}>
                                <Calendar className="w-3 h-3 mr-1" />
                                {trans.date}
                              </p>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* No Transactions */}
                {filteredTransactions.length === 0 && filteredGoingTransactions.length === 0 && (
                  <div className={`rounded-xl shadow-xl border overflow-hidden ${
                    theme === 'light'
                      ? 'bg-white border-slate-200'
                      : 'bg-slate-800/50 border-slate-700'
                  }`}>
                    <div className={`text-center py-12 ${theme === 'light' ? 'text-slate-500' : 'text-slate-500'}`}>
                      <IndianRupee className="w-16 h-16 mx-auto mb-3 opacity-30" />
                      <p>No transactions on this date</p>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      </div>
      
      {/* Print Date Range Modal */}
      <Dialog open={isPrintModalOpen} onOpenChange={setIsPrintModalOpen}>
        <DialogContent className={`${
          theme === 'light' 
            ? 'bg-white border-gray-200' 
            : 'bg-slate-800 border-slate-700'
        }`}>
          <DialogHeader>
            <DialogTitle className={theme === 'light' ? 'text-slate-900' : 'text-white'}>
              Print Collections Statement
            </DialogTitle>
          </DialogHeader>
          
          <div className="space-y-4 mt-4">
            {/* Date Mode Selection */}
            <div className="space-y-2">
              <Label className={theme === 'light' ? 'text-slate-700' : 'text-slate-300'}>
                Date Selection
              </Label>
              <div className="flex gap-4">
                <label className={`flex items-center gap-2 cursor-pointer ${
                  theme === 'light' ? 'text-slate-700' : 'text-slate-300'
                }`}>
                  <input
                    type="radio"
                    name="printDateMode"
                    value="single"
                    checked={printDateMode === 'single'}
                    onChange={(e) => setPrintDateMode(e.target.value)}
                    className="w-4 h-4"
                  />
                  <span className="font-medium">Single Date</span>
                </label>
                <label className={`flex items-center gap-2 cursor-pointer ${
                  theme === 'light' ? 'text-slate-700' : 'text-slate-300'
                }`}>
                  <input
                    type="radio"
                    name="printDateMode"
                    value="range"
                    checked={printDateMode === 'range'}
                    onChange={(e) => setPrintDateMode(e.target.value)}
                    className="w-4 h-4"
                  />
                  <span className="font-medium">Date Range</span>
                </label>
              </div>
            </div>

            {/* Days Selector */}
            <div className="space-y-2">
              <Label className={theme === 'light' ? 'text-slate-700' : 'text-slate-300'}>
                Select Days
              </Label>
              <Popover>
                <PopoverTrigger asChild>
                  <Button
                    variant="outline"
                    className={`w-full justify-start text-left font-normal ${
                      theme === 'light'
                        ? 'bg-white border-gray-300 hover:bg-gray-50'
                        : 'bg-slate-700 border-slate-600 hover:bg-slate-600'
                    }`}
                  >
                    <ChevronDown className="mr-2 h-4 w-4" />
                    <span className="truncate">
                      {printSelectedDays.length === 0 
                        ? 'Select Days' 
                        : printSelectedDays.length === 1 
                          ? printSelectedDays[0] 
                          : printSelectedDays.length === availableDays.length
                            ? 'All Days'
                            : `${printSelectedDays.length} Days`}
                    </span>
                  </Button>
                </PopoverTrigger>
                <PopoverContent className={`w-56 p-2 ${
                  theme === 'light' ? 'bg-white' : 'bg-slate-800'
                }`} align="start">
                  <div className="space-y-1">
                    {/* Select All Option */}
                    {availableDays.length > 0 && (
                      <label
                        className={`flex items-center gap-2 px-3 py-2 rounded cursor-pointer transition-colors border-b ${
                          theme === 'light'
                            ? 'hover:bg-amber-50 border-slate-200'
                            : 'hover:bg-slate-700 border-slate-700'
                        }`}
                      >
                        <input
                          type="checkbox"
                          checked={printSelectedDays.length === availableDays.length}
                          onChange={(e) => {
                            if (e.target.checked) {
                              setPrintSelectedDays(availableDays);
                            } else {
                              setPrintSelectedDays(availableDays.length > 0 ? [availableDays[0]] : []);
                            }
                          }}
                          className="w-4 h-4 rounded border-2 border-amber-500"
                        />
                        <span className={`text-sm font-bold ${
                          theme === 'light' ? 'text-amber-700' : 'text-amber-400'
                        }`}>
                          Select All
                        </span>
                      </label>
                    )}
                    
                    {availableDays.map((availableDay) => (
                      <label
                        key={availableDay}
                        className={`flex items-center gap-2 px-3 py-2 rounded cursor-pointer transition-colors ${
                          theme === 'light'
                            ? 'hover:bg-blue-50'
                            : 'hover:bg-slate-700'
                        }`}
                      >
                        <input
                          type="checkbox"
                          checked={printSelectedDays.includes(availableDay)}
                          onChange={(e) => {
                            let newSelectedDays;
                            if (e.target.checked) {
                              newSelectedDays = [...printSelectedDays, availableDay];
                            } else {
                              newSelectedDays = printSelectedDays.filter(d => d !== availableDay);
                              if (newSelectedDays.length === 0) {
                                newSelectedDays = [availableDay];
                                return;
                              }
                            }
                            setPrintSelectedDays(newSelectedDays);
                          }}
                          className="w-4 h-4 rounded border-2 border-blue-500"
                        />
                        <span className={`text-sm font-medium ${
                          theme === 'light' ? 'text-slate-700' : 'text-slate-200'
                        }`}>
                          {availableDay}
                        </span>
                      </label>
                    ))}
                  </div>
                </PopoverContent>
              </Popover>
            </div>

            {/* Single Date Selector */}
            {printDateMode === 'single' && (
              <div className="space-y-2">
                <Label className={theme === 'light' ? 'text-slate-700' : 'text-slate-300'}>
                  Select Date
                </Label>
                <Popover open={isSingleDateOpen} onOpenChange={setIsSingleDateOpen}>
                  <PopoverTrigger asChild>
                    <Button
                      variant="outline"
                      className={`w-full justify-start text-left font-normal ${
                        theme === 'light'
                          ? 'bg-white border-gray-300 hover:bg-gray-50'
                          : 'bg-slate-700 border-slate-600 hover:bg-slate-600'
                      }`}
                    >
                      <CalendarIcon className="mr-2 h-4 w-4" />
                      {format(printSingleDate, 'PPP')}
                    </Button>
                  </PopoverTrigger>
                  <PopoverContent className="w-auto p-0" align="start">
                    <CalendarComponent
                      mode="single"
                      selected={printSingleDate}
                      onSelect={(date) => {
                        if (date) {
                          setPrintSingleDate(date);
                          setIsSingleDateOpen(false);
                        }
                      }}
                      initialFocus
                    />
                  </PopoverContent>
                </Popover>
              </div>
            )}

            {/* Date Range Selector */}
            {printDateMode === 'range' && (
              <>
            
            <div className="space-y-2">
              <Label className={theme === 'light' ? 'text-slate-700' : 'text-slate-300'}>
                From Date
              </Label>
              <Popover open={isFromDateOpen} onOpenChange={setIsFromDateOpen}>
                <PopoverTrigger asChild>
                  <Button
                    variant="outline"
                    className={`w-full justify-start text-left font-normal ${
                      theme === 'light'
                        ? 'bg-white border-gray-300 hover:bg-gray-50'
                        : 'bg-slate-700 border-slate-600 hover:bg-slate-600'
                    }`}
                  >
                    <CalendarIcon className="mr-2 h-4 w-4" />
                    {format(printFromDate, 'PPP')}
                  </Button>
                </PopoverTrigger>
                <PopoverContent className="w-auto p-0" align="start">
                  <CalendarComponent
                    mode="single"
                    selected={printFromDate}
                    onSelect={(date) => {
                      if (date) {
                        setPrintFromDate(date);
                        setIsFromDateOpen(false);
                      }
                    }}
                    initialFocus
                  />
                </PopoverContent>
              </Popover>
            </div>
            
            <div className="space-y-2">
              <Label className={theme === 'light' ? 'text-slate-700' : 'text-slate-300'}>
                To Date
              </Label>
              <Popover open={isToDateOpen} onOpenChange={setIsToDateOpen}>
                <PopoverTrigger asChild>
                  <Button
                    variant="outline"
                    className={`w-full justify-start text-left font-normal ${
                      theme === 'light'
                        ? 'bg-white border-gray-300 hover:bg-gray-50'
                        : 'bg-slate-700 border-slate-600 hover:bg-slate-600'
                    }`}
                  >
                    <CalendarIcon className="mr-2 h-4 w-4" />
                    {format(printToDate, 'PPP')}
                  </Button>
                </PopoverTrigger>
                <PopoverContent className="w-auto p-0" align="start">
                  <CalendarComponent
                    mode="single"
                    selected={printToDate}
                    onSelect={(date) => {
                      if (date) {
                        setPrintToDate(date);
                        setIsToDateOpen(false);
                      }
                    }}
                    initialFocus
                  />
                </PopoverContent>
              </Popover>
            </div>
            </>
            )}
            
            <div className="flex gap-2 pt-4">
              <Button
                variant="outline"
                onClick={() => setIsPrintModalOpen(false)}
                className={`flex-1 ${
                  theme === 'light'
                    ? 'border-gray-300 hover:bg-gray-50'
                    : 'border-slate-600 hover:bg-slate-700'
                }`}
              >
                Cancel
              </Button>
              <Button
                onClick={handlePrint}
                className={`flex-1 ${
                  theme === 'light'
                    ? 'bg-green-600 hover:bg-green-700'
                    : 'bg-green-600 hover:bg-green-700'
                }`}
              >
                <Printer className="w-4 h-4 mr-2" />
                Generate PDF
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
};

export default Collections;
